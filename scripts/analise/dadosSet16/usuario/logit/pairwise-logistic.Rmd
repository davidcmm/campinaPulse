---
title: "Pairwise comparison - logit"
#date: `r date()`
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
require(gmodels)
require(vcd)
require(lme4)
library(caret)
library(pscl)
library(DT)
library(ggplot2)
theme_set(theme_bw())
library(GGally)
library(dplyr, warn.conflicts = F)
library(broom)

library(car)
library(readr)
```

```{r lib}
compare_glms <- function(baseline, model){
  modelChi <- baseline$deviance - model$deviance
  chidf <- baseline$df.residual - model$df.residual
  chisq.prob <- 1 - pchisq(modelChi, chidf)
  print(paste(modelChi, chidf, chisq.prob))
}

compare_null <- function(baselineModel){
  modelChi <- baselineModel$null.deviance - baselineModel$deviance
  chidf <- baselineModel$df.null - baselineModel$df.residual
  chisq.prob <- 1 - pchisq(modelChi, chidf)
  print(paste(modelChi, chidf, chisq.prob))
}
```


```{r read}
# TIVE QUE ADICIONAR O NOME DA 1a COLUNA NO ARQUIVO
raw_data = read_delim(
  "classifier//classifier_input_wodraw.dat",
  delim = "\t",
  col_types = cols(
    .default = col_double(),
    row = col_integer(),
    choice = col_character(),
    question = col_character(),
    photo1 = col_character(),
    photo2 = col_character(),
    choice = col_integer(),
    userID = col_integer(),
    gender = col_character(),
    age = col_character(),
    income = col_character(),
    education = col_character(),
    city = col_character(),
    marital = col_character(),
    graffiti1 = col_character(),
    bairro1 = col_character(),
    graffiti2 = col_character(),
    bairro2 = col_character()
    )
  )

```

```{r transform}
data = raw_data %>% 
  mutate( # Recode
    income = if_else(is.na(income), "media", income),
    age_cat = if_else(as.integer(age) >= 25 | is.na(age), "adulto", "jovem"),
    inc_cat = if_else(income %in% c("baixa", "media baixa"),
                         "baixa", 
                         "media"), # substituirÃ¡ os NA
    choice = if_else(choice == "1", "0", 
                     if_else(choice == "-1", "1", choice)), 
    bair_cat = if_else(bairro1 == bairro2, "mesmo", 
                       paste0(bairro1, "_", bairro2))    
    ) %>% 
  mutate_at( # to factor
    vars(income, age_cat, inc_cat, choice, bair_cat, marital, gender),
    as.factor) %>% 
  mutate( # relevel
    bair_cat = relevel(bair_cat,  "mesmo"),
    marital = relevel(marital,  "solteiro"),
    income = relevel(income,  "baixa"),
    age_cat = relevel(age_cat,  "jovem"),
    gender = relevel(gender,  "feminino"),
    inc_cat = relevel(inc_cat,  "baixa")
  ) 

# Create diff features
data = data %>%
  mutate(
    d_swidth = street_wid1 - street_wid2,
    d_mvcars = mov_cars1 - mov_cars2,
    d_pcars = park_cars1 - park_cars2,
    d_trees = trees1 - trees2,
    d_mvciclyst = mov_ciclyst1 - mov_ciclyst2,
    d_lands = landscape1 - landscape2,
    d_bid = build_ident1 - build_ident2,
    d_bheig = log2(build_height1 + 1) - log2(build_height2 + 1),
    d_dbuild = diff_build1 - diff_build2,
    d_people = people1 - people2,
    d_graff = (graffiti1 == "Yes") - (graffiti2 == "Yes")
  )

# SPLIT + SCALE
agrad <- filter(data, !(question %in% c("seguro?", "seguro"))) %>% 
  mutate_at(vars(40:50), scale)
seg <- filter(data, (question %in% c("seguro?", "seguro")))  %>% 
  mutate_at(vars(40:50), scale)
```

```{r visualize}
 # featurePlot(x=data[, 40:45], y=data[,5], plot="box", scales=list(x=list(relation="free"), y=list(relation="free")), auto.key=list(columns=2))
```

```{r model.lib}
create_model_w_interact = function(the_data){
  return(glm(
    choice ~ d_swidth + d_mvcars + d_pcars + d_trees + d_mvciclyst + d_lands + d_bid + d_bheig + d_dbuild + d_people + d_graff + bair_cat + 
      age_cat:(d_swidth + d_mvcars + d_pcars + d_trees + d_mvciclyst + d_lands + d_bid + d_bheig + d_dbuild + d_people + d_graff) + 
      gender:(d_swidth + d_mvcars + d_pcars + d_trees + d_mvciclyst + d_lands + d_bid + d_bheig + d_dbuild + d_people + d_graff) + 
      inc_cat:(d_swidth + d_mvcars + d_pcars + d_trees + d_mvciclyst + d_lands + d_bid + d_bheig + d_dbuild + d_people + d_graff),
    data = the_data,
    family = binomial()))
}

create_model_wo_profile = function(the_data){
  return(glm(
    choice ~ d_swidth + d_mvcars + d_pcars + d_trees + d_mvciclyst + d_lands + d_bid + d_bheig + d_dbuild + d_people + d_graff + bair_cat,
    data = the_data,
    family = binomial()))
}
```

```{r model.agrad}
mostpleasant_model <- create_model_w_interact(agrad)
summary(mostpleasant_model)
vif(mostpleasant_model)
#anova(mostpleasant_model, test="Chisq")

mostpleasant_model_wo_profile <- create_model_wo_profile(agrad)
summary(mostpleasant_model_wo_profile)
vif(mostpleasant_model_wo_profile)

coefs_ag = tidy(mostpleasant_model, conf.int = TRUE, exponentiate = TRUE) 
coefs_ag %>% 
  mutate_at(vars(-1), prettyNum, digits = 3) %>% 
  datatable()
{ # fix for what seems like a bug in pR2
  the_data = agrad
  pR2(mostpleasant_model)
}
```

```{r model.safe}
safer_model <- create_model_w_interact(seg)
summary(safer_model)
#anova(safer_model, test="Chisq")
vif(safer_model)

safer_model_wo_profile <- create_model_wo_profile(seg)
summary(safer_model_wo_profile)
vif(safer_model_wo_profile)

coefs_seg = tidy(safer_model, conf.int = TRUE, exponentiate = TRUE) 
coefs_seg %>% 
  mutate_at(vars(-1), prettyNum, digits = 3) %>% 
  datatable()

{ # fix for what seems like a bug in pR2
  the_data = seg
  pR2(safer_model)
}
```

```{r visualize_models}
library(modelr) # devtools::install_github("hadley/modelr")

m = agrad %>%
  data_grid(agrad, 
            .model = mostpleasant_model)

mm = augment(mostpleasant_model,
             newdata = m,
             type.predict = "response")

ggplot(mm, aes(x = d_lands)) + 
  geom_hex(aes(y = .fitted)) +  
  geom_count(aes(y = as.numeric(as.character(choice))), alpha = .1) + 
  facet_grid(gender ~ inc_cat + age_cat) 

```

```{r visualize_models}
#Analysing Leave user out results
source("analisaICPorFoto.R")

computeICForArrayOfValues <- function(files) {
  for (file in files){
    data <- read.table(file, header=TRUE)
    distance <- ic(filter(data, x != "NA")$x)
    meanValue <- mean(data$x, na.rm = TRUE)
    print(paste(file, meanValue, (meanValue - distance), (meanValue + distance), sep = "\t"))
  }
}

files <- c('logit/accuraciesA.dat', 'logit/accuraciesS.dat', 'logit/accuraciesA_WOProfile.dat', 'logit/accuraciesS_WOProfile.dat')
files <- c('logit/accuraciesA0.5.dat', 'logit/accuraciesA0.6.dat', 'logit/accuraciesA0.7.dat')
computeICForArrayOfValues(files)

files <- c('logit/precisionA0.5.dat', 'logit/precisionA0.6.dat', 'logit/precisionA0.7.dat')
computeICForArrayOfValues(files)

files <- c('logit/recallA0.5.dat', 'logit/recallA0.6.dat', 'logit/recallA0.7.dat')
computeICForArrayOfValues(files)

files <- c('logit/precisionA.dat', 'logit/precisionS.dat', 'logit/precisionA_WOProfile.dat', 'logit/precisionS_WOProfile.dat')
computeICForArrayOfValues(files)

files <- c('logit/recallA.dat', 'logit/recallS.dat', 'logit/recallA_WOProfile.dat', 'logit/recallS_WOProfile.dat')
computeICForArrayOfValues(files)

filesCoef <- c('coefficientsA.dat', 'coefficientsS.dat')
filesPval <- c('pvaluesA.dat', 'pvaluesS.dat')
for (index in 1:2){
  coefData <- read.table(filesCoef[index], skip=1)
  pvalData <- read.table(filesPval[index], skip=1)
  
  #Values in exp()
  distancesCoef <- apply(coefData[, c(2:ncol(coefData))], 1, ic)
  meanCoef <- apply(coefData[, c(2:ncol(coefData))], 1, mean)
  coefData$mean <- meanCoef
  coefData$low <- meanCoef - distancesCoef
  coefData$high <- meanCoef + distancesCoef

  distancesPval <- apply(pvalData[, c(2:ncol(pvalData))], 1, ic)
  meanPval <- apply(pvalData[, c(2:ncol(pvalData))], 1, mean)
  pvalData$mean <- meanPval
  pvalData$low <- meanPval - distancesPval
  pvalData$high <- meanPval + distancesPval
  
  print(paste(filesCoef[index], coefData$V1, coefData$mean, coefData$low, coefData$high, pvalData$mean, pvalData$low, pvalData$high, sep = "\t"), quote=FALSE)
}
```
