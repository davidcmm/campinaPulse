---
title: "analisaPorRua"
output:
  html_document:
    self_contained: no
---

```{r setup, include=FALSE}
library("vioplot")
library("ggplot2")
library("dplyr")
```

Os estudos de percepção realizados até o momento têm focado em capturar diversas imagens espalhadas pela cidade, obter as QScores/preferências das pessoas e treinar modelos de mais baixo nível ou alto nível (vide nosso artigo do HT ou o artigo com índice de ceu, verde, etc.) para predizer preferências para novas fotos que ainda não foram avaliadas por pessoas. Com isso surgem alguns pontos a serem considerados:

1. Os modelos treinados com estes conjuntos de dados tendem a capturar as tendências médias, o típico presente nos dados. E se pensarmos em analisar outro contexto social, ruas de outros locais ou, ainda, traçar um panorama detalhado de alguma rua?
+ O contexto social podemos pensar em lidar capturando preferências dos diferentes segmentos sociais
+ As ruas de outras cidades podemos pensar em capturar imagens de outras cidades, cujo contexto seja mais parecido com o contexto da cidade que queremos avaliar
+ E o panorama detalhado da rua? Precisamos ter ideias mais precisas de como são as várias ruas daquela cidade, suas particularidades, para que os modelos treinados com esses dados possam reproduzir mais fielmente as preferências das pessoas sobre aqueles locais. Com essa ideia estamos buscando avaliar as particularidades, ou o que podemos ganhar/perder, pensando em captura de percepções em um nível mais micro em relação à captura de percepção em um nível mais macro.

Para isso, foram escolhidas 4 ruas de Campina Grande, 20 fotos por rua (5 pontos da rua x 4 ângulos), para avaliação quanto à questão agradável. 2 dessas ruas apresentaram os pontos de maior divergência de percepção em nossa análise anterior (Edésio Silva e Inácio Marques), uma rua apresentou o ponto de maior homogeneidade (Manoel Pereira), porém com notas baixas, e a outra rua é uma rua importante do centro da cidade (Maciel Pinheiro), que tem uma tendência de homogeneidade, com notas boas. 

Alguns questionamentos foram inicialmente levantados:

1. Na média as ruas são parecidas ou não? Tem alguma rua que parece muito boa ou muito ruim?
2. Será que ruas que são parecidas na média, são de fato similares?
3. Olhando a dispersão da rua como um todo, posso tentar dizer algo sobre a rua?
4. Olhando as variações dos QScores por número/ponto na rua, consigo perceber variações que podem indicar problemas?
5. Confrontando as variações no QScores com as fotos, podemos apontar problemas/virtudes das ruas?

# Impressão Geral das Ruas


1. Na média as ruas são parecidas ou não? Tem alguma rua que parece muito boa ou muito ruim?

```{r}
#Checking sample size
data2 <- read.table("all_ordenado.dat")
data2$sd <- apply(data2[,4:ncol(data2)], 1, sd)
data2$n <- ( 1.96 * data2$sd / 0.2) ** 2  #All QScores
print(">>>> Maior e menor amostra necessária ")
print(max(data2$n))
print(min(data2$n))

#Getting data for each street
data <- read.csv("qscores-df.csv", header = TRUE)

edesio_scores = filter(data, street == "R._Edésio_Silva")$qscore
edesio_sd = sd(edesio_scores)
inacio_scores = filter(data, street == "R._Inácio_Marquês_da_Silva")$qscore
inacio_sd = sd(inacio_scores)
manoel_scores = filter(data, street == "R._Manoel_Pereira_de_Araújo")$qscore
manoel_sd = sd(manoel_scores)
maciel_scores = filter(data, street == "R._Maciel_Pinheiro")$qscore
maciel_sd = sd(maciel_scores)

new_frame = data.frame(mean_scores = c(mean(maciel_scores), mean(manoel_scores), mean(edesio_scores), mean(inacio_scores)), street = c("Maciel", "Manoel", "Edesio", "Inacio"), ci = c(maciel_sd * 1.96 / length(maciel_scores),  manoel_sd * 1.96 / length(manoel_scores), edesio_sd * 1.96 / length(edesio_scores), inacio_sd * 1.96 / length(inacio_scores)))

ggplot(new_frame, aes(x=street, y=mean_scores, fill=street)) + 
    geom_bar(position=position_dodge(), stat="identity") +
    geom_errorbar(aes(ymin=mean_scores-ci, ymax=mean_scores+ci),
                  width=.2,                    # Width of the error bars
                  position=position_dodge(.9))

```

- Os ICs com 95% de confiança das 20 fotos foi razoavelmente curto, permitindo uma comparação das médias;
- A Manoel P. de Araújo realmente está bem abaixo das demais ruas;
- As outras três ruas possuem intervalos próximos, que podem ser confundíveis, apesar da Inácio Marques e a Maciel Pinheiro parecerem ter uma tendência de melhores scores que a Edesio;

2. Será que ruas que são parecidas na média, são de fato similares?
3. Olhando a dispersão da rua como um todo, posso tentar dizer algo sobre a rua?

Três das ruas selecionadas parecem bem similares de acordo com a média, mas será que são similares assim? Para isso computamos os violin plots de cada rua.

```{r }
value <- data$qscore

with(data , vioplot( value[street=="R._Inácio_Marquês_da_Silva"] , value[street=="R._Edésio_Silva"], value[street=="R._Manoel_Pereira_de_Araújo"], value[street=="R._Maciel_Pinheiro"],  col=rgb(0.1,0.4,0.7,0.7) , names=c("Inacio","Edesio","Manoel", "Maciel") ))
```

A partir da análise dos violin plots, alguns pontos podem ser destacados:

- A Manoel P. de Araújo foi realmente a rua com as notas em gerais mais baixas o que pode ser um indicativo de problema na rua. Analisando com mais cuidado as imagens da rua na próxima Seção, pode-se perceber que esses valores baixos eram esperados, já que se trata de uma área antiga e pouco cuidada do centro da cidade (bem degradada!);
- A Inacio Marques e a Edesio silva tiveram valores mais espalhados com uma maior concentração em algumas regiões, o que era esperado dado variações nos tipos de locais nessas ruas (mais ou menos verde, mais ou menos conservados). A Edesio tem uma maior concentração de valores medianos, e medianos para bom e para ruim, já a Inácio tem uma maior concentração de valores para medianos bons e ruins;
- A Maciel Pinheiro tem uma maior concentração de valores com notas parecidas, o que era esperado dado a maior semelhança de locais ao longo de toda a rua. Isso a torna mais homogênea que a Inacio e a Edesio, porém mais heterogênea que a Manoel P. de Araujo;
- A Inacio, Edesio e Maciel possuem QScores que variam em 2 ou mais pontos. Essa grande variação merece ser analisada com mais cuidado já que pode ser um indicativo de problemas em certos locais das ruas!

Para complemento numérico dos violin plots, o sumário de cada rua na seguinte ordem: Inacio, Edesio, Maciel e Manoel.
```{r }
summary(filter(data, street == "R._Inácio_Marquês_da_Silva")$qscore)
summary(filter(data, street == "R._Edésio_Silva")$qscore)
summary(filter(data, street == "R._Maciel_Pinheiro")$qscore)
summary(filter(data, street == "R._Manoel_Pereira_de_Araújo")$qscore)
```


# Analisando em detalhe cada rua

Para entender um pouco melhor cada rua, tentamos analisar os QScores obtidos ao longo da rua e confrontá-los com as imagens para tentar responder as duas questões:

4. Olhando as variações dos QScores por número/ponto na rua, consigo perceber variações que podem indicar problemas?
5. Confrontando as variações no QScores com as fotos, podemos apontar problemas/virtudes das ruas?

## Inacio Marques

```{r }
summary_inacio = filter(data, street == "R._Inácio_Marquês_da_Silva") %>% group_by(num) %>% summarise(media_ponto = mean(qscore), sd = sd(qscore))
summary_edesio = filter(data, street == "R._Edésio_Silva") %>% group_by(num) %>% summarise(media_ponto = mean(qscore), sd = sd(qscore))
summary_maciel = filter(data, street == "R._Maciel_Pinheiro") %>% group_by(num) %>% summarise(media_ponto = mean(qscore), sd = sd(qscore))
summary_manoel = filter(data, street == "R._Manoel_Pereira_de_Araújo") %>% group_by(num) %>% summarise(media_ponto = mean(qscore), sd = sd(qscore))
```

```{r }
summary_inacio
```
Para a Inacio Marques percebemos uma **variação de aproximadamente 1.3** nas médias do QScore do número 500 (região de muros logo após o museu) e do número 239 (regiao residencial no quarteirão seguinte ao museu). Esta diferença parece um indicativo de variação entre tipos, ou qualidades, de locais na rua e que a faixa do número 100-300 tem melhores avaliações, enquanto o início (54) e o final da rua (500) parecem ser regiões mais problemáticas.

Analisando os scores de cada ângulo em cada ponto da rua, pode-se observar **que as maiores diferenças variam de 0.01 a 2.1 entre ângulos do mesmo número**. Essas diferenças podem ser indicativos de variações de manutenção/qualidade de locais muito próximos. Por exemplo:

- no número 54, as variações para os ângulos 203 e 293
- no número 120 a baixa nota do ângulo 203
- no número 239 existe uma grande homogeneidade, de forma positiva
- no número 360 as variações para os números 90 e 203 
- no número 500 também temos uma maior homogeneidade, de forma negativa

```{r results='asis', echo=FALSE, out.extra=''}
library("knitr")
inacio <- filter(data, street == "R._Inácio_Marquês_da_Silva") %>% group_by(num) %>% arrange(street, num, angle) %>% select(url, street, num, angle, qscore)

show_street_data <- function (current_df){
    cat("<div class='row'>")
    for(i in 1:nrow(current_df)) {
      row <- current_df[i,]
      url <- as.character(row$url)
      street <- as.character(row$street)
      num <- row$num
      angle <- row$angle
      score <- row$qscore
      cat("<div class='col-xs-3'>")
      cat("<img src='", url,"' width='300px'>", sep = "")
      cat("<div class='caption'>", street, " " , num , ", ", angle, " -> ", score,  "</div>", sep="")
      cat("</div>")
      if (i > 1 && i %% 4 == 0){
        cat("</div>")
        cat("<div class='row'>")
      }
    }
}

show_street_data(inacio)

```


Com esse nível de detalhe conseguimos confrontar os scores com as imagens e perceber que:

- a Inácio Marques é uma rua que possui seu final como sendo uma área pouco cuidada (número 500), com muros/construções pouco cuidadas, terrenos, sem atrativo;
- o início da rua (segunda área de score mais baixo) tem alguns trechos de casas mais simples e/ou pouco cuidadas, lixo, vegetação pouco cuidada e vegetação bem cuidada em um angulo apenas;
- outras áreas com níveis de cuidado variados, onde poderíamos apontar setores nos números 120 e 360, principalmente, que poderiam receber melhores cuidados. No número 360, angulos 90 e 203, temos terrenos que precisam de maiores cuidados, contrapostos a uma bela visão proporcionada pela presença do museu e sua vegetação melhor cuidada. No número 120, ângulos 203 temos lixo e melhoria necessária nas construções, e no ângulo 112 temos mais uma indicação de melhoria em construção/construção inacabada contraposta com outras construções bem cuidadas e com verde;
- a região do número 239 sintetiza boas avaliações e vai de acordo com nossa avaliação anterior: boa manutenção, verde, rua larga

Analisando de forma geral as fotos percebemos que, conforme esperado, os locais com menor conservação e menos verde apresentam QScores mais baixos, indicando que ações de melhoria/cuidado poderiam ser direcionados para essas áreas. 

## Edesio Silva

```{r}
summary_edesio
```

Para a Edesio percebemos **uma variação de aproximadamente 1.34** nas médias do QScore do número 1136 (terreno, pouco cuidada) e do número 1546 (casas mais novas, bem cuidadas). Esta diferença parece um indicativo de variação entre tipos, ou qualidades, de locais na rua. É importante perceber que, ao contrário da Inacio, a Edesio parece ter uma alternância maior entre locais bem e mal avaliados ao longo da rua.

Analisando os scores de cada ângulo em cada ponto da rua, pode-se observar **que as maiores diferenças variam de 0.21 a 2.3 no QScore entre ângulos do mesmo número**. Por exemplo:

- no número 70, o ângulo 22 com nota distoante dos demais ângulos;
- no número 306 a melhor nota do ângulo 203;
- no número 602 as melhores notas dos ângulos 22 e 315;
- no número 1136 temos uma maior homogeneidade, de forma negativa;
- no número 1546 temos uma maior homogeneidade, de forma positiva, com o ângulo 22 apresentando uma nota ainda melhor.

```{r results='asis', echo=FALSE, out.extra=''}
edesio <- filter(data, street == "R._Edésio_Silva") %>% group_by(num) %>% arrange(street, num, angle) %>% select(url, street, num, angle, qscore)
show_street_data(edesio)
```

Com esse nível de detalhe conseguimos confrontar os scores com as imagens e perceber que:

- a Edesio Silva possui uma área muito pouco cuidada (número 1136), com os ângulos 22, 135 e 203 temos problemas de terrenos, lixo e casas pouco cuidadas;
- no restante da rua temos variações de melhoras e piores nas notas entre os números e entre os ângulos. No número 70, ângulo 135 existe uma construção inacabada que afeta a vista da rua, nos angulos 135 e 203 existe lixo na rua, nos angulos 135, 203 e 315 existem algumas casas que precisam de melhor cuidado e falta verde na rua. No número 602, ângulo 203 temos um terreno com lixos, angulo 135 temos alem de um muro pouco cuidado uma falta de verde (apesar de termos arvores em crescimento!). No número 306 temos notas medianas que condizem com a combinação de vegetação com casas de boa manutenção e algumas de menor manutenção, ou artefatos de construção.

Analisando de forma geral as fotos percebemos que, conforme esperado, os locais com menor conservação e menos verde apresentam QScores mais baixos, indicando que ações de melhoria/cuidado poderiam ser direcionados para essas áreas. 

## Maciel Pinheiro

```{r }
summary_maciel
```

Para a Maciel percebemos **uma variação de aproximadamente 0.2** nas médias do QScore do número 248 e dos números 130 e 360. Esta diferença parece um indicativo de variações sutis de preferências dos usuários por fachadas de lojas, quantidade de carros, dentre outros. Outro ponto importante é a presença típica de QScores medianos, ou medianos para alto, e ligeiras melhorias mais no centro da rua.

Analisando os scores de cada ângulo em cada ponto da rua, pode-se observar **que as maiores diferenças por ângulo variam de 1 a 1.2 entre angulos do mesmo número**. Esta variação, ao contrário da Edesio e Inacio, sugere que em cada número existe ao menos 1 angulo que desperta um sentimento mais positivo ou negativo. >>> Por exemplo:

- No número 360, temos uma nota mais alta para o ângulo 360;
- No número 284, temos uma nota mais baixa para o ângulo 270;
- No número 248, temos uma nota mais baixa para o ângulo 360;
- No número 190, temos uma nota mais baixa para o ângulo 180;
- No número 130, temos uma nota mais baixa para o ângulo 270

```{r results='asis', echo=FALSE, out.extra=''}
maciel <- filter(data, street == "R._Maciel_Pinheiro") %>% group_by(num) %>% arrange(street, num, angle) %>% select(url, street, num, angle, qscore)
show_street_data(maciel)
```

Com esse nível de detalhe conseguimos perceber que a Maciel Pinheiro é uma rua mais homogênea, com pouca variação entre os vários pontos da rua. Entretanto, alguns pontos despertaram percepções mais negativas nos respondentes e devem ser melhor avaliados. 

Analisando de forma geral as fotos percebemos que, conforme esperado, em geral os locais possuem um bom nível de manutenção o que condiz com as notas mais altas de percepção (acima de 5.0, próximo a 6.0).  

A partir do diagonóstico com base nos dados de percepção podemos olhar as fotos, ou o próprio local, e perceber que:

- No número 360, ângulo 270 temos um prédio em pior estado de conservação e um caminhão estacionado impedindo a visão de outros detalhes da rua;
- No número 284, ângulo 270 temos um estacionamento e um prédio um pouco mais antigo;
- No número 248, ângulo 360 podemos ter um caso de preferência de estilo de vitrines e prédios;
- No número 190, ângulo 180 temos um prédio em pior estado de conservação;
- No número 130, ângulo 270 podemos ter um caso de preferência de estilo de vitrines e prédios.

## Manoel Pereira

```{r }
summary_manoel
```

Para a Manoel percebemos **uma variação de aproximadamente 0.3** nas médias do QScore do número 222 e do número 188. Esta diferença parece um indicativo de variações sutis de preferências dos usuários de acordo com as condições de manutenção na rua, lixo. O número 222 parece apresentar ligeiramente uma maior deficiência que os demais pontos da rua. Outro ponto importante é a presença de QScores tipicamente mais baixos dentro do conjunto avaliado, o que sugere que a rua é mais problemática que as demais ruas avaliadas.

Analisando os scores de cada ângulo em cada ponto da rua, pode-se observar que apesar das notas tipicamente baixas ainda temos casos **de diferenças de 0.5 ou 1 ou mais pontos** no QScore entre ângulos do mesmo número. Por exemplo:

- No número 370, no ângulo 315 temos quase 1 ponto a menos do melhor ponto da rua;
- No número 300, ângulo 315 temos quase 1 ponto a menos  do melhor ponto da rua;
- No número 222, ângulo 22 temos mais de 1 ponto a menos do melhor ponto da rua;

```{r results='asis', echo=FALSE, out.extra=''}
manoel <- filter(data, street == "R._Manoel_Pereira_de_Araújo") %>% group_by(num) %>% arrange(street, num, angle) %>% select(url, street, num, angle, qscore)
show_street_data(manoel)
```

Com esse nível de detalhe conseguimos perceber que a Manoel P é uma rua mais homogênea, de forma negativa, com pouca variação entre os vários pontos da rua. Entretanto, alguns pontos despertaram percepções ainda mais negativas nos respondentes e devem ser melhor avaliados. Essas observações são importantes porque acrescentam que, apesar dos QScores sugerirem que a rua toda é mais problemática que as demais avaliadas, ainda assim existem pontos mais críticos na rua.

Analisando de forma geral as fotos percebemos que, conforme esperado, em geral os locais possuem um nível ruim de manutenção o que condiz com as notas mais baixas de percepção (em torno de 3).  

A partir do diagonóstico com base nos dados de percepção podemos olhar as fotos, ou o próprio local, e perceber que:

- No número 370, no ângulo 315 temos ainda mais barracas e sujo na rua;
- No número 300, ângulo 315 temos alguns prédios mais antigos e pouco cuidados combinados com itens na rua;
- No número 222, ângulo 22 temos prédios em pior estado de conservação combinados com itens na rua;