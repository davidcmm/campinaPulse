<div id="taskpresenter" ng-app="CampinaApp" ng-controller="MainController as MainCtrl">

<h4> Melhores Imagens </h4>
<div class=col-md-4> <canvas id=canvas1></canvas> </div>
<div class=col-md-4> <canvas id=canvas2></canvas> </div>
<div class=col-md-4> <canvas id=canvas3></canvas> </div>
<div class=col-md-4> <canvas id=canvas4></canvas> </div>
<div class=col-md-4> <canvas id=canvas5></canvas> </div>
<div class=col-md-4> <canvas id=canvas6></canvas> </div>
<div class=col-md-4> <canvas id=canvas7></canvas> </div>
<div class=col-md-4> <canvas id=canvas8></canvas> </div>
<div class=col-md-4> <canvas id=canvas9></canvas> </div>
<div class=col-md-4> <canvas id=canvas10></canvas> </div>
<div class=col-md-4> <canvas id=canvas11></canvas> </div>
<div class=col-md-4> <canvas id=canvas12></canvas> </div>
<div class=col-md-4> <canvas id=canvas13></canvas> </div>
<div class=col-md-4> <canvas id=canvas14></canvas> </div>
<div class=col-md-4> <canvas id=canvas15></canvas> </div>
<div class=col-md-4> <canvas id=canvas16></canvas> </div>
<div class=col-md-4> <canvas id=canvas17></canvas> </div>
<div class=col-md-4> <canvas id=canvas18></canvas> </div>
<div class=col-md-4> <canvas id=canvas19></canvas> </div>
<div class=col-md-4> <canvas id=canvas20></canvas> </div>
<div class=col-md-4> <canvas id=canvas21></canvas> </div>
<div class=col-md-4> <canvas id=canvas22></canvas> </div>
<div class=col-md-4> <canvas id=canvas23></canvas> </div>
<div class=col-md-4> <canvas id=canvas24></canvas> </div>
<div class=col-md-4> <canvas id=canvas25></canvas> </div>
<div class=col-md-4> <canvas id=canvas26></canvas> </div>
<div class=col-md-4> <canvas id=canvas27></canvas> </div>
<div class=col-md-4> <canvas id=canvas28></canvas> </div>
<div class=col-md-4> <canvas id=canvas29></canvas> </div>
<div class=col-md-4> <canvas id=canvas30></canvas> </div>
<div class=col-md-4> <canvas id=canvas31></canvas> </div>
<div class=col-md-4> <canvas id=canvas32></canvas> </div>
<div class=col-md-4> <canvas id=canvas33></canvas> </div>
<div class=col-md-4> <canvas id=canvas34></canvas> </div>
<div class=col-md-4> <canvas id=canvas35></canvas> </div>
<div class=col-md-4> <canvas id=canvas36></canvas> </div>
<div class=col-md-4> <canvas id=canvas37></canvas> </div>
<div class=col-md-4> <canvas id=canvas38></canvas> </div>
<div class=col-md-4> <canvas id=canvas39></canvas> </div>
<div class=col-md-4> <canvas id=canvas40></canvas> </div>
<div class=col-md-4> <canvas id=canvas41></canvas> </div>
<div class=col-md-4> <canvas id=canvas42></canvas> </div>
<div class=col-md-4> <canvas id=canvas43></canvas> </div>
<div class=col-md-4> <canvas id=canvas44></canvas> </div>
<div class=col-md-4> <canvas id=canvas45></canvas> </div>
<div class=col-md-4> <canvas id=canvas46></canvas> </div>
<div class=col-md-4> <canvas id=canvas47></canvas> </div>
<div class=col-md-4> <canvas id=canvas48></canvas> </div>
<div class=col-md-4> <canvas id=canvas49></canvas> </div>
<div class=col-md-4> <canvas id=canvas50></canvas> </div>
<div class=col-md-4> <canvas id=canvas51></canvas> </div>
<div class=col-md-4> <canvas id=canvas52></canvas> </div>
<div class=col-md-4> <canvas id=canvas53></canvas> </div>
<div class=col-md-4> <canvas id=canvas54></canvas> </div>
<div class=col-md-4> <canvas id=canvas55></canvas> </div>
<div class=col-md-4> <canvas id=canvas56></canvas> </div>
<div class=col-md-4> <canvas id=canvas57></canvas> </div>
<div class=col-md-4> <canvas id=canvas58></canvas> </div>
<div class=col-md-4> <canvas id=canvas59></canvas> </div>
<div class=col-md-4> <canvas id=canvas60></canvas> </div>
<div class=col-md-4> <canvas id=canvas61></canvas> </div>
<div class=col-md-4> <canvas id=canvas62></canvas> </div>
<div class=col-md-4> <canvas id=canvas63></canvas> </div>
<div class=col-md-4> <canvas id=canvas64></canvas> </div>
<div class=col-md-4> <canvas id=canvas65></canvas> </div>
<div class=col-md-4> <canvas id=canvas66></canvas> </div>
<div class=col-md-4> <canvas id=canvas67></canvas> </div>
<div class=col-md-4> <canvas id=canvas68></canvas> </div>
<div class=col-md-4> <canvas id=canvas69></canvas> </div>
<div class=col-md-4> <canvas id=canvas70></canvas> </div>
<div class=col-md-4> <canvas id=canvas71></canvas> </div>
<div class=col-md-4> <canvas id=canvas72></canvas> </div>
<div class=col-md-4> <canvas id=canvas73></canvas> </div>
<div class=col-md-4> <canvas id=canvas74></canvas> </div>
<div class=col-md-4> <canvas id=canvas75></canvas> </div>
<div class=col-md-4> <canvas id=canvas76></canvas> </div>
<div class=col-md-4> <canvas id=canvas77></canvas> </div>
<div class=col-md-4> <canvas id=canvas78></canvas> </div>
<div class=col-md-4> <canvas id=canvas79></canvas> </div>
<div class=col-md-4> <canvas id=canvas80></canvas> </div>

<h4> Piores Imagens </h4>
<div class=col-md-4> <canvas id=canvas81></canvas> </div>
<div class=col-md-4> <canvas id=canvas82></canvas> </div>
<div class=col-md-4> <canvas id=canvas83></canvas> </div>
<div class=col-md-4> <canvas id=canvas84></canvas> </div>
<div class=col-md-4> <canvas id=canvas85></canvas> </div>
<div class=col-md-4> <canvas id=canvas86></canvas> </div>
<div class=col-md-4> <canvas id=canvas87></canvas> </div>
<div class=col-md-4> <canvas id=canvas88></canvas> </div>
<div class=col-md-4> <canvas id=canvas89></canvas> </div>
<div class=col-md-4> <canvas id=canvas90></canvas> </div>
<div class=col-md-4> <canvas id=canvas91></canvas> </div>
<div class=col-md-4> <canvas id=canvas92></canvas> </div>
<div class=col-md-4> <canvas id=canvas93></canvas> </div>
<div class=col-md-4> <canvas id=canvas94></canvas> </div>
<div class=col-md-4> <canvas id=canvas95></canvas> </div>
<div class=col-md-4> <canvas id=canvas96></canvas> </div>
<div class=col-md-4> <canvas id=canvas97></canvas> </div>
<div class=col-md-4> <canvas id=canvas98></canvas> </div>
<div class=col-md-4> <canvas id=canvas99></canvas> </div>
<div class=col-md-4> <canvas id=canvas100></canvas> </div>
<div class=col-md-4> <canvas id=canvas101></canvas> </div>
<div class=col-md-4> <canvas id=canvas102></canvas> </div>
<div class=col-md-4> <canvas id=canvas103></canvas> </div>
<div class=col-md-4> <canvas id=canvas104></canvas> </div>
<div class=col-md-4> <canvas id=canvas105></canvas> </div>
<div class=col-md-4> <canvas id=canvas106></canvas> </div>
<div class=col-md-4> <canvas id=canvas107></canvas> </div>
<div class=col-md-4> <canvas id=canvas108></canvas> </div>
<div class=col-md-4> <canvas id=canvas109></canvas> </div>
<div class=col-md-4> <canvas id=canvas110></canvas> </div>
<div class=col-md-4> <canvas id=canvas111></canvas> </div>
<div class=col-md-4> <canvas id=canvas112></canvas> </div>
<div class=col-md-4> <canvas id=canvas113></canvas> </div>
<div class=col-md-4> <canvas id=canvas114></canvas> </div>
<div class=col-md-4> <canvas id=canvas115></canvas> </div>
<div class=col-md-4> <canvas id=canvas116></canvas> </div>
<div class=col-md-4> <canvas id=canvas117></canvas> </div>
<div class=col-md-4> <canvas id=canvas118></canvas> </div>
<div class=col-md-4> <canvas id=canvas119></canvas> </div>
<div class=col-md-4> <canvas id=canvas120></canvas> </div>
<div class=col-md-4> <canvas id=canvas121></canvas> </div>
<div class=col-md-4> <canvas id=canvas122></canvas> </div>
<div class=col-md-4> <canvas id=canvas123></canvas> </div>
<div class=col-md-4> <canvas id=canvas124></canvas> </div>
<div class=col-md-4> <canvas id=canvas125></canvas> </div>
<div class=col-md-4> <canvas id=canvas126></canvas> </div>
<div class=col-md-4> <canvas id=canvas127></canvas> </div>
<div class=col-md-4> <canvas id=canvas128></canvas> </div>
<div class=col-md-4> <canvas id=canvas129></canvas> </div>
<div class=col-md-4> <canvas id=canvas130></canvas> </div>
<div class=col-md-4> <canvas id=canvas131></canvas> </div>
<div class=col-md-4> <canvas id=canvas132></canvas> </div>
<div class=col-md-4> <canvas id=canvas133></canvas> </div>
<div class=col-md-4> <canvas id=canvas134></canvas> </div>
<div class=col-md-4> <canvas id=canvas135></canvas> </div>
<div class=col-md-4> <canvas id=canvas136></canvas> </div>
<div class=col-md-4> <canvas id=canvas137></canvas> </div>
<div class=col-md-4> <canvas id=canvas138></canvas> </div>
<div class=col-md-4> <canvas id=canvas139></canvas> </div>
<div class=col-md-4> <canvas id=canvas140></canvas> </div>
<div class=col-md-4> <canvas id=canvas141></canvas> </div>
<div class=col-md-4> <canvas id=canvas142></canvas> </div>
<div class=col-md-4> <canvas id=canvas143></canvas> </div>
<div class=col-md-4> <canvas id=canvas144></canvas> </div>
<div class=col-md-4> <canvas id=canvas145></canvas> </div>
<div class=col-md-4> <canvas id=canvas146></canvas> </div>
<div class=col-md-4> <canvas id=canvas147></canvas> </div>
<div class=col-md-4> <canvas id=canvas148></canvas> </div>
<div class=col-md-4> <canvas id=canvas149></canvas> </div>
<div class=col-md-4> <canvas id=canvas150></canvas> </div>
<div class=col-md-4> <canvas id=canvas151></canvas> </div>
<div class=col-md-4> <canvas id=canvas152></canvas> </div>
<div class=col-md-4> <canvas id=canvas153></canvas> </div>
<div class=col-md-4> <canvas id=canvas154></canvas> </div>
<div class=col-md-4> <canvas id=canvas155></canvas> </div>
<div class=col-md-4> <canvas id=canvas156></canvas> </div>
<div class=col-md-4> <canvas id=canvas157></canvas> </div>
<div class=col-md-4> <canvas id=canvas158></canvas> </div>
<div class=col-md-4> <canvas id=canvas159></canvas> </div>
<div class=col-md-4> <canvas id=canvas160></canvas> </div>

</div>

<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.7/angular.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.7/angular-cookies.js"></script>
<script src="https://contribua.org/comoecampina-static/imgs/dist/fabric.js"></script>
<script src="async-master/dist/async.js"></script>

<script>

	//Getting data from task-run
	var app = angular.module('CampinaApp', ['ngCookies']);
	app.controller('MainController', ['$scope', '$http', '$cookies', function($scope, $http, $cookies) {
		var apiUrl = 'https://contribua.org/api/';
		var projectId = '583';
		var offset = 0;
		var limit = 1000;//'&limit='+limit
		var bestMap = new Map();
		var worstMap = new Map();
		alert(apiUrl+'taskrun?project_id='+projectId+'&offset='+offset);

		function processTaskRunResponses(response, cb) {
			var i;
			if (response.data.length !== 0) {
				alert("Tamanho " + response.data.length + " offset " + offset + " id inicial " + response.data[0].id + " id final " + response.data[response.data.length-1].id);
				for (i = 0; i < response.data.length; i++) {
					var currentData = response.data[i];
					// Getting best and worst images and marked points
					var bestImage = currentData.info.theMost;
					var worstImage = currentData.info.theLess;
					var bestPoints = eval(currentData.info.markMost);
					var worstPoints = eval(currentData.info.markLess);

					if (bestMap.has(bestImage)){
						var allBestPoints = bestMap.get(bestImage);
					}else{
						var allBestPoints = [];
					}
					allBestPoints = allBestPoints.concat(bestPoints);
					bestMap.set(bestImage, allBestPoints);

					if (worstMap.has(worstImage)){
						var allWorstPoints = worstMap.get(worstImage);
					}else{
						var allWorstPoints = [];
					}
					allWorstPoints = allWorstPoints.concat(worstPoints);
					worstMap.set(bestImage, allWorstPoints);	
				}
				offset = offset + response.data.length;
			}else{
				stopLoop = true;
			}
		}

		//Iterating through all task runs to collect marks! https://github.com/async-js/async#async.whilst
		//var whilst = require('async.whilst');
		var stopLoop = false;
	
		async.whilst(//https://npm.runkit.com/async.whilst
			  function condition() { 
				return !stopLoop; 
			  },
			  function loop(cb) {
			    $http.get(apiUrl+'taskrun?project_id='+projectId+'&offset='+offset).then(function(response) {
				   processTaskRunResponses(response, cb);
				   setTimeout(cb, 100);
			    });
			  },
			  function end(err) {
				if(err){
					console.log("Erro " + err);
					return;
				}
				alert("Terminei, chamando display");
			    // 5 seconds have passed, n = 5
			    //Call function to display images and marks!
			    displayImagesAndMarks();
			  }
		);
		/*var count = 0;
		async.whilst(
		  function condition() { return count < 5; },
		  function loop(cb) {
		    count++;
		    alert("Estou no loop com "+count);
		    setTimeout(function () {
		      cb(null, count)
		    }, 1000);
		  },
		  function end(err, n) {
		    // 5 seconds have passed, n = 5
			alert("Terminei "+err + " " +n);
		  }
		);*/

			

		//var canvasID = "canvas1";
		//var canvas;

		function configFabric(canvasID) {
			var $ = function(id){return document.getElementById(id)};
	
			canvas = this.__canvas = new fabric.Canvas(canvasID, {
			   	isDrawingMode: true,
				selection: false
			});

			canvas.setWidth(500);
			canvas.setHeight(375);

			fabric.Object.prototype.transparentCorners = false;

			var drawingColorEl = "#005E7A",
			      drawingShadowColorEl = "#005E7A",
			      drawingLineWidthEl = 10,
			      drawingShadowWidth = 0,
			      drawingShadowOffset = 0;

			if (canvas.freeDrawingBrush) {
		
				canvas.freeDrawingBrush.color = drawingColorEl;
				canvas.freeDrawingBrush.width = parseInt(drawingLineWidthEl, 10) || 1;
				canvas.freeDrawingBrush.shadow = new fabric.Shadow({
					blur: parseInt(drawingShadowWidth, 10) || 0,
					offsetX: 0,
					offsetY: 0,
					affectStroke: true,
					color: drawingShadowColorEl
				});

				canvas.freeDrawingBrush.onMouseMove = function(pointer){
				      this._captureDrawingPath(pointer);
				      this.canvas.clearContext(this.canvas.contextTop);
				      this._render();
				}

				canvas.freeDrawingBrush.onMouseDown = function(pointer){
				      this._prepareForDrawing(pointer);
				      // capture coordinates immediately
				      // this allows to draw dots (when movement never occurs)
				      this._captureDrawingPath(pointer);
				      this._render();
				}

				canvas.freeDrawingBrush.onMouseUp = function(){
					this._finalizeAndAddPath();
				}
		      }
		     return canvas;
		}

		var canvas;
		function displayImagesAndMarks() {
			var index = 1;
			for (var [key, listOfMarks] of bestMap.entries()) {//Best images and their marks
				var canvasID = "canvas"+index;
				canvas = configFabric(canvasID);

				for (i = 0; i < listOfMarks.length; i++) {
					var currentList = listOfMarks[i];
					for (j = 0; j < currentList.length; j++) {
						var circle = new fabric.Circle({
							radius: 10, fill: 'green', left: currentList[j][0], top: currentList[j][1]
						});
						circle.originX = "center";
						circle.originY = "center";
						canvas.add(circle);
					}
				}
				canvas.setBackgroundImage(key, canvas.renderAll.bind(canvas));
				index = index + 1;
			}
	
			index = 81;
			for (var [key, listOfMarks] of worstMap.entries()) {//Worst images and their marks
				var canvasID = "canvas"+index;
				canvas = configFabric(canvasID);

				for (i = 0; i < listOfMarks.length; i++) {
					var currentList = listOfMarks[i];
					for (j = 0; j < currentList.length; j++) {
						var circle = new fabric.Circle({
							radius: 10, fill: 'red', left: currentList[j][0], top: currentList[j][1]
						});
						circle.originX = "center";
						circle.originY = "center";
						canvas.add(circle);
					}
				}
				canvas.setBackgroundImage(key, canvas.renderAll.bind(canvas));
				index = index + 1;
			}
		}

		//configFabric();
		//loadImage();

	/*	for (i = 0; i < listOfMarks.length; i++) {
			var currentList = listOfMarks[i];
			for (j = 0; j < currentList.length; j++) {
				/*if (j === 0){
					canvas._prepareForDrawing({x: currentList[j][0], y: currentList[j][1]});
					canvas._captureDrawingPath({x: currentList[j][0], y: currentList[j][1]});
					canvas._render();
				}else{
					canvas._captureDrawingPath({x: currentList[j][0], y: currentList[j][1]});
					canvas.clearContext(canvas.contextTop);
					canvas._render();
				}

				if (j === currentList.length-1){
					canvas._finalizeAndAddPath();
				}*/
				/*var circle = new fabric.Circle({
					radius: 10, fill: 'green', left: currentList[j][0], top: currentList[j][1]
				});
				circle.originX = "center";
				circle.originY = "center";
				canvas.add(circle);
				//canvas.freeDrawingBrush._points = currentList[j];
			}
		}

		canvas.setBackgroundImage("https://contribua.org/bairros/oeste/catole/R._In\u00e1cio_Marqu\u00eas_da_Silva_120_22.jpg", 		canvas.renderAll.bind(canvas)); 

		//Second image
		var canvasID = "canvas2";
		var canvas;
		configFabric();
		//loadImage();

		for (i = 0; i < listOfMarks2.length; i++) {
			var currentList = listOfMarks2[i];
			for (j = 0; j < currentList.length; j++) {
				/*if (j === 0){
					canvas._prepareForDrawing({x: currentList[j][0], y: currentList[j][1]});
					canvas._captureDrawingPath({x: currentList[j][0], y: currentList[j][1]});
					canvas._render();
				}else{
					canvas._captureDrawingPath({x: currentList[j][0], y: currentList[j][1]});
					canvas.clearContext(canvas.contextTop);
					canvas._render();
				}

				if (j === currentList.length-1){
					canvas._finalizeAndAddPath();
				}*/
				/*
				var circle = new fabric.Circle({
					radius: 10, fill: 'red', left: currentList[j][0], top: currentList[j][1]
				});
				circle.originX = "center";
				circle.originY = "center";
				canvas.add(circle);
				//canvas.freeDrawingBrush._points = currentList[j];
			}
		}

		canvas.setBackgroundImage("https://contribua.org/bairros/oeste/catole/R._In\u00e1cio_Marqu\u00eas_da_Silva_500_22.jpg", 		canvas.renderAll.bind(canvas)); */
	}]);

	app.directive('resize', function ($window) {
	    return function (scope, element) {
	        var w = angular.element($window);
	        scope.getWindowDimensions = function () {
	            return {
	                'h': w.height(),
	                'w': w.width()
	            };
	        };
	        scope.$watch(scope.getWindowDimensions, function (newValue, oldValue) {
	            scope.windowWidth = newValue.w;
	            scope.windowHeight = newValue.h;

	            scope.viewportWidth = newValue.h*1.1;

	            scope.style = function () {
	            	if (scope.windowHeight*1.1 < scope.windowWidth) {
		                return {
	                        	'width': (scope.viewportWidth) + 'px'
		                };
	            	} else {
	            		return;
	            	}
	            };

	        }, true);

	        w.bind('resize', function () {
	            scope.$apply();
	        });
	    }
	});

	app.run();

</script>
