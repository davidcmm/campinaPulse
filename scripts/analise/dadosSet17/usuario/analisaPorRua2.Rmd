---
title: "analisaPorRua2"
output:
  html_document:
    self_contained: no
  pdf_document: default
---

Aqui apresenta-se uma análise mais detalhada, rua a rua, a partir das percepções capturadas.

```{r setup, include=FALSE}
library("vioplot")
library("ggplot2")
library("dplyr")
library("knitr")
library("texreg")
library("ineq")
library(R.utils)
library("knitr")
library("spdep")

multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}
```

Ações a fazer/Discussão:

* Motivação: Birds-eye x visão de baixo no urbanismo
* O número da rua indica o que? Metros? http://campinagrandepb.com.br/wp-content/uploads/2014/10/codigo-de-obras-Lei-5410.131.pdf
* Índices de dispersão/quebra (entre números da rua, entre lados da rua, no mesmo lado, etc.)? Séries temporais?
- Representação em gráfico de duas linhas (dois lados) x mediana x média da rua -> áreas abaixo e acima + interseção de marcações
- O que um especialista diria de útil na análise
* Treinado x pessoas respondendo? Vantagens e desvantagens?

```{r results='asis', echo=FALSE, out.extra='', fig.height=10, fig.width=12, warning=FALSE}
#Checking sample size
scores_data <- read.table("all100/all_ordenado.dat")
scores_data$sd <- apply(scores_data[,4:ncol(scores_data)], 1, sd)
scores_data$n <- ( 1.96 * scores_data$sd / 0.2) ** 2  #All QScores
scores_data$ci <- scores_data$sd * 1.96 / sqrt(100)
novoV2 <- lapply(as.character(scores_data$V2), function (x) strsplit(x, split="/", fixed=TRUE)[[1]][7])
novoV2 <- unlist(lapply(novoV2, '[[', 1))
novoV2 <- strsplit(novoV2, split="\\.jpg")
photo <- unlist(lapply(novoV2, '[[', 1))
scores_data$photo_name <- photo
scores_data <- arrange(scores_data, photo_name)

qscoresDFGeral <- read.csv("qscores-df-geral.csv", header = TRUE)
qscoresDFCampina<- read.csv("qscores-df-campina.csv", header = TRUE)
qscoresDFNotCampina <- read.csv("qscores-df-notcampina.csv", header = TRUE)

#Plotting Q-Scores through the street
all_data <- merge(qscoresDFGeral, scores_data, by.x = "url", by.y="V2")#qscoresDFGeral
all_data$street <- as.character(all_data$street)
all_data$street <- factor(all_data$street, levels=unique(all_data$street))

plot_ci_per_photo <- function(data, plotTitle, ids1, ids2){
  pd <- position_dodge(0.1)
  #data$xlabel <- factor(data$xlabel, levels = data$xlabel)
  data$side <- ""
  data$side[data$angle %in% ids1] <- "Side 1"
  data$side[data$angle %in% ids2] <- "Side 2"

  if(plotTitle == "Cristina Procopio"){
    data$side[data$num == 436 & (data$angle == 22 | data$angle == 135)] <- "Side 1"
    data$side[data$num == 436 & (data$angle == 203 | data$angle == 315)] <- "Side 2"
  }
  
  if(plotTitle == "Edésio Silva" || plotTitle == "Manoel Pereira"){
    data1 <- arrange(filter(data, side == "Side 1"), num, -angle)
    data2 <- arrange(filter(data, side == "Side 2"), num, angle)
  }else if (plotTitle == "Inacio"  || plotTitle == "Maciel Pinheiro" || plotTitle == "Cristina Procopio" || plotTitle == "Floriano Peixoto"){
    data1 <- arrange(filter(data, side == "Side 1"), num, angle)
    data2 <- arrange(filter(data, side == "Side 2"), num, angle)
    
    if (plotTitle == "Cristina Procopio"){
        to_change <- data1[nrow(data1)-1,]
        data1[nrow(data1)-1,] <- data1[nrow(data1),]
        data1[nrow(data1),] <- to_change
    }
  }
  
  #Labeling first and second points of each street number in each side
  data1$xlabel <- paste(data1$num, "-", "p1") 
  data2$xlabel <- paste(data2$num, "-", "p1")
  cur_num <- 0
  occurred <- FALSE
  for (i in 1:nrow(data1)) { 
    if(occurred == FALSE && cur_num == 0){
        cur_num <- data1[i,]$num
        occurred <- TRUE
    }else if(occurred == TRUE){
        data1[i,]$xlabel <- paste(data1[i,]$num, "-", "p2")
        cur_num <- 0
        occurred <- FALSE
    }
  } 
  cur_num <- 0
  occurred <- FALSE
  for (i in 1:nrow(data2)) {
    if(occurred == FALSE && cur_num == 0){
        cur_num <- data2[i,]$num
        occurred <- TRUE
    }else if(occurred == TRUE){
        data2[i,]$xlabel <- paste(data2[i,]$num, "-", "p2")
        cur_num <- 0
        occurred <- FALSE
    }
  }
  numbers_to_show <- unique(append(data1$num, data2$num))
  #Pair values in side1 and odd values in side2
  cur_num <- 0
  occurred <- FALSE
  for (i in 1:nrow(data1)) { 
    if(data1[i,]$num %% 2 != 0){
        data1[i,]$num <- data1[i,]$num + 1
    }
    if(occurred == FALSE && cur_num == 0){
        cur_num <- data1[i,]$num
        occurred <- TRUE
    }else if(occurred == TRUE){
        data1[i,]$num <- data1[i,]$num + 2
        cur_num <- 0
        occurred <- FALSE
    }   
  }
  cur_num <- 0
  occurred <- FALSE
  for (i in 1:nrow(data2)) { 
    if(data2[i,]$num %% 2 == 0){
        data2[i,]$num <- data2[i,]$num + 1
    }
    if(occurred == FALSE && cur_num == 0){
        cur_num <- data2[i,]$num
        occurred <- TRUE
    }else if(occurred == TRUE){
        data2[i,]$num <- data2[i,]$num + 2
        cur_num <- 0
        occurred <- FALSE
    }
  }
  
  data1 <- data1 %>% mutate(xlabel = factor(xlabel, levels = xlabel))
  data1$mean <- mean(data1$V3)
  data2 <- data2 %>% mutate(xlabel = factor(xlabel, levels = xlabel))
  data2$mean <- mean(data2$V3)
  
  data <- rbind(data1, data2)
  data$side <- factor(data$side)
  
  mapping <- select(data, xlabel, side, V3, street, num, angle)
  
  labels_to_show <- select(filter(data, side=="Side 1"), xlabel)[[1]][c(1,3,5,7,9)]
  g1 <- ggplot(data, aes(x=num, y=V3, fill=side, group=side)) + ylim(c(0,7)) + geom_line() + geom_point(aes(shape = side, colour=side), size=2.5) + geom_errorbar(aes(ymin=V3-ci, ymax=V3+ci), colour="black", width=.1, position=pd) + geom_area(position = "identity", alpha = 0.7) + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1), plot.title = element_text(vjust=10)) + labs(x = "Street points", title = plotTitle, y = "Q-Score") + geom_hline(aes(yintercept=mean, color=side), linetype="dashed") + scale_x_continuous(limits=c(min(numbers_to_show)-10, max(numbers_to_show)+10), breaks=numbers_to_show, labels=labels_to_show) + geom_vline(data = data.frame(marks=numbers_to_show), aes(xintercept=marks), linetype="dashed") #+ scale_fill_grey() + scale_color_grey() #reorder(xlabel, num)
  multiplot(g1, cols=1)
  return (mapping)
}

```

De acordo com a heterogeneidade de cada rua (abaixo) vamos apresentar a discussão, a partir da próxima seção, da mais heterogênea para a mais homogênea.

```{r , echo=FALSE, warning=FALSE}
#GINI COEFFICIENTS
all_data$street <- factor(all_data$street, levels=unique(all_data$street))
inequalities <- data.frame( labels=c("Gini", "Entropy", "SD"), edesio=c(ineq(filter(all_data, street == "R._Edésio_Silva")$qscore, type="Gini"), ineq(filter(all_data, street == "R._Edésio_Silva")$qscore, type="entropy"), sd(filter(all_data, street == "R._Edésio_Silva")$qscore)), inacio=c(ineq(filter(all_data, street == "R._Inácio_Marquês_da_Silva")$qscore, type="Gini"), ineq(filter(all_data, street == "R._Inácio_Marquês_da_Silva")$qscore, type="entropy"), sd(filter(all_data, street == "R._Inácio_Marquês_da_Silva")$qscore)), maciel=c(ineq(filter(all_data, street == "R._Maciel_Pinheiro")$qscore, type="Gini"), ineq(filter(all_data, street == "R._Maciel_Pinheiro")$qscore, type="entropy"), sd(filter(all_data, street == "R._Maciel_Pinheiro")$qscore)), manoel=c(ineq(filter(all_data, street == "R._Manoel_Pereira_de_Araújo")$qscore, type="Gini"), ineq(filter(all_data, street == "R._Manoel_Pereira_de_Araújo")$qscore, type="entropy"), sd(filter(all_data, street == "R._Manoel_Pereira_de_Araújo")$qscore)), floriano=c(ineq(filter(all_data, street == "Av._Mal._Floriano_Peixoto")$qscore, type="Gini"), ineq(filter(all_data, street == "Av._Mal._Floriano_Peixoto")$qscore, type="entropy"), sd(filter(all_data, street == "Av._Mal._Floriano_Peixoto")$qscore)), cristina= c(ineq(filter(all_data, street == "R._Cristina_Procópio_Silva")$qscore, type="Gini"), ineq(filter(all_data, street == "R._Cristina_Procópio_Silva")$qscore, type="entropy"), sd(filter(all_data, street == "R._Cristina_Procópio_Silva")$qscore)) )

inequalities
```

O que procurar?

* Melhores e piores locais da rua
* Melhores e piores áreas da rua
* Melhores e piores áreas entre lados
* Ponto mais heterogeneo/homogeneo
* Descontinuidades no mesmo lado
* Descontinuidades no ponto


#Cristina Procópio

```{r results='asis', echo=FALSE, out.extra='', fig.height=10, fig.width=12, warning=FALSE}
best_folder <- "../percepcaoLocal/agradavel/melhores/intersects/"
worst_folder <- "../percepcaoLocal/agradavel/piores/intersects/"

mapping <- plot_ci_per_photo(filter(all_data, street == "R._Cristina_Procópio_Silva"), "Cristina Procopio", c(22, 45, 293, 315), c(135, 225))#Street 6 -> At number 436, 22 x 315 and 135 x 203
kable(mapping, format = "markdown")

show_street_data <- function (current_df, all_data, best_folder, worst_folder){
    color_space <- c("#000000", "#001900", "#003300", "#004c00", "#006600", "#007f00", "#009900", "#00b200", "#00cc00", "#00e500", "#00ff00")
    step <- (max(all_data$qscore) - min(all_data$qscore)) / length(color_space)
    thresholds <- seq(min(all_data$qscore), max(all_data$qscore), step)
    
    cat("<div class='row'>")
    angleData = c()
    for(i in 1:nrow(current_df)) {
      row <- current_df[i,]
      
      street <- as.character(row$street)
      photo_name <- as.character(row$photo_name)
      num <- row$num
      angle <- row$angle
      score <- row$qscore
      angleData <- append(angleData, score)
      
      color_index <- findInterval(score, thresholds)[1]
      if (color_index > length(color_space)){
         color_index <- length(color_space)
      }
      
        if (file.exists(paste(best_folder, photo_name, sep=""))){
        url <- paste(best_folder, photo_name, sep="")
      }else if (file.exists(paste(worst_folder, photo_name, sep=""))){
        url <- paste(worst_folder, photo_name, sep="")
      }else{
         url <- as.character(row$url)
      }
      
      cat(paste("<div class='col-xs-3' style=\"background-color:", color_space[color_index],"\">", sep=""))
      cat("<img src='", url,"' width='300px'>", sep = "")
      cat("<div class='caption' style=\"color:white\">", url, " -> ", score,  "</div>", sep="")
      cat("</div>")
      if (i > 1 && i %% 4 == 0){
        cat("</div>")
        cat("####### Sumário do Número ", num, ": Max. ", max(angleData), " Min: ", min(angleData), " Diff: ", max(angleData) - min(angleData))
        cat("<div class='row'>")
        angleData = c()
      }
    }
}

cristina <- filter(all_data, street == "R._Cristina_Procópio_Silva") %>% group_by(num) %>% arrange(street, num, angle) %>% select(url, photo_name, street, num, angle, qscore)
show_street_data(cristina, all_data, best_folder, worst_folder)

```

#Edésio Silva

```{r results='asis', echo=FALSE, out.extra='', fig.height=10, fig.width=12, warning=FALSE}
mapping <- plot_ci_per_photo(filter(all_data, street == "R._Edésio_Silva"), "Edésio Silva", c(22, 135), c(315, 203))#Street 1
kable(mapping, format = "markdown")

edesio <- filter(all_data, street == "R._Edésio_Silva") %>% group_by(num) %>% arrange(street, num, angle) %>% select(url, photo_name, street, num, angle, qscore)
show_street_data(edesio, all_data,  best_folder, worst_folder)

```

#Inácio Marques

```{r results='asis', echo=FALSE, out.extra='', fig.height=10, fig.width=12, warning=FALSE}
mapping <- plot_ci_per_photo(filter(all_data, street == "R._Inácio_Marquês_da_Silva"), "Inacio", c(203, 112, 90), c(293, 270, 22))#Street 2
kable(mapping, format = "markdown")

inacio <- filter(all_data, street == "R._Inácio_Marquês_da_Silva") %>% group_by(num) %>% arrange(street, num, angle) %>% select(url, photo_name, street, num, angle, qscore)
show_street_data(inacio, all_data,  best_folder, worst_folder)

```

#Floriano peixoto

```{r results='asis', echo=FALSE, out.extra='', fig.height=10, fig.width=12, warning=FALSE}
mapping <- plot_ci_per_photo(filter(all_data, street == "Av._Mal._Floriano_Peixoto"), "Floriano Peixoto", c(22,293), c(112,203))#Street 5
kable(mapping, format = "markdown")

floriano <- filter(all_data, street == "Av._Mal._Floriano_Peixoto") %>% group_by(num) %>% arrange(street, num, angle) %>% select(url, photo_name, street, num, angle, qscore)
show_street_data(floriano, all_data,  best_folder, worst_folder)

```

#Maciel Pinheiro

```{r results='asis', echo=FALSE, out.extra='', fig.height=10, fig.width=12, warning=FALSE}
mapping <- plot_ci_per_photo(filter(all_data, street == "R._Maciel_Pinheiro"), "Maciel Pinheiro", c(360, 90), c(270, 180))#Street 3
kable(mapping, format = "markdown")

maciel <- filter(all_data, street == "R._Maciel_Pinheiro") %>% group_by(num) %>% arrange(street, num, angle) %>% select(url, photo_name, street, num, angle, qscore)
show_street_data(maciel, all_data,  best_folder, worst_folder)

```

#Manoel Pereira

```{r results='asis', echo=FALSE, out.extra='', fig.height=10, fig.width=12, warning=FALSE}
mapping <- plot_ci_per_photo(filter(all_data, street == "R._Manoel_Pereira_de_Araújo"), "Manoel Pereira", c(22, 135, 293), c(315, 112, 203, 225))#Street 4
kable(mapping, format = "markdown")

manoel <- filter(all_data, street == "R._Manoel_Pereira_de_Araújo") %>% group_by(num) %>% arrange(street, num, angle) %>% select(url, photo_name, street, num, angle, qscore)
show_street_data(manoel, all_data,  best_folder, worst_folder)

```
