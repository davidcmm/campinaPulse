---
title: "compare_groups"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)

mergeSort <- function(x){
  if(length(x) == 1){
    inv <- 0
  } else {
    n <- length(x)
    n1 <- ceiling(n/2)
    n2 <- n-n1
    y1 <- mergeSort(x[1:n1])
    y2 <- mergeSort(x[n1+1:n2])
    inv <- y1$inversions + y2$inversions
    x1 <- y1$sortedVector
    x2 <- y2$sortedVector
    i1 <- 1
    i2 <- 1
    while(i1+i2 <= n1+n2+1){
      if(i2 > n2 || (i1 <= n1 && x1[i1] <= x2[i2])){
        x[i1+i2-1] <- x1[i1]
        i1 <- i1 + 1
      } else {
        inv <- inv + n1 + 1 - i1
        x[i1+i2-1] <- x2[i2]
        i2 <- i2 + 1
      }
    }
  }
  return (list(inversions=inv,sortedVector=x))
}

numberOfInversions <- function(x){
  r <- mergeSort(x)
  return (r$inversions)
}

normalizedKendallTauDistance2 <- function(data1, data2){
  x <- data1
  y <- data2
  
  tau = numberOfInversions(order(x)[rank(y)])
  print(tau)
  nItens = length(x)
  maxNumberOfInverstions <- (nItens*(nItens-1))/2
  normalized = tau/maxNumberOfInverstions

  print (normalized)
}

#Reading CrowdFlower features data
dadosg1 <- read.csv("../regressao100/g1.csv")
dadosg2 <- read.csv("../regressao100/g2.csv")
dadosg3 <- read.csv("../regressao100/g3.csv")
dadosg4 <- read.csv("../regressao100/g4.csv")
dadosg5 <- read.csv("../regressao100/g5.csv")
dadosg6 <- read.csv("../regressao100/g6.csv")
dadosg7 <- read.csv("../regressao100/g7.csv")
dadosg8 <- read.csv("../regressao100/g8.csv")
dadosg9 <- read.csv("../regressao100/g9.csv")
dadosg10 <- read.csv("../regressao100/g10.csv")
dadosg11 <- read.csv("../regressao100/g11.csv")
dadosg12 <- read.csv("../regressao100/g12.csv")
dadosg13 <- read.csv("../regressao100/g13.csv")

#Summing features values  - left and right
somaValores <- function(dados1, dados2, desvio1, desvio2, uplimit){
    dados1[is.na(dados1)] <- 0
    dados2[is.na(dados2)] <- 0
    
    soma = dados1 + dados2
    desvios = (desvio1 + desvio2)/2
    
    desvio = sd(soma)
        soma <- ifelse(soma < 0, 0, soma)
        soma <- ifelse(soma > uplimit, uplimit, soma)
        return (mean(soma))
}

#Mean of features values - left and right
mediaValores <- function(dados1, dados2, desvio1, desvio2, uplimit){
   for (i in 1:length(dados1)){
       if(is.na(dados1[i])){
         dados1[i] <- dados2[i]
       }
       if(is.na(dados2[i])){
         dados2[i] <- dados1[i]
       }
    }
    
    soma = (dados1 + dados2) / 2
    desvios = (desvio1 + desvio2)/2
    
    desvio = sd(soma)
        soma <- ifelse(soma < 0, 0, soma)
        soma <- ifelse(soma > uplimit, uplimit, soma)
        return (mean(soma))
}


#Creating values for the cases where only 1 answer was obtained considering the desviations of other features answers
geraValores <- function(lista, question, desvios, uplimit){
   #desvio = sd(lista)
   return (mean(lista, na.rm = TRUE))
}

Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

#Grouping by image and question - G1
by_image <- group_by(dadosg1, image_url)
desvios <- summarise (by_image, 
                  sd1 = sd(question1, na.rm = TRUE),
                  sd2l = sd(question2__left_side, na.rm = TRUE),
                  sd2r = sd(question2__right_side, na.rm = TRUE),
                  sd3 = sd(question3, na.rm = TRUE) )
groupedData1 <- summarise(by_image,
  #count = n(),
  q1 = geraValores(question1, "1", desvios, 100),
  #sdq1 = sd(question1, na.rm = TRUE),
  q2 = mediaValores(question2__left_side, question2__right_side, desvios$sd2l, desvios$sd2r, 100),
  q2_left = geraValores(question2__left_side, "2l", desvios, 100),
  #sdq2_left = sd(question2__left_side, na.rm = TRUE),
  q2_right = geraValores(question2__right_side, "2r", desvios, 100),
  #sdq2_right = sd(question2__right_side, na.rm = TRUE),
  q3 = geraValores(question3, "3", desvios, 100)
  #sdq3 = sd(question3, na.rm = TRUE) 
  )

#Grouping by image and question- G2
by_image <- group_by(dadosg2, image_url)
desvios <- summarise (by_image, 
                  sd1 = sd(question1, na.rm = TRUE),
                  sd2l = sd(question2__left_side, na.rm = TRUE),
                  sd2r = sd(question2__right_side, na.rm = TRUE),
                  sd3 = sd(question3, na.rm = TRUE) )
groupedData2 <- summarise(by_image,
  count = n(),
  q1 = geraValores(question1, "1", desvios, 100),
  #sdq1 = sd(question1, na.rm = TRUE),
  q2 = somaValores(question2__left_side, question2__right_side, desvios$sd2l, desvios$sd2r, 200),
  q2_left = geraValores(question2__left_side, "2l", desvios, 100),
  #sdq2_left = sd(question2__left_side, na.rm = TRUE),
  q2_right = geraValores(question2__right_side, "2r", desvios, 100),
  #sdq2_right = sd(question2__right_side, na.rm = TRUE),
  q3 = geraValores(question3, "3", desvios, 100)
  #sdq3 = sd(question3, na.rm = TRUE) 
  )

#Grouping by image and question - G3
by_image <- group_by(dadosg3, image_url)
desvios <- summarise (by_image, 
                  sd1l = sd(question1__left_side, na.rm = TRUE),
                  sd1r = sd(question1__right_side, na.rm = TRUE),
                  sd2l = sd(question2__left_side, na.rm = TRUE),
                  sd2r = sd(question2__right_side, na.rm = TRUE),
                  sd3l = sd(question3__left_side, na.rm = TRUE),
                  sd3r = sd(question3__right_side, na.rm = TRUE) )
groupedData3 <- summarise(by_image,
  count = n(),
  q1 = mediaValores(question1__left_side, question1__right_side, desvios$sd1l, desvios$sd1r, 5),
  q1_left = geraValores(question1__left_side, "1l", desvios, 5),
  #sdq1_left = sd(question1__left_side, na.rm = TRUE),
  q1_right = geraValores(question1__right_side, "1r", desvios, 5),
  #sdq1_right = sd(question1__right_side, na.rm = TRUE),
  q2 = mediaValores(question2__left_side, question2__right_side, desvios$sd2l, desvios$sd2r, 5),
  q2_left = geraValores(question2__left_side, "2l", desvios, 5),
  #sdq2_left = sd(question2__left_side, na.rm = TRUE),
  q2_right = geraValores(question2__right_side, "2r", desvios, 5),
  #sdq2_right = sd(question2__right_side, na.rm = TRUE),
  q3 = mediaValores(question3__left_side, question3__right_side, desvios$sd3l, desvios$sd3r, 5),
  q3_left = geraValores(question3__left_side, "3l", desvios, 5),
  #sdq3_left = sd(question3__left_side, na.rm = TRUE),
  q3_right = geraValores(question3__right_side, "3r", desvios, 5)
  #sdq3_right = sd(question3__right_side, na.rm = TRUE)  
  )

#Grouping by image and question - G4
by_image <- group_by(dadosg4, image_url)
desvios <- summarise (by_image, 
                  sd1 = sd(question1, na.rm = TRUE),
                  sd2 = sd(question2, na.rm = TRUE))
groupedData4 <- summarise(by_image,
  count = n(),
  q1 = geraValores(question1, "1", desvios, 10),
  #sdq1 = sd(question1, na.rm = TRUE),
  q2 = geraValores(question2, "2", desvios, 10)
  #sdq2 = sd(question2, na.rm = TRUE) 
  )

#Grouping by image and question - G5
by_image <- group_by(dadosg5, image_url)
desvios <- summarise (by_image, 
                  sd1 = sd(question1, na.rm = TRUE),
                  sd2 = sd(your_answer_is, na.rm = TRUE))
groupedData5 <- summarise(by_image,
  count = n(),
  q1 = geraValores(question1, "1", desvios, 20),
  #sdq1 = sd(question1, na.rm = TRUE),
  q2 = geraValores(your_answer_is, "2", desvios, 20)
  #sdq2 = sd(question2, na.rm = TRUE) 
  )

#Grouping by image and question - G6
by_image <- group_by(dadosg6, image_url)
desvios <- summarise (by_image, 
                  sd1l = sd(question1__left_side, na.rm = TRUE),
                  sd1r = sd(question1__right_side, na.rm = TRUE),
                  sd2l = sd(question2__left_side, na.rm = TRUE),
                  sd2r = sd(question2__right_side, na.rm = TRUE) )
groupedData6 <- summarise(by_image,
  count = n(),
  q1 = mediaValores(question1__left_side, question1__right_side, desvios$sd1l, desvios$sd1r, 1),
  q1_left = geraValores(question1__left_side, "1l", desvios, 1),
  #sdq1_left = sd(question1__left_side, na.rm = TRUE),
  q1_right = geraValores(question1__right_side, "1r", desvios, 1),
  #sdq1_right = sd(question1__right_side, na.rm = TRUE),
  q2 = mediaValores(question2__left_side, question2__right_side, desvios$sd2l, desvios$sd2r, 1),
  q2_left = geraValores(question2__left_side, "2l", desvios, 1),
  #sdq2_left = sd(question2__left_side, na.rm = TRUE),
  q2_right = geraValores(question2__right_side, "2r", desvios, 1)
  #sdq2_right = sd(question2__right_side, na.rm = TRUE) 
  )

#Grouping by image and question - G7
by_image <- group_by(dadosg7, image_url)
desvios <- summarise (by_image, 
                  sd1 = sd(question1, na.rm = TRUE),
                  sd2 = sd(question2, na.rm = TRUE),
                  sd3l = sd(question3__left_side, na.rm = TRUE),
                  sd3r = sd(question3__right_side, na.rm = TRUE) )
groupedData7 <- summarise(by_image,
  count = n(),
  q1 = geraValores(question1, "1", desvios, 3),
  #sdq1 = sd(question1, na.rm = TRUE),
  q2 = geraValores(question2, "2", desvios, 1),
  #sdq2 = sd(question2, na.rm = TRUE),
  q3 = mediaValores(question3__left_side, question3__right_side, desvios$sd3l, desvios$sd3r, 1),
  q3_left = geraValores(question3__left_side, "3l", desvios, 1),
  #sdq3_left = sd(question3__left_side, na.rm = TRUE),
  q3_right = geraValores(question3__right_side, "3r", desvios, 1)
  #sdq3_right = sd(question3__right_side, na.rm = TRUE)  
  )

#Grouping by image and question - G8
by_image <- group_by(dadosg8, image_url)
desvios <- summarise (by_image, 
                  sd1 = sd(question1, na.rm = TRUE),
                  sd2l = sd(question2__left_side, na.rm = TRUE),
                  sd2r = sd(question2_right_side, na.rm = TRUE),
                  sd3l = sd(question3__left_side, na.rm = TRUE),
                  sd3r = sd(question3_right_side, na.rm = TRUE)
                  )
groupedData8 <- summarise(by_image,
  count = n(),
  q1 = Mode(question1),
  #sdq1 = sd(question1, na.rm = TRUE),
  q2 = somaValores(question2__left_side, question2_right_side, desvios$sd2l, desvios$sd2r, 40),
  q2_left = geraValores(question2__left_side, "2l", desvios, 20),
  #sdq2_left = sd(question2__left_side, na.rm = TRUE),
  q2_right = geraValores(question2_right_side, "2r", desvios, 20),
  #sdq2_right = sd(question2__right_side, na.rm = TRUE)  
  q3 = somaValores(question3__left_side, question3_right_side, desvios$sd3l, desvios$sd3r, 40),
  q3_left = geraValores(question3__left_side, "3l", desvios, 20),
  q3_right = geraValores(question3_right_side, "3r", desvios, 20)
  )

#Grouping by image and question - G9
by_image <- group_by(dadosg9, image_url)
desvios <- summarise (by_image, 
                  sd1l = sd(question1__left_side, na.rm = TRUE),
                  sd1r = sd(question1__right_side, na.rm = TRUE) )
groupedData9 <- summarise(by_image,
  count = n(),
  q1 = mediaValores(question1__left_side, question1__right_side, desvios$sd1l, desvios$sd1r, 200),
  q1_left = geraValores(question1__left_side, "1l", desvios, 200),
  #sdq1_left = sd(question1__left_side, na.rm = TRUE),
  q1_right = geraValores(question1__right_side, "1r", desvios, 200)
  #sdq1_right = sd(question1__right_side, na.rm = TRUE)  
  )

#Grouping by image and question - G10
by_image <- group_by(dadosg10, image_url)
desvios <- summarise (by_image, 
                  sd1 = sd(question1, na.rm = TRUE),
                  sd2 = sd(question2, na.rm = TRUE),
                  sd3 = sd(question3, na.rm = TRUE))
groupedData10 <- summarise(by_image,
  count = n(),
  q1 = Mode(x = question1),
  #sdq1 = sd(question1, na.rm = TRUE),
  q2 = geraValores(question2, "2", desvios, 50),
  #sdq2 = sd(question2, na.rm = TRUE),
  q3 = geraValores(question3, "3", desvios, 1)
  #sdq3 = sd(question3, na.rm = TRUE)  
  )

#Grouping by image and question - G11
by_image <- group_by(dadosg11, image_url)
desvios <- summarise (by_image, 
                  sd2l = sd(question2__left_side, na.rm = TRUE),
                  sd2r = sd(question2__right_side, na.rm = TRUE),
                  sd3l = sd(question3__left_side, na.rm = TRUE),
                  sd3r = sd(question3__right_side, na.rm = TRUE) )
groupedData11 <- summarise(by_image,
  count = n(),
  q2 = somaValores(question2__left_side, question2__right_side, desvios$sd2l, desvios$sd2r, 20),
  q2_left = geraValores(question2__left_side, "2l", desvios, 10),
  #sdq2_left = sd(question2__left_side, na.rm = TRUE),
  q2_right = geraValores(question2__right_side, "2r", desvios, 10),
  #sdq2_right = sd(question2__right_side, na.rm = TRUE),
  q3 = somaValores(question3__left_side, question3__right_side, desvios$sd3l, desvios$sd3r, 80),
  q3_left = geraValores(question3__left_side, "3l", desvios, 40),
  #sdq3_left = sd(question3__left_side, na.rm = TRUE),
  q3_right = geraValores(question3__right_side, "3r", desvios, 40)
  #sdq3_right = sd(question3__right_side, na.rm = TRUE)  
  )

#Grouping by image and question - G12
by_image <- group_by(dadosg12, image_url)
desvios <- summarise (by_image, 
                  sd1 = sd(question1, na.rm = TRUE),
                  sd2l = sd(question2__left_side, na.rm = TRUE),
                  sd2r = sd(question2__right_side, na.rm = TRUE),
                  sd3 = sd(question3, na.rm = TRUE))
groupedData12 <- summarise(by_image,
  count = n(),
  q1 = geraValores(question1, "1", desvios, 10),
  #sdq1 = sd(question1, na.rm = TRUE),
  q2 = somaValores(question2__left_side, question2__right_side, desvios$sd2l, desvios$sd2r, 20),
  q2_left = geraValores(question2__left_side, "2l", desvios, 10),
  #sdq2_left = sd(question2__left_side, na.rm = TRUE),
  q2_right = geraValores(question2__right_side, "2r", desvios, 10),
  #sdq2_right = sd(question2__right_side, na.rm = TRUE),
  q3 = geraValores(question3, "3", desvios,10)
  #sdq3 = sd(question3, na.rm = TRUE)  
  )

#Grouping by image and question - G13
by_image <- group_by(dadosg13, image_url)
desvios <- summarise (by_image, 
                  sd1l = sd(question1__left_side, na.rm = TRUE),
                  sd1r = sd(question1__right_side, na.rm = TRUE),
                  sd2l = sd(question2__left_side, na.rm = TRUE),
                  sd2r = sd(question2__right_side, na.rm = TRUE) )
groupedData13 <- summarise(by_image,
  count = n(),
  q1 = somaValores(question1__left_side, question1__right_side, desvios$sd1l, desvios$sd1r, 30),
  q1_left = geraValores(question1__left_side, "1l", desvios, 10),
  #sdq1_left = sd(question1__left_side, na.rm = TRUE),
  q1_right = geraValores(question1__right_side, "1r", desvios, 15),
  #sdq1_right = sd(question1__right_side, na.rm = TRUE),
  q2 = mediaValores(question2__left_side, question2__right_side, desvios$sd2l, desvios$sd2r, 1),
  q2_left = geraValores(question2__left_side, "2l", desvios, 1),
  #sdq2_left = sd(question2__left_side, na.rm = TRUE),
  q2_right = geraValores(question2__right_side, "2r", desvios, 1)
  #sdq2_right = sd(question2__right_side, na.rm = TRUE) 
  )

#Renaming columns according to a fixed id
renomeiaGrupos <- function(dadosPorGrupo, listaColunas, idGrupo) {
    for (coluna in listaColunas){
        colnames(dadosPorGrupo)[colnames(dadosPorGrupo) == coluna] <- paste(idGrupo, coluna, sep="")
    }
    return(dadosPorGrupo)
}

renomeiaGrupos2 <- function(dadosPorGrupo, listaColunas, novosNomes) {
    for (i in seq(1, length(listaColunas))){
        coluna = listaColunas[i]
        colnames(dadosPorGrupo)[colnames(dadosPorGrupo) == coluna] <- novosNomes[i]
    }
    return(dadosPorGrupo)
}

groupedData1 <- renomeiaGrupos(groupedData1, c("q2_left", "q2_right", "count"), "g1")
groupedData2 <- renomeiaGrupos(groupedData2, c("q2_left", "q2_right", "count"), "g2")
groupedData3 <- renomeiaGrupos(groupedData3, c("q1_left", "q1_right","q2_left", "q2_right","q3_left", "q3_right", "count"), "g3")
groupedData4 <- renomeiaGrupos(groupedData4, c("count"), "g4")
groupedData5 <- renomeiaGrupos(groupedData5, c("count"), "g5")
groupedData6 <- renomeiaGrupos(groupedData6, c("q1_left", "q1_right", "q2_left", "q2_right", "count"), "g6")
groupedData7 <- renomeiaGrupos(groupedData7, c("q3_left", "q3_right", "count"), "g7")
groupedData8 <- renomeiaGrupos(groupedData8, c("q2_left", "q2_right","q3_left", "q3_right", "count"), "g8")
groupedData9 <- renomeiaGrupos(groupedData9, c("q1_left", "q1_right", "count"), "g9")
groupedData10 <- renomeiaGrupos(groupedData10, c("count"), "g10")
groupedData11 <- renomeiaGrupos(groupedData11, c("q2_left", "q2_right","q3_left", "q3_right", "count"), "g11")
groupedData12 <- renomeiaGrupos(groupedData12, c("q2_left", "q2_right", "count"), "g12")
groupedData13 <- renomeiaGrupos(groupedData13, c("q1_left", "q1_right", "q2_left", "q2_right", "count"), "g13")

groupedData1 <- renomeiaGrupos2(groupedData1, c("q1", "q2", "q3"), c("street_wid", "sidewalk_wid", "public_art"))
groupedData2 <- renomeiaGrupos2(groupedData2, c("q1", "q2", "q3"), c("mov_cars", "park_cars", "mov_ciclyst"))
groupedData3 <- renomeiaGrupos2(groupedData3, c("q1", "q2", "q3"), c("debris", "pavement", "landscape"))
groupedData4 <- renomeiaGrupos2(groupedData4, c("q1", "q2"), c("courtyards", "major_landsc"))
groupedData5 <- renomeiaGrupos2(groupedData5, c("q1", "q2"), c("build_ident", "build_nrectan"))
groupedData6 <- renomeiaGrupos2(groupedData6, c("q1", "q2"), c("prop_street_wall", "prop_wind"))
groupedData7 <- renomeiaGrupos2(groupedData7, c("q1", "q2", "q3"), c("long_sight", "prop_sky_ahead", "prop_sky_across"))
groupedData8 <- renomeiaGrupos2(groupedData8, c("q1", "q2", "q3"), c("graffiti", "trees", "small_planters"))
groupedData9 <- renomeiaGrupos2(groupedData9, c("q1"), c("build_height"))
groupedData10 <- renomeiaGrupos2(groupedData10, c("q1", "q2", "q3"), c("build_diff_ages", "diff_build", "prop_hist_build"))
groupedData11 <- renomeiaGrupos2(groupedData11, c("q2", "q3"), c("outdoor_table", "street_furnit"))
groupedData12 <- renomeiaGrupos2(groupedData12, c("q1", "q2", "q3"), c("basic_col", "lights", "accent_col"))
groupedData13 <- renomeiaGrupos2(groupedData13, c("q1","q2"), c("people", "prop_active_use"))
```

## Comparing original groups x randomized groups!
```{r cars}
  masc_files <- list.files(path = ".", pattern = "allMasculinoOrdInter*")
  fem_files <- list.files(path = ".", pattern = "allFemininoOrdInter*")
  
  masc_original <- read.table("../all100/allMasculinoOrdInter.dat")
  fem_original <- read.table("../all100/allFemininoOrdInter.dat")
  ag_orig_m <- filter(masc_original, V1 != "seguro?")
  seg_orig_m <- filter(masc_original, V1 == "seguro?")
  ag_orig_f <- filter(fem_original, V1 != "seguro?")
  seg_orig_f <- filter(fem_original, V1 == "seguro?")
  
  all_means_ag_m <- data.frame()
  all_means_seg_m <- data.frame()
  all_means_ag_f <- data.frame()
  all_means_seg_f <- data.frame()
  
  sink("rank_comparisons.dat")
  #for (current_file in masc_files){
  for (i in seq(1, 100)){
  
     #id <- strsplit(strsplit(current_file, "_")[[1]][2], "\\.")[[1]][1]
     print(paste("########### Iteration ", i))
     men_file <- masc_files[i]
     women_file <- fem_files[i]
    
    #Comparing men random x men original
     #data <- read.table(current_file)
     data_m <- read.table(men_file)
     seg_m <- filter(data_m, V1 == "seguro?")
     ag_m <- filter(data_m, V1 != "seguro?")
     
     merged_m <- merge(ag_orig_m, ag_m, by.x="V2", by.y="V2")
     merged_seg_m <- merge(seg_orig_m, seg_m, by.x="V2", by.y="V2")
     
     print(paste(">>>>>>> Kendall distance Agrad: Men Old x Men Random", normalizedKendallTauDistance2(merged_m$V3.y, merged_m$V3.x)))
     res <- cor.test(merged_m$V3.y, merged_m$V3.x, method="kendall")
     print(res)
     print(paste(">>>>>>>> Correlation Agrad: Men Old x Men Random", res$estimate))
     print(paste(">>>>>>> Kendall distance Seg: Men Old x Men Random", normalizedKendallTauDistance2(merged_seg_m$V3.y, merged_seg_m$V3.x)))
     res <- cor.test(merged_seg_m$V3.y, merged_seg_m$V3.x, method="kendall")
     print(res)
     print(paste(">>>>>>>> Correlation Seg: Men Old x Men Random", res$estimate))
     
     #Looking for corresponding data from women
     #current_other <- read.table(paste("allFemininoOrdInter_", id, ".dat", sep = ""))
     #other_seg_data <- filter(current_other, V1 == "seguro?")
     #other_ag_data <- filter(current_other, V1 != "seguro?")
     
     #Comparing women random x women original
     #merged <- merge(other_ag_data, ag_data, by.x="V2", by.y="V2")
     #merged_seg <- merge(other_seg_data, seg_data, by.x="V2", by.y="V2")
     data_f <- read.table(women_file)
     seg_f <- filter(data_f, V1 == "seguro?")
     ag_f <- filter(data_f, V1 != "seguro?")
     
     merged_f <- merge(ag_orig_f, ag_f, by.x="V2", by.y="V2")
     merged_seg_f <- merge(seg_orig_f, seg_f, by.x="V2", by.y="V2")
    
     print(paste(">>>>>>> Kendall distance Agrad: Women Fixed x Women Random", normalizedKendallTauDistance2(merged_f$V3.y, merged_f$V3.x)))
     res <- cor.test(merged_f$V3.y, merged_f$V3.x, method="kendall")
     print(res)
     print(paste(">>>>>>>> Correlation Agrad: Women Fixed x Women Random", res$estimate))
     print(paste(">>>>>>> Kendall distance Seg: Women Fixed x Women Random", normalizedKendallTauDistance2(merged_seg_f$V3.y, merged_seg_f$V3.x)))
     res <- cor.test(merged_seg_f$V3.y, merged_seg_f$V3.x, method="kendall")
     print(res)
     print(paste(">>>>>>>> Correlation Seg: Women Fixed x Women Random", res$estimate))
     
     #Comparing women random x men random
     merged <- merge(ag_m, ag_f, by.x="V2", by.y="V2")
     merged_seg <- merge(seg_m, seg_f, by.x="V2", by.y="V2")
     
     print(paste(">>>>>>> Kendall distance Agrad: Women Random x Men Random", normalizedKendallTauDistance2(merged$V3.y, merged$V3.x)))
     res <- cor.test(merged$V3.y, merged$V3.x, method="kendall")
     print(res)
     print(paste(">>>>>>>> Correlation Agrad: Women Random x Men Random", res$estimate))
     print(paste(">>>>>>> Kendall distance Seg: Women Random x Men Random", normalizedKendallTauDistance2(merged_seg$V3.y, merged_seg$V3.x)))
     res <- cor.test(merged_seg$V3.y, merged_seg$V3.x, method="kendall")
     print(res)
     print(paste(">>>>>>>> Correlation Seg: Women Random x Men Random", res$estimate))
     
     #Storing all means
     if(length(all_means_ag_m) == 0){
       all_means_ag_m <- select(ag_m, V1, V2, V3)
       all_means_seg_m <- select(seg_m, V1, V2, V3)
       all_means_ag_f <- select(ag_f, V1, V2, V3)
       all_means_seg_f <- select(seg_f, V1, V2, V3)
     }else{
        all_means_ag_m <- merge(all_means_ag_m, select(ag_m, V2, V3), by.x="V2", by.y="V2")
        all_means_seg_m <- merge(all_means_seg_m, select(seg_m, V2, V3), by.x="V2", by.y="V2")
        all_means_ag_f <- merge(all_means_ag_f, select(ag_f, V2, V3), by.x="V2", by.y="V2")
        all_means_seg_f <- merge(all_means_seg_f, select(seg_f, V2, V3), by.x="V2", by.y="V2")
     }
  }
  sink()

#Testing regressions for men
all_means_ag$mean <- apply(all_means_ag[,3:ncol(all_means_ag)], 1, mean)
all_means_seg$mean <- apply(all_means_seg[,3:ncol(all_means_seg)], 1, mean)

combineFeaturesAndTestRegression(all_means_ag)
combineFeaturesAndTestRegression(all_means_seg)

#Evaluating confidence intervals for computed kendall correlations
for (file in c("tau_mw_agrad.dat", "tau_mw_seg.dat")){
  ag_cor <- read.table(file, sep="")
  ag_cor$V2 <- as.factor(ag_cor$V2)
  #values <- lapply(as.character(ag_cor$V2), function (x) as.double(str_split(x, pattern = "Random")[[1]][2]))
  values <- lapply(as.character(ag_cor$V2), function (x) as.double(str_split(x, pattern = " ")[[1]][9]))
  new_values <- unlist(lapply(values, '[[', 1))
  ag_cor$value <- new_values
  
  print(paste(">>>> ", file))
  delta <- ic(ag_cor$value)
  print(paste(mean(ag_cor$value), delta, mean(ag_cor$value) - delta, mean(ag_cor$value) + delta))
  print(sample_size(ag_cor$value))
}
```


## Comparing all participants together in original data and removing some users!
```{r cars}
all_diff_m <- list.files(path = "hom40_mul60/", pattern = "allDiffMasFem_*")

all_original <- read.table("../all100/all_ordenado.dat")
ag_orig <- filter(all_original, V1 != "seguro?")
seg_orig <- filter(all_original, V1 == "seguro?")

all_means_ag_m <- data.frame()
all_means_seg_m <- data.frame()

sink("hom40_mul60/rank_comparisons_general.dat")
for (i in seq(1,100)){
#for (current_file in all_diff_m){
   #id <- strsplit(strsplit(current_file, "_")[[1]][2], "\\.")[[1]][1]
   print(paste("########### Iteration ", i))
   
    #General ranking removing men
   current_file <- paste("hom40_mul60/", all_diff_m[i], sep="")
   data <- read.table(current_file)
   seg_m <- filter(data, V1 == "seguro?")
   ag_m <- filter(data, V1 != "seguro?")
   
   merged_m <- merge(ag_orig, ag_m, by.x="V2", by.y="V2")
   merged_seg_m <- merge(seg_orig, seg_m, by.x="V2", by.y="V2")
   
   print(paste(">>>>>>> Kendall distance Agrad: General Old x Removing Men and Women Random", normalizedKendallTauDistance2(merged_m$V3.y, merged_m$V3.x)))
   res <- cor.test(merged_m$V3.y, merged_m$V3.x, method="kendall")
   print(res)
   print(paste(">>>>>>>> Correlation Agrad: General Old x Removing Men and Women Random", res$estimate))
   print(paste(">>>>>>> Kendall distance Seg: General Old x Removing Men and Women Random", normalizedKendallTauDistance2(merged_seg_m$V3.y, merged_seg_m$V3.x)))
   res <- cor.test(merged_seg_m$V3.y, merged_seg_m$V3.x, method="kendall")
   print(res)
   print(paste(">>>>>>>> Correlation Seg: General Old x Removing Men and Women Random", res$estimate))
   
   #Storing all means
   if(length(all_means_ag_m) == 0){
     all_means_ag_m <- select(ag_m, V1, V2, V3)
     all_means_seg_m <- select(seg_m, V1, V2, V3)
   }else{
      all_means_ag_m <- merge(all_means_ag_m, select(ag_m, V2, V3), by.x="V2", by.y="V2")
      all_means_seg_m <- merge(all_means_seg_m, select(seg_m, V2, V3), by.x="V2", by.y="V2")
   }
}
sink()

all_means_ag_m$mean <- apply(all_means_ag_m[,3:ncol(all_means_ag_m)], 1, mean)
all_means_seg_m$mean <- apply(all_means_seg_m[,3:ncol(all_means_seg_m)], 1, mean)

#Combining all street features
combineFeaturesAndTestRegression <- function(dataset){
  
    colnames(dataset)[colnames(dataset) == "V2"] <- "image_url"
    temp <- merge(groupedData1, dataset, by.x="image_url", by.y="image_url")
    temp <- merge(temp, groupedData2, by.x="image_url", by.y="image_url")
    temp <- merge(temp, groupedData3, by.x="image_url", by.y="image_url")
    temp <- merge(temp, groupedData4, by.x="image_url", by.y="image_url")
    temp <- merge(temp, groupedData5, by.x="image_url", by.y="image_url")
    temp <- merge(temp, groupedData6, by.x="image_url", by.y="image_url")
    temp <- merge(temp, groupedData7, by.x="image_url", by.y="image_url")
    temp <- merge(temp, groupedData8, by.x="image_url", by.y="image_url")
    temp<- merge(temp, groupedData9, by.x="image_url", by.y="image_url")
    temp <- merge(temp, groupedData10, by.x="image_url", by.y="image_url")
    temp <- merge(temp, groupedData11, by.x="image_url", by.y="image_url")
    temp <- merge(temp, groupedData12, by.x="image_url", by.y="image_url")
    temp <- merge(temp, groupedData13, by.x="image_url", by.y="image_url")
    
    temp1 <- lapply(as.character(temp$image_url), function (x) strsplit(x, split="/", fixed=TRUE)[[1]][6])
    neigs1 <- unlist(lapply(temp1, '[[', 1))
    temp$bairro <- neigs1
    
    temp <- arrange(temp, mean)  %>% mutate(rank = 1:n())
    temp$centro <- 0
    temp$catole <- 0
    temp$liberdade <- 0
    temp$centro[temp$bairro == "centro"] <- 1
    temp$catole[temp$bairro == "catole"] <- 1
    temp$liberdade[temp$bairro == "liberdade"] <- 1
    temp$graffiti <- factor(temp$graffiti, levels = c("Yes", "No"))
    temp$graffiti <- relevel(temp$graffiti,  "No")
    
    regGeneral <- lm(rank ~  street_wid + mov_cars + park_cars + mov_ciclyst + landscape + build_ident + trees + log2(build_height+1) + people + centro + catole + liberdade + diff_build + graffiti, na.action = na.exclude, data = temp)
    summary(regGeneral)
}

combineFeaturesAndTestRegression(all_means_ag_m)
combineFeaturesAndTestRegression(all_means_seg_m)

#Evaluating sample sizes
library(stringr)
source("../analisaICPorFoto.R")
sample_size <- function(x) { 
  	return ( ( ( sd(x) * qnorm(1-(0.05/2)) )  / ( 0.05 * mean(x) ) ) ** 2)  #95% confidence interval, significance level of 0.05 (alpha) - sample 100
  }
for (file in c("taug_men_agrad.dat", "taug_men_seg.dat")){
  ag_cor <- read.table(file, sep="")
  ag_cor$V2 <- as.factor(ag_cor$V2)
  values <- lapply(as.character(ag_cor$V2), function (x) as.double(str_split(x, pattern = "Random")[[1]][2]))
  new_values <- unlist(lapply(values, '[[', 1))
  ag_cor$value <- new_values
  
  print(paste(">>>> ", file))
  delta <- ic(ag_cor$value)
  print(paste(mean(ag_cor$value), delta, mean(ag_cor$value) - delta, mean(ag_cor$value) + delta))
  print(sample_size(ag_cor$value))
}
```