---
title: "RoyalSociety"
output: pdf_document
---

#Reading data
```{r, echo=FALSE, fig.show='asis', fig.width=10, fig.height=5}
library(ggplot2)
library(gridExtra)
library(dplyr)
library(texreg)
library(spdep)
library(reshape)
source("analisaICPorFoto.R")
source("convertKendallSummary.R")

facet_names <- list(
  'agrad%C3%A1vel?'="Pleasantness",
  'seguro?'="Safety"
)

facet_labeller <- function(variable,value){
  return(facet_names[value])
}

#dados <- read.table("geral.dat", header=TRUE)
dados <- read.table("geralSetoresAJ.dat", header=TRUE)

#Intervalo de confianÃ§a por ponto
temp <- dados
qscoreSim <- temp [ c(4:103) ]
icData <- apply(qscoreSim, 1, ic)
temp$distance <- icData

#Subset of columns
dadosSub <- temp[, c("V2", "V1", "V3", "diag", "hor", "vert", "red", "green", "blue", "grupo", "bairro", "distance", "setor")]

novosDados <- reshape(dadosSub, timevar="grupo", idvar=c("V2", "V1", "diag", "hor", "vert", "red", "green", "blue", "bairro", "setor"), direction="wide")

#Copia com todos os dados
#dadosCopy <- temp[, c("V2", "V1", "V3", "diag", "hor", "vert", "red", "green", "blue", "grupo", "bairro")]
```


#Urban Elements
```{r, echo=FALSE, fig.show='asis', fig.width=10, fig.height=5}
#Split image url data and return neighborhood and place
substituiURL <- function(dadosPorGrupo){
    localData <- lapply(as.character(dadosPorGrupo$image_url), function (x) paste(strsplit(x, split="/", fixed=TRUE)[[1]][6], "/", strsplit(x, split="/", fixed=TRUE)[[1]][7], sep=""))
    local <- unlist(lapply(localData, '[[', 1))
    return (local)
}

#Returns lat and longitude from file data
getLatLong <- function(data, fileWithCoord) {
  coord <- read.table(fileWithCoord, sep="+", header=F)#V4 and V5 -> lat and long; V2 street
  data$lat <- 0
  data$long <- 0
  
  for (i in 1:nrow(coord)){
    row <- coord[i,]
    for (j in 1:nrow(data)){
      if(length(grep(row$V2, data[j,]$image_url)) > 0){
        data[j,]$lat <- row$V4
        data[j,]$long <- row$V5
      }  
    }
  }
  return (data)
}


#Reading CrowdFlower features data
dadosg1 <- read.csv("regressao100/g1.csv")
dadosg1$image_url <- substituiURL(dadosg1)

dadosg2 <- read.csv("regressao100/g2.csv")
dadosg2$image_url <- substituiURL(dadosg2)

dadosg3 <- read.csv("regressao100/g3.csv")
dadosg3$image_url <- substituiURL(dadosg3)

dadosg4 <- read.csv("regressao100/g4.csv")
dadosg4$image_url <- substituiURL(dadosg4)

dadosg5 <- read.csv("regressao100/g5.csv")
dadosg5$image_url <- substituiURL(dadosg5)

dadosg6 <- read.csv("regressao100/g6.csv")
dadosg6$image_url <- substituiURL(dadosg6)

dadosg7 <- read.csv("regressao100/g7.csv")
dadosg7$image_url <- substituiURL(dadosg7)

dadosg8 <- read.csv("regressao100/g8.csv")
dadosg8$image_url <- substituiURL(dadosg8)

dadosg9 <- read.csv("regressao100/g9.csv")
dadosg9$image_url <- substituiURL(dadosg9)

dadosg10 <- read.csv("regressao100/g10.csv")
dadosg10$image_url <- substituiURL(dadosg10)

dadosg11 <- read.csv("regressao100/g11.csv")
dadosg11$image_url <- substituiURL(dadosg11)

dadosg12 <- read.csv("regressao100/g12.csv")
dadosg12$image_url <- substituiURL(dadosg12)

dadosg13 <- read.csv("regressao100/g13.csv")
dadosg13$image_url <- substituiURL(dadosg13)

#Summing features values  - left and right
somaValores <- function(dados1, dados2, desvio1, desvio2, uplimit){
    dados1[is.na(dados1)] <- 0
    dados2[is.na(dados2)] <- 0
    
    soma = dados1 + dados2
    desvios = (desvio1 + desvio2)/2
    
    desvio = sd(soma)
    if (is.na(desvio)){ 
        valores = rnorm(mean = mean(soma, na.rm = TRUE), sd = mean(desvios, na.rm = TRUE), n = 3)
        valores <- ifelse(valores < 0, 0, valores)
        valores <- ifelse(valores > uplimit, uplimit, valores)
        return (mean(valores))
    }else{
        soma <- ifelse(soma < 0, 0, soma)
        soma <- ifelse(soma > uplimit, uplimit, soma)
        return (mean(soma))
    }
  #return (mean(soma))
}

#Mean of features values - left and right
mediaValores <- function(dados1, dados2, desvio1, desvio2, uplimit){
   for (i in 1:length(dados1)){
       if(is.na(dados1[i])){
         dados1[i] <- dados2[i]
       }
       if(is.na(dados2[i])){
         dados2[i] <- dados1[i]
       }
    }
    
    soma = (dados1 + dados2) / 2
    desvios = (desvio1 + desvio2)/2
    
    desvio = sd(soma)
    if (is.na(desvio)){ 
        valores = rnorm(mean = mean(soma, na.rm = TRUE), sd = mean(desvios, na.rm = TRUE), n = 3)
        valores <- ifelse(valores < 0, 0, valores)
        valores <- ifelse(valores > uplimit, uplimit, valores)
        return (mean(valores))
    }else{
        soma <- ifelse(soma < 0, 0, soma)
        soma <- ifelse(soma > uplimit, uplimit, soma)
        return (mean(soma))
    }
#   return(mean(soma))
}


#Creating values for the cases where only 1 answer was obtained considering the desviations of other features answers
geraValores <- function(lista, question, desvios, uplimit){
   #desvio = sd(lista)
   return (mean(lista, na.rm = TRUE))
}

Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

#Grouping by image and question - G1
by_image <- group_by(dadosg1, image_url)
desvios <- summarise (by_image, 
                  sd1 = sd(question1, na.rm = TRUE),
                  sd2l = sd(question2__left_side, na.rm = TRUE),
                  sd2r = sd(question2__right_side, na.rm = TRUE),
                  sd3 = sd(question3, na.rm = TRUE) )
groupedData1 <- summarise(by_image,
  #count = n(),
  q1 = geraValores(question1, "1", desvios, 100),
  #sdq1 = sd(question1, na.rm = TRUE),
  q2 = mediaValores(image_url, question2__left_side, question2__right_side, desvios$sd2l, desvios$sd2r, 100),
  q2_left = geraValores(question2__left_side, "2l", desvios, 100),
  #sdq2_left = sd(question2__left_side, na.rm = TRUE),
  q2_right = geraValores(question2__right_side, "2r", desvios, 100),
  #sdq2_right = sd(question2__right_side, na.rm = TRUE),
  q3 = geraValores(question3, "3", desvios, 100)
  #sdq3 = sd(question3, na.rm = TRUE) 
  )

#Grouping by image and question- G2
by_image <- group_by(dadosg2, image_url)
desvios <- summarise (by_image, 
                  sd1 = sd(question1, na.rm = TRUE),
                  sd2l = sd(question2__left_side, na.rm = TRUE),
                  sd2r = sd(question2__right_side, na.rm = TRUE),
                  sd3 = sd(question3, na.rm = TRUE) )
groupedData2 <- summarise(by_image,
  count = n(),
  q1 = geraValores(question1, "1", desvios, 100),
  #sdq1 = sd(question1, na.rm = TRUE),
  q2 = somaValores(question2__left_side, question2__right_side, desvios$sd2l, desvios$sd2r, 200),
  q2_left = geraValores(question2__left_side, "2l", desvios, 100),
  #sdq2_left = sd(question2__left_side, na.rm = TRUE),
  q2_right = geraValores(question2__right_side, "2r", desvios, 100),
  #sdq2_right = sd(question2__right_side, na.rm = TRUE),
  q3 = geraValores(question3, "3", desvios, 100)
  #sdq3 = sd(question3, na.rm = TRUE) 
  )

#Grouping by image and question - G3
by_image <- group_by(dadosg3, image_url)
desvios <- summarise (by_image, 
                  sd1l = sd(question1__left_side, na.rm = TRUE),
                  sd1r = sd(question1__right_side, na.rm = TRUE),
                  sd2l = sd(question2__left_side, na.rm = TRUE),
                  sd2r = sd(question2__right_side, na.rm = TRUE),
                  sd3l = sd(question3__left_side, na.rm = TRUE),
                  sd3r = sd(question3__right_side, na.rm = TRUE) )
groupedData3 <- summarise(by_image,
  count = n(),
  q1 = mediaValores(question1__left_side, question1__right_side, desvios$sd1l, desvios$sd1r, 5),
  q1_left = geraValores(question1__left_side, "1l", desvios, 5),
  #sdq1_left = sd(question1__left_side, na.rm = TRUE),
  q1_right = geraValores(question1__right_side, "1r", desvios, 5),
  #sdq1_right = sd(question1__right_side, na.rm = TRUE),
  q2 = mediaValores(question2__left_side, question2__right_side, desvios$sd2l, desvios$sd2r, 5),
  q2_left = geraValores(question2__left_side, "2l", desvios, 5),
  #sdq2_left = sd(question2__left_side, na.rm = TRUE),
  q2_right = geraValores(question2__right_side, "2r", desvios, 5),
  #sdq2_right = sd(question2__right_side, na.rm = TRUE),
  q3 = mediaValores(question3__left_side, question3__right_side, desvios$sd3l, desvios$sd3r, 5),
  q3_left = geraValores(question3__left_side, "3l", desvios, 5),
  #sdq3_left = sd(question3__left_side, na.rm = TRUE),
  q3_right = geraValores(question3__right_side, "3r", desvios, 5)
  #sdq3_right = sd(question3__right_side, na.rm = TRUE)  
  )

#Grouping by image and question - G4
by_image <- group_by(dadosg4, image_url)
desvios <- summarise (by_image, 
                  sd1 = sd(question1, na.rm = TRUE),
                  sd2 = sd(question2, na.rm = TRUE))
groupedData4 <- summarise(by_image,
  count = n(),
  q1 = geraValores(question1, "1", desvios, 10),
  #sdq1 = sd(question1, na.rm = TRUE),
  q2 = geraValores(question2, "2", desvios, 10)
  #sdq2 = sd(question2, na.rm = TRUE) 
  )

#Grouping by image and question - G5
by_image <- group_by(dadosg5, image_url)
desvios <- summarise (by_image, 
                  sd1 = sd(question1, na.rm = TRUE),
                  sd2 = sd(your_answer_is, na.rm = TRUE))
groupedData5 <- summarise(by_image,
  count = n(),
  q1 = geraValores(question1, "1", desvios, 20),
  #sdq1 = sd(question1, na.rm = TRUE),
  q2 = geraValores(your_answer_is, "2", desvios, 20)
  #sdq2 = sd(question2, na.rm = TRUE) 
  )

#Grouping by image and question - G6
by_image <- group_by(dadosg6, image_url)
desvios <- summarise (by_image, 
                  sd1l = sd(question1__left_side, na.rm = TRUE),
                  sd1r = sd(question1__right_side, na.rm = TRUE),
                  sd2l = sd(question2__left_side, na.rm = TRUE),
                  sd2r = sd(question2__right_side, na.rm = TRUE) )
groupedData6 <- summarise(by_image,
  count = n(),
  q1 = mediaValores(question1__left_side, question1__right_side, desvios$sd1l, desvios$sd1r, 1),
  q1_left = geraValores(question1__left_side, "1l", desvios, 1),
  #sdq1_left = sd(question1__left_side, na.rm = TRUE),
  q1_right = geraValores(question1__right_side, "1r", desvios, 1),
  #sdq1_right = sd(question1__right_side, na.rm = TRUE),
  q2 = mediaValores(question2__left_side, question2__right_side, desvios$sd2l, desvios$sd2r, 1),
  q2_left = geraValores(question2__left_side, "2l", desvios, 1),
  #sdq2_left = sd(question2__left_side, na.rm = TRUE),
  q2_right = geraValores(question2__right_side, "2r", desvios, 1)
  #sdq2_right = sd(question2__right_side, na.rm = TRUE) 
  )

#Grouping by image and question - G7
by_image <- group_by(dadosg7, image_url)
desvios <- summarise (by_image, 
                  sd1 = sd(question1, na.rm = TRUE),
                  sd2 = sd(question2, na.rm = TRUE),
                  sd3l = sd(question3__left_side, na.rm = TRUE),
                  sd3r = sd(question3__right_side, na.rm = TRUE) )
groupedData7 <- summarise(by_image,
  count = n(),
  q1 = geraValores(question1, "1", desvios, 3),
  #sdq1 = sd(question1, na.rm = TRUE),
  q2 = geraValores(question2, "2", desvios, 1),
  #sdq2 = sd(question2, na.rm = TRUE),
  q3 = mediaValores(question3__left_side, question3__right_side, desvios$sd3l, desvios$sd3r, 1),
  q3_left = geraValores(question3__left_side, "3l", desvios, 1),
  #sdq3_left = sd(question3__left_side, na.rm = TRUE),
  q3_right = geraValores(question3__right_side, "3r", desvios, 1)
  #sdq3_right = sd(question3__right_side, na.rm = TRUE)  
  )

#Grouping by image and question - G8
by_image <- group_by(dadosg8, image_url)
desvios <- summarise (by_image, 
                  sd1 = sd(question1, na.rm = TRUE),
                  sd2l = sd(question2__left_side, na.rm = TRUE),
                  sd2r = sd(question2_right_side, na.rm = TRUE),
                  sd3l = sd(question3__left_side, na.rm = TRUE),
                  sd3r = sd(question3_right_side, na.rm = TRUE)
                  )
groupedData8 <- summarise(by_image,
  count = n(),
  q1 = Mode(question1),
  #sdq1 = sd(question1, na.rm = TRUE),
  q2 = somaValores(question2__left_side, question2_right_side, desvios$sd2l, desvios$sd2r, 40),
  q2_left = geraValores(question2__left_side, "2l", desvios, 20),
  #sdq2_left = sd(question2__left_side, na.rm = TRUE),
  q2_right = geraValores(question2_right_side, "2r", desvios, 20),
  #sdq2_right = sd(question2__right_side, na.rm = TRUE)  
  q3 = somaValores(question3__left_side, question3_right_side, desvios$sd3l, desvios$sd3r, 40),
  q3_left = geraValores(question3__left_side, "3l", desvios, 20),
  q3_right = geraValores(question3_right_side, "3r", desvios, 20)
  )

#Grouping by image and question - G9
by_image <- group_by(dadosg9, image_url)
desvios <- summarise (by_image, 
                  sd1l = sd(question1__left_side, na.rm = TRUE),
                  sd1r = sd(question1__right_side, na.rm = TRUE) )
groupedData9 <- summarise(by_image,
  count = n(),
  q1 = mediaValores(question1__left_side, question1__right_side, desvios$sd1l, desvios$sd1r, 200),
  q1_left = geraValores(question1__left_side, "1l", desvios, 200),
  #sdq1_left = sd(question1__left_side, na.rm = TRUE),
  q1_right = geraValores(question1__right_side, "1r", desvios, 200)
  #sdq1_right = sd(question1__right_side, na.rm = TRUE)  
  )

#Grouping by image and question - G10
by_image <- group_by(dadosg10, image_url)
desvios <- summarise (by_image, 
                  sd1 = sd(question1, na.rm = TRUE),
                  sd2 = sd(question2, na.rm = TRUE),
                  sd3 = sd(question3, na.rm = TRUE))
groupedData10 <- summarise(by_image,
  count = n(),
  q1 = Mode(x = question1),
  #sdq1 = sd(question1, na.rm = TRUE),
  q2 = geraValores(question2, "2", desvios, 50),
  #sdq2 = sd(question2, na.rm = TRUE),
  q3 = geraValores(question3, "3", desvios, 1)
  #sdq3 = sd(question3, na.rm = TRUE)  
  )

#Grouping by image and question - G11
by_image <- group_by(dadosg11, image_url)
desvios <- summarise (by_image, 
                  sd2l = sd(question2__left_side, na.rm = TRUE),
                  sd2r = sd(question2__right_side, na.rm = TRUE),
                  sd3l = sd(question3__left_side, na.rm = TRUE),
                  sd3r = sd(question3__right_side, na.rm = TRUE) )
groupedData11 <- summarise(by_image,
  count = n(),
  q2 = somaValores(question2__left_side, question2__right_side, desvios$sd2l, desvios$sd2r, 20),
  q2_left = geraValores(question2__left_side, "2l", desvios, 10),
  #sdq2_left = sd(question2__left_side, na.rm = TRUE),
  q2_right = geraValores(question2__right_side, "2r", desvios, 10),
  #sdq2_right = sd(question2__right_side, na.rm = TRUE),
  q3 = somaValores(question3__left_side, question3__right_side, desvios$sd3l, desvios$sd3r, 80),
  q3_left = geraValores(question3__left_side, "3l", desvios, 40),
  #sdq3_left = sd(question3__left_side, na.rm = TRUE),
  q3_right = geraValores(question3__right_side, "3r", desvios, 40)
  #sdq3_right = sd(question3__right_side, na.rm = TRUE)  
  )

#Grouping by image and question - G12
by_image <- group_by(dadosg12, image_url)
desvios <- summarise (by_image, 
                  sd1 = sd(question1, na.rm = TRUE),
                  sd2l = sd(question2__left_side, na.rm = TRUE),
                  sd2r = sd(question2__right_side, na.rm = TRUE),
                  sd3 = sd(question3, na.rm = TRUE))
groupedData12 <- summarise(by_image,
  count = n(),
  q1 = geraValores(question1, "1", desvios, 10),
  #sdq1 = sd(question1, na.rm = TRUE),
  q2 = somaValores(question2__left_side, question2__right_side, desvios$sd2l, desvios$sd2r, 20),
  q2_left = geraValores(question2__left_side, "2l", desvios, 10),
  #sdq2_left = sd(question2__left_side, na.rm = TRUE),
  q2_right = geraValores(question2__right_side, "2r", desvios, 10),
  #sdq2_right = sd(question2__right_side, na.rm = TRUE),
  q3 = geraValores(question3, "3", desvios,10)
  #sdq3 = sd(question3, na.rm = TRUE)  
  )

#Grouping by image and question - G13
by_image <- group_by(dadosg13, image_url)
desvios <- summarise (by_image, 
                  sd1l = sd(question1__left_side, na.rm = TRUE),
                  sd1r = sd(question1__right_side, na.rm = TRUE),
                  sd2l = sd(question2__left_side, na.rm = TRUE),
                  sd2r = sd(question2__right_side, na.rm = TRUE) )
groupedData13 <- summarise(by_image,
  count = n(),
  q1 = somaValores(question1__left_side, question1__right_side, desvios$sd1l, desvios$sd1r, 30),
  q1_left = geraValores(question1__left_side, "1l", desvios, 10),
  #sdq1_left = sd(question1__left_side, na.rm = TRUE),
  q1_right = geraValores(question1__right_side, "1r", desvios, 15),
  #sdq1_right = sd(question1__right_side, na.rm = TRUE),
  q2 = mediaValores(question2__left_side, question2__right_side, desvios$sd2l, desvios$sd2r, 1),
  q2_left = geraValores(question2__left_side, "2l", desvios, 1),
  #sdq2_left = sd(question2__left_side, na.rm = TRUE),
  q2_right = geraValores(question2__right_side, "2r", desvios, 1)
  #sdq2_right = sd(question2__right_side, na.rm = TRUE) 
  )

#Renaming columns according to a fixed id
renomeiaGrupos <- function(dadosPorGrupo, listaColunas, idGrupo) {
    for (coluna in listaColunas){
        colnames(dadosPorGrupo)[colnames(dadosPorGrupo) == coluna] <- paste(idGrupo, coluna, sep="")
    }
    return(dadosPorGrupo)
}

renomeiaGrupos2 <- function(dadosPorGrupo, listaColunas, novosNomes) {
    for (i in seq(1, length(listaColunas))){
        coluna = listaColunas[i]
        colnames(dadosPorGrupo)[colnames(dadosPorGrupo) == coluna] <- novosNomes[i]
    }
    return(dadosPorGrupo)
}

groupedData1 <- renomeiaGrupos(groupedData1, c("q2_left", "q2_right", "count"), "g1")
groupedData2 <- renomeiaGrupos(groupedData2, c("q2_left", "q2_right", "count"), "g2")
groupedData3 <- renomeiaGrupos(groupedData3, c("q1_left", "q1_right","q2_left", "q2_right","q3_left", "q3_right", "count"), "g3")
groupedData4 <- renomeiaGrupos(groupedData4, c("count"), "g4")
groupedData5 <- renomeiaGrupos(groupedData5, c("count"), "g5")
groupedData6 <- renomeiaGrupos(groupedData6, c("q1_left", "q1_right", "q2_left", "q2_right", "count"), "g6")
groupedData7 <- renomeiaGrupos(groupedData7, c("q3_left", "q3_right", "count"), "g7")
groupedData8 <- renomeiaGrupos(groupedData8, c("q2_left", "q2_right","q3_left", "q3_right", "count"), "g8")
groupedData9 <- renomeiaGrupos(groupedData9, c("q1_left", "q1_right", "count"), "g9")
groupedData10 <- renomeiaGrupos(groupedData10, c("count"), "g10")
groupedData11 <- renomeiaGrupos(groupedData11, c("q2_left", "q2_right","q3_left", "q3_right", "count"), "g11")
groupedData12 <- renomeiaGrupos(groupedData12, c("q2_left", "q2_right", "count"), "g12")
groupedData13 <- renomeiaGrupos(groupedData13, c("q1_left", "q1_right", "q2_left", "q2_right", "count"), "g13")

groupedData1 <- renomeiaGrupos2(groupedData1, c("q1", "q2", "q3"), c("street_wid", "sidewalk_wid", "public_art"))
groupedData2 <- renomeiaGrupos2(groupedData2, c("q1", "q2", "q3"), c("mov_cars", "park_cars", "mov_ciclyst"))
groupedData3 <- renomeiaGrupos2(groupedData3, c("q1", "q2", "q3"), c("debris", "pavement", "landscape"))
groupedData4 <- renomeiaGrupos2(groupedData4, c("q1", "q2"), c("courtyards", "major_landsc"))
groupedData5 <- renomeiaGrupos2(groupedData5, c("q1", "q2"), c("build_ident", "build_nrectan"))
groupedData6 <- renomeiaGrupos2(groupedData6, c("q1", "q2"), c("prop_street_wall", "prop_wind"))
groupedData7 <- renomeiaGrupos2(groupedData7, c("q1", "q2", "q3"), c("long_sight", "prop_sky_ahead", "prop_sky_across"))
groupedData8 <- renomeiaGrupos2(groupedData8, c("q1", "q2", "q3"), c("graffiti", "trees", "small_planters"))
groupedData9 <- renomeiaGrupos2(groupedData9, c("q1"), c("build_height"))
groupedData10 <- renomeiaGrupos2(groupedData10, c("q1", "q2", "q3"), c("build_diff_ages", "diff_build", "prop_hist_build"))
groupedData11 <- renomeiaGrupos2(groupedData11, c("q2", "q3"), c("outdoor_table", "street_furnit"))
groupedData12 <- renomeiaGrupos2(groupedData12, c("q1", "q2", "q3"), c("basic_col", "lights", "accent_col"))
groupedData13 <- renomeiaGrupos2(groupedData13, c("q1","q2"), c("people", "prop_active_use"))

#Combining QScores with each feature separetely
temp <- merge(groupedData1, novosDados, by.x="image_url", by.y="image_url")
temp2 <- merge(novosDados, groupedData2, by.x="image_url", by.y="image_url")
temp3 <- merge(novosDados, groupedData3, by.x="image_url", by.y="image_url")
temp4 <- merge(novosDados, groupedData4, by.x="image_url", by.y="image_url")
temp5 <- merge(novosDados, groupedData5, by.x="image_url", by.y="image_url")
temp6 <- merge(novosDados, groupedData6, by.x="image_url", by.y="image_url")
temp7 <- merge(novosDados, groupedData7, by.x="image_url", by.y="image_url")
temp8 <- merge(novosDados, groupedData8, by.x="image_url", by.y="image_url")
temp9 <- merge(novosDados, groupedData9, by.x="image_url", by.y="image_url")
temp10 <- merge(novosDados, groupedData10, by.x="image_url", by.y="image_url")
temp11 <- merge(novosDados, groupedData11, by.x="image_url", by.y="image_url")
temp12 <- merge(novosDados, groupedData12, by.x="image_url", by.y="image_url")
temp13 <- merge(novosDados, groupedData13, by.x="image_url", by.y="image_url")
colnames(novosDados)[colnames(novosDados) == "V2"] <- "image_url"
# allData <- Reduce(function(x, y) merge(x, y, all=TRUE), list(novosDados, groupedData1, groupedData2, groupedData3, groupedData3, groupedData4, groupedData5, groupedData6, groupedData7,groupedData8, groupedData9, groupedData10, groupedData11, groupedData12, groupedData13))

#Correlation functions for RGB bins and QScore
calcCorrelForBins <- function(dados, colunaQScore, colunaCor, questao){
    dadosAtuais <- dados[(dados$V1 == questao),] 
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais[[colunaCor]], na.action = na.exclude, method = "kendall")
    return (res)
}

#Summing descriptors for each edge type
rgbBinsData <- read.table("geralSetoresAJ_bins.dat", header=TRUE)
index <- seq(177, 256, 5)
rgbBinsData$ehdVert <- apply(rgbBinsData[c(index)], 1, sum)
index <- seq(178, 256, 5)
rgbBinsData$ehdHor <- apply(rgbBinsData[c(index)], 1, sum)
index <- seq(179, 256, 5)
rgbBinsData$ehd45 <- apply(rgbBinsData[c(index)], 1, sum)
index <- seq(180, 256, 5)
rgbBinsData$ehd135 <- apply(rgbBinsData[c(index)], 1, sum)
index <- seq(181, 256, 5)
rgbBinsData$ehdNon <- apply(rgbBinsData[c(index)], 1, sum)
rgbBinsData$ehdDiag <- rgbBinsData$ehd45 + rgbBinsData$ehd135

allUsersData <- filter(rgbBinsData, grupo == "Geral")
for (quest in c("agradavel?", "seguro?")){
   for (edge in c("ehdVert", "ehdHor", "ehd45", "ehd135", "ehdNon")){
     res <- calcCorrelForBins(allUsersData, "V3", edge, quest)
     print(paste(quest, "Geral", edge))
     print(res)
  }
}

regAgrad <- lm(V3 ~ ehdVert + ehdHor + ehd45 + ehd135 + ehdNon, data=filter(allUsersData, V1 == "agradavel?"), na.action = na.exclude)#Separate diagonals
summary(regAgrad)
regAgrad <- lm(V3 ~ ehdVert + ehdHor + ehdDiag + ehdNon, data=filter(allUsersData, V1 == "agradavel?"), na.action = na.exclude)#One value for diagonals
summary(regAgrad)
regSeg <- lm(V3 ~ ehdVert + ehdHor + ehd45 + ehd135 + ehdNon, data=filter(allUsersData, V1 == "seguro?"), na.action = na.exclude)
summary(regSeg)
regSeg <- lm(V3 ~ ehdVert + ehdHor + ehdDiag + ehdNon, data=filter(allUsersData, V1 == "seguro?"), na.action = na.exclude)
summary(regSeg)

#Correlation and regression of rgb bins with Qscores
sink("rgbBins_correlation.dat")
for (quest in c("agradavel?", "seguro?")){
  for (i in seq(104, 167)){
     res <- calcCorrelForBins(allUsersData, "V3", paste("V",i,sep=""), quest)
     print(paste(quest, "Geral", paste("V",i,sep="")))
     print(res)
  }
}
sink()
regAgrad <- lm(V3 ~ V108 + V110 + V114 + V120 + V121 + V128 + V141 + V144 + V149 + V150 + V162 + V167, data=filter(allUsersData, V1 == "agradavel?"), na.action = na.exclude)
summary(regAgrad)
regAgrad <- lm(V3 ~ V108 + V110 + V114 + V120 + V121 + V128 + V141 + V144 + V149 + V150 + V162 + V167 + ehdVert + ehdHor + ehd45 + ehd135 + ehdNon, data=filter(allUsersData, V1 == "agradavel?"), na.action = na.exclude)
summary(regAgrad)

regSeg <- lm(V3 ~ V105 + V109 + V110 + V114 + V115 + V121 + V128 + V136 + V137 + V140 + V141 + V142 + V144 + V146 + V157 + V161 + V162 + V167, data=filter(allUsersData, V1 == "seguro?"), na.action = na.exclude)
summary(regSeg)
regSeg <- lm(V3 ~ V105 + V109 + V110 + V114 + V115 + V121 + V128 + V136 + V137 + V140 + V141 + V142 + V144 + V146 + V157 + V161 + V162 + V167+ ehdVert + ehdHor + ehd45 + ehd135 + ehdNon, data=filter(allUsersData, V1 == "seguro?"), na.action = na.exclude)
summary(regSeg)

#Subset of columns to merge with features values
dadosSubBins <- rgbBinsData[, c("V2", "V1", "V3", "diag", "hor", "vert", "ehdVert","ehdHor", "ehdDiag", "ehdNon", "red", "green", "blue", "grupo", "bairro", "setor")]
novosDadosBins <- reshape(dadosSubBins, timevar="grupo", idvar=c("V2", "V1", "diag", "hor", "vert", "ehdVert","ehdHor", "ehdDiag", "ehdNon", "red", "green", "blue", "bairro", "setor"), direction="wide")

colnames(novosDadosBins)[colnames(novosDadosBins) == "V2"] <- "image_url"
temp <- merge(groupedData1, novosDadosBins, by.x="image_url", by.y="image_url")
temp <- merge(temp, groupedData2, by.x="image_url", by.y="image_url")
temp <- merge(temp, groupedData3, by.x="image_url", by.y="image_url")
temp <- merge(temp, groupedData4, by.x="image_url", by.y="image_url")
temp <- merge(temp, groupedData5, by.x="image_url", by.y="image_url")
temp <- merge(temp, groupedData6, by.x="image_url", by.y="image_url")
temp <- merge(temp, groupedData7, by.x="image_url", by.y="image_url")
temp <- merge(temp, groupedData8, by.x="image_url", by.y="image_url")
temp<- merge(temp, groupedData9, by.x="image_url", by.y="image_url")
temp <- merge(temp, groupedData10, by.x="image_url", by.y="image_url")
temp <- merge(temp, groupedData11, by.x="image_url", by.y="image_url")
temp <- merge(temp, groupedData12, by.x="image_url", by.y="image_url")
temp <- merge(temp, groupedData13, by.x="image_url", by.y="image_url")

agradBins <- filter(temp, V1 == "agradavel?")
segBins <- filter(temp, V1 == "seguro?")

sink("rgbBins_correlation.dat")
for (feature in c("street_wid", "sidewalk_wid", "public_art", "mov_cars", "park_cars", "mov_ciclyst", "debris" , "pavement", "landscape", "courtyards", "major_landsc", "build_ident", "build_nrectan", "prop_street_wall", "prop_wind", "long_sight", "prop_sky_ahead", "prop_sky_across", "trees", "small_planters", "build_height", "diff_build", "prop_hist_build", "street_furnit", "basic_col", "lights", "accent_col", "people", "prop_active_use")){
  for (edge in c("ehdVert", "ehdHor", "ehdDiag", "ehdNon")){
   res <- calcCorrelForBins(temp, feature, edge, "agradavel?")
   print(paste(feature, edge))
   print(res)
  }
}
sink()

#Correlations for each urban feature and mean RGB and hough lines model (opencv). Spearman and Kendall - non-parametric, any assumption
calculaCorrelacoes <- function (listaDados, colunaQScore, questao, arquivo) {
    sink(arquivo, append = TRUE)
    print(questao)
    
    #Colors and lines correlation
    temp = listaDados[[1]]
    dadosAtuais <- temp[(temp$V1 == questao),] 
    res<- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$red, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "red"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$green, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "green"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$blue, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "blue"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$vert, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "vert_lines"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$hor, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "hor_lines"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$diag, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "diag_lines"))
    
    #Urban features
    temp = listaDados[[1]]
    dadosAtuais <- temp[(temp$V1 == questao),] 
    res<- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$street_wid, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "street_wid"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$sidewalk_wid, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "sidewalk_wid"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g1q2_left, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "sidewalk_wid_left"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g1q2_right, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "sidewalk_wid_right"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$public_art, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "public_art"))
    
    temp2 = listaDados[[2]]
    dadosAtuais <- temp2[(temp2$V1 == questao),] 
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$mov_cars, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "mov_cars"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$park_cars, na.action = na.exclude, method = "kendall")
       print(paste(res$estimate, res$p.value, "park_cars"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g2q2_left, na.action = na.exclude, method = "kendall")
       print(paste(res$estimate, res$p.value, "park_cars_left"))
  res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g2q2_right, na.action = na.exclude, method = "kendall")
      print(paste(res$estimate, res$p.value, "park_cars_right"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$mov_ciclyst, na.action = na.exclude, method = "kendall")
      print(paste(res$estimate, res$p.value, "mov_ciclyst"))
    
    temp3 = listaDados[[3]]
    dadosAtuais <- temp3[(temp3$V1 == questao),] 
  res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$debris, na.action = na.exclude, method = "kendall")
      print(paste(res$estimate, res$p.value, "debris"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g3q1_left, na.action = na.exclude, method = "kendall")
      print(paste(res$estimate, res$p.value, "debris_left"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g3q1_right, na.action = na.exclude, method = "kendall")
      print(paste(res$estimate, res$p.value, "debris_right"))
  res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$pavement, na.action = na.exclude, method = "kendall")
      print(paste(res$estimate, res$p.value, "pavement"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g3q2_left, na.action = na.exclude, method = "kendall")
      print(paste(res$estimate, res$p.value, "pavement_left"))
  res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g3q2_right, na.action = na.exclude, method = "kendall")
      print(paste(res$estimate, res$p.value, "pavement_right"))
  res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$landscape, na.action = na.exclude, method = "kendall")
      print(paste(res$estimate, res$p.value, "landscape"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g3q3_left, na.action = na.exclude, method = "kendall")
      print(paste(res$estimate, res$p.value, "landscape_left"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g3q3_right, na.action = na.exclude, method = "kendall")
      print(paste(res$estimate, res$p.value, "landscape_right"))
    
    temp4 = listaDados[[4]]
    dadosAtuais <- temp4[(temp4$V1 == questao),] 
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$courtyards, na.action = na.exclude, method = "kendall")
      print(paste(res$estimate, res$p.value, "courtyards"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$major_landsc, na.action = na.exclude, method = "kendall")
      print(paste(res$estimate, res$p.value, "major_landsc"))
    
    temp5 = listaDados[[5]]
    dadosAtuais <- temp5[(temp5$V1 == questao),] 
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$build_ident, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "build_ident"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$build_nrectan, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "build_nrectan"))
    
    temp6 = listaDados[[6]]
    dadosAtuais <- temp6[(temp6$V1 == questao),] 
  res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$prop_street_wall, na.action = na.exclude, method = "kendall")
      print(paste(res$estimate, res$p.value, "prop_street_wall"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g6q1_left, na.action = na.exclude, method = "kendall")
      print(paste(res$estimate, res$p.value, "prop_street_wall_left"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g6q1_right, na.action = na.exclude, method = "kendall")
      print(paste(res$estimate, res$p.value, "prop_street_wall_right"))
  res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$prop_wind, na.action = na.exclude, method = "kendall")
      print(paste(res$estimate, res$p.value, "prop_wind"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g6q2_left, na.action = na.exclude, method = "kendall")
      print(paste(res$estimate, res$p.value, "prop_wind_left"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g6q2_right, na.action = na.exclude, method = "kendall")
      print(paste(res$estimate, res$p.value, "prop_wind_right"))
    
    temp7 = listaDados[[7]]
    dadosAtuais <- temp7[(temp7$V1 == questao),] 
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$long_sight, na.action = na.exclude, method = "kendall")
      print(paste(res$estimate, res$p.value, "long_sight"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$prop_sky_ahead, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "prop_sky_ahead"))
  res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$prop_sky_across, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "prop_sky_across"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g7q3_left, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "prop_sky_across_left"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g7q3_right, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "prop_sky_across_right"))
    
    temp8 = listaDados[[8]]
    dadosAtuais <- temp8[(temp8$V1 == questao),] 
    #res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$graffiti, na.action = na.exclude)
#     print(paste(res$estimate, res$p.value, "graffiti"))
res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$trees, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "trees"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g8q2_left, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "trees_left"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g8q2_right, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "trees_right"))
res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$small_planters, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "small_planters"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g8q3_left, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "small_planters_left"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g8q3_right, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "small_planters_right"))
    
    temp9 = listaDados[[9]]
    dadosAtuais <- temp9[(temp9$V1 == questao),] 
res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$build_height, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "build_height"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g9q1_left, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "build_height_left"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g9q1_right, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "build_height_right"))
    
    temp10 = listaDados[[10]]
    dadosAtuais <- temp10[(temp10$V1 == questao),] 
    #res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$build_diff_ages, na.action = na.exclude)
#     print(res)
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$diff_build, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "diff_build"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$prop_hist_build, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "prop_hist_build"))
    
    temp11 = listaDados[[11]]
    dadosAtuais <- temp11[(temp11$V1 == questao),] 
res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$outdoor_table, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "outdoor_table"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g11q2_left, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "outdoor_table_left"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g11q2_right, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "outdoor_table_right"))
res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$street_furnit, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "street_furnit"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g11q3_left, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "street_furnit_left"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g11q3_right, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "street_furnit_right"))
    
    temp12 = listaDados[[12]]
    dadosAtuais <- temp12[(temp12$V1 == questao),] 
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$basic_col, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "basic_col"))
res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$lights, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "lights"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g12q2_left, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "lights_left"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g12q2_right, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "lights_right"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$accent_col, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "accent_col"))
    
    temp13 = listaDados[[13]]
    dadosAtuais <- temp13[(temp13$V1 == questao),] 
res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$people, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "people"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g13q1_left, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "people_left"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g13q1_right, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "people_right"))
res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$prop_active_use, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "prop_active_use"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g13q2_left, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "prop_active_use_left"))
    res <- cor.test(dadosAtuais[[colunaQScore]], dadosAtuais$g13q2_right, na.action = na.exclude, method = "kendall")
    print(paste(res$estimate, res$p.value, "prop_active_use_right"))
    sink()
}

calculaCorrelacoes( list(temp, temp2, temp3, temp4, temp5, temp6, temp7, temp8, temp9, temp10, temp11, temp12, temp13), "V3.Geral", "agradavel?", "correlacao-agrad-kendall.dat")
# 
# calculaCorrelacoes( list(temp, temp2, temp3, temp4, temp5, temp6, temp7, temp8, temp9, temp10, temp11, temp12, temp13), "V3.Masculino", 'agradavel?', "correlacao-agrad-masc.dat")
# calculaCorrelacoes( list(temp, temp2, temp3, temp4, temp5, temp6, temp7, temp8, temp9, temp10, temp11, temp12, temp13), "V3.Feminino", 'agradavel?', "correlacao-agrad-fem.dat")
# calculaCorrelacoes( list(temp, temp2, temp3, temp4, temp5, temp6, temp7, temp8, temp9, temp10, temp11, temp12, temp13), "V3.Jovem", 'agradavel?', "correlacao-agrad-jov.dat")
# calculaCorrelacoes( list(temp, temp2, temp3, temp4,temp5, temp6, temp7, temp8, temp9, temp10, temp11, temp12, temp13), "V3.Adulto", 'agradavel?', "correlacao-agrad-adu.dat")
# calculaCorrelacoes( list(temp, temp2, temp3, temp4, temp5, temp6, temp7, temp8, temp9, temp10, temp11, temp12, temp13), "V3.Casado", 'agradavel?', "correlacao-agrad-cas.dat")
# calculaCorrelacoes( list(temp, temp2, temp3, temp4, temp5, temp6, temp7, temp8, temp9, temp10, temp11, temp12, temp13), "V3.Solteiro", 'agradavel?', "correlacao-agrad-sol.dat")
# calculaCorrelacoes( list(temp, temp2, temp3, temp4, temp5, temp6, temp7, temp8, temp9, temp10, temp11, temp12, temp13), "V3.Baixa", 'agradavel?', "correlacao-agrad-bai.dat")
# calculaCorrelacoes( list(temp, temp2, temp3, temp4,temp5, temp6, temp7, temp8, temp9, temp10, temp11, temp12, temp13), "V3.Media", 'agradavel?', "correlacao-agrad-med.dat")
# 
calculaCorrelacoes( list(temp, temp2, temp3, temp4, temp5, temp6, temp7, temp8, temp9, temp10, temp11, temp12, temp13), "V3.Geral", 'seguro?', "correlacao-seg-kendall.dat")
# 
# calculaCorrelacoes( list(temp, temp2, temp3, temp4, temp5, temp6, temp7, temp8, temp9, temp10, temp11, temp12, temp13), "V3.Masculino", 'seguro?', "correlacao-seg-masc.dat")
# calculaCorrelacoes( list(temp, temp2, temp3, temp4, temp5, temp6, temp7, temp8, temp9, temp10, temp11, temp12, temp13), "V3.Feminino", 'seguro?', "correlacao-seg-fem.dat")
# calculaCorrelacoes( list(temp, temp2, temp3, temp4, temp5, temp6, temp7, temp8, temp9, temp10, temp11, temp12, temp13), "V3.Jovem", 'seguro?', "correlacao-seg-jov.dat")
# calculaCorrelacoes( list(temp, temp2, temp3, temp4, temp5, temp6, temp7, temp8, temp9, temp10, temp11, temp12, temp13), "V3.Adulto", 'seguro?', "correlacao-seg-adu.dat")
# calculaCorrelacoes( list(temp, temp2, temp3, temp4, temp5, temp6, temp7, temp8, temp9, temp10, temp11, temp12, temp13), "V3.Casado", 'seguro?', "correlacao-seg-cas.dat")
# calculaCorrelacoes( list(temp, temp2, temp3, temp4, temp5, temp6, temp7, temp8, temp9, temp10, temp11, temp12, temp13), "V3.Solteiro", 'seguro?', "correlacao-seg-sol.dat")
# calculaCorrelacoes( list(temp, temp2, temp3, temp4, temp5, temp6, temp7, temp8, temp9, temp10, temp11, temp12, temp13), "V3.Baixa", 'seguro?', "correlacao-seg-bai.dat")
# calculaCorrelacoes( list(temp, temp2, temp3, temp4, temp5, temp6, temp7, temp8, temp9, temp10, temp11, temp12, temp13), "V3.Media", 'seguro?', "correlacao-seg-med.dat")
# 

#Correlations per sector
setores <- read.table("geralSetoresAJ.dat", header=TRUE)
novosDadosSet <- reshape(setores, timevar="grupo", idvar=c("V2", "V1", "diag", "hor", "vert", "red", "green", "blue", "bairro", "setor"), direction="wide")
options("scipen"=100, "digits"=4)

#Centro
data1 <- filter(novosDadosSet, bairro == "centro")
correlacao <- cor(x = select(data1, V3.Masculino, V3.Feminino, V3.Casado, V3.Solteiro, V3.Baixa, V3.Media, V3.Jovem, V3.Adulto), method = "kendall")
library(lattice)
rb.palette <- colorRampPalette(c("yellow", "red"), space = "rgb")
levelplot(correlacao, main = "Urban Features Correlation", col.regions = rb.palette(120), cuts=100, at = seq(0, 1, 0.01), xlab = "Urban Features", ylab = "Urban Features", )

data1 <- filter(novosDadosSet, setor == "25040090500004")
correlacao <- cor(x = select(data1, V3.Masculino, V3.Feminino, V3.Casado, V3.Solteiro, V3.Baixa, V3.Media, V3.Jovem, V3.Adulto), method = "kendall")
library(lattice)
rb.palette <- colorRampPalette(c("yellow", "red"), space = "rgb")
levelplot(correlacao, main = "Urban Features Correlation", col.regions = rb.palette(120), cuts=100, at = seq(0, 1, 0.01), xlab = "Urban Features", ylab = "Urban Features")

data1 <- filter(novosDadosSet, setor == "250400905000013" | setor == "250400905000023")
correlacao <- cor(x = select(data1, V3.Masculino, V3.Feminino, V3.Casado, V3.Solteiro, V3.Baixa, V3.Media, V3.Jovem, V3.Adulto), method = "kendall")
library(lattice)
rb.palette <- colorRampPalette(c("yellow", "red"), space = "rgb")
levelplot(correlacao, main = "Urban Features Correlation", col.regions = rb.palette(120), cuts=100, at = seq(0, 1, 0.01), xlab = "Urban Features", ylab = "Urban Features")

#Catole
data1 <- filter(novosDadosSet, bairro == "catole")
correlacao <- cor(x = select(data1, V3.Masculino, V3.Feminino, V3.Casado, V3.Solteiro, V3.Baixa, V3.Media, V3.Jovem, V3.Adulto), method = "kendall")
library(lattice)
rb.palette <- colorRampPalette(c("yellow", "red"), space = "rgb")
levelplot(correlacao, main = "Urban Features Correlation", col.regions = rb.palette(120), cuts=100, at = seq(0, 1, 0.01), xlab = "Urban Features", ylab = "Urban Features")

data1 <- filter(novosDadosSet, setor == "250400905000060")
correlacao <- cor(x = select(data1, V3.Masculino, V3.Feminino, V3.Casado, V3.Solteiro, V3.Baixa, V3.Media, V3.Jovem, V3.Adulto), method = "kendall")
library(lattice)
rb.palette <- colorRampPalette(c("yellow", "red"), space = "rgb")
levelplot(correlacao, main = "Urban Features Correlation", col.regions = rb.palette(120), cuts=100, at = seq(0, 1, 0.01), xlab = "Urban Features", ylab = "Urban Features")

data1 <- filter(novosDadosSet, setor == "250400905000062")
correlacao <- cor(x = select(data1, V3.Masculino, V3.Feminino, V3.Casado, V3.Solteiro, V3.Baixa, V3.Media, V3.Jovem, V3.Adulto), method = "kendall")
library(lattice)
rb.palette <- colorRampPalette(c("yellow", "red"), space = "rgb")
levelplot(correlacao, main = "Urban Features Correlation", col.regions = rb.palette(120), cuts=100, at = seq(0, 1, 0.01), xlab = "Urban Features", ylab = "Urban Features")

#Liberdade
data1 <- filter(novosDadosSet, bairro == "liberdade")
correlacao <- cor(x = select(data1, V3.Masculino, V3.Feminino, V3.Casado, V3.Solteiro, V3.Baixa, V3.Media, V3.Jovem, V3.Adulto), method = "kendall")
library(lattice)
rb.palette <- colorRampPalette(c("yellow", "red"), space = "rgb")
levelplot(correlacao, main = "Urban Features Correlation", col.regions = rb.palette(120), cuts=100, at = seq(0, 1, 0.01), xlab = "Urban Features", ylab = "Urban Features")

data1 <- filter(novosDadosSet, setor == "250400905000089")
correlacao <- cor(x = select(data1, V3.Masculino, V3.Feminino, V3.Casado, V3.Solteiro, V3.Baixa, V3.Media, V3.Jovem, V3.Adulto), method = "kendall")
library(lattice)
rb.palette <- colorRampPalette(c("yellow", "red"), space = "rgb")
levelplot(correlacao, main = "Urban Features Correlation", col.regions = rb.palette(120), cuts=100, at = seq(0, 1, 0.01), xlab = "Urban Features", ylab = "Urban Features")

data1 <- filter(novosDadosSet, setor == "250400905000095")
correlacao <- cor(x = select(data1, V3.Masculino, V3.Feminino, V3.Casado, V3.Solteiro, V3.Baixa, V3.Media, V3.Jovem, V3.Adulto), method = "kendall")
library(lattice)
rb.palette <- colorRampPalette(c("yellow", "red"), space = "rgb")
levelplot(correlacao, main = "Urban Features Correlation", col.regions = rb.palette(120), cuts=100, at = seq(0, 1, 0.01), xlab = "Urban Features", ylab = "Urban Features")

#Neighborhoods summary
temp1 <- lapply(as.character(novosDados$V2), function (x) strsplit(x, split="/", fixed=TRUE)[[1]][1])
neigs1 <- unlist(lapply(temp1, '[[', 1))
novosDados$bairro <- neigs1

colnames(novosDados)[colnames(novosDados) == "V2"] <- "image_url"
allData <- Reduce(function(x, y) merge(x, y, all=TRUE), list(novosDados, groupedData1, groupedData2, groupedData3, groupedData3, groupedData4, groupedData5, groupedData6, groupedData7,groupedData8, groupedData9, groupedData10, groupedData11, groupedData12, groupedData13))

# 
# #Confidence interval?
# t.test(centro$people_left, na.action = na.rm )$conf.int

#Combining QScores with all features
colnames(novosDados)[colnames(novosDados) == "V2"] <- "image_url"
temp <- merge(groupedData1, novosDados, by.x="image_url", by.y="image_url")
temp <- merge(temp, groupedData2, by.x="image_url", by.y="image_url")
temp <- merge(temp, groupedData3, by.x="image_url", by.y="image_url")
temp <- merge(temp, groupedData4, by.x="image_url", by.y="image_url")
temp <- merge(temp, groupedData5, by.x="image_url", by.y="image_url")
temp <- merge(temp, groupedData6, by.x="image_url", by.y="image_url")
temp <- merge(temp, groupedData7, by.x="image_url", by.y="image_url")
temp <- merge(temp, groupedData8, by.x="image_url", by.y="image_url")
temp<- merge(temp, groupedData9, by.x="image_url", by.y="image_url")
temp <- merge(temp, groupedData10, by.x="image_url", by.y="image_url")
temp <- merge(temp, groupedData11, by.x="image_url", by.y="image_url")
temp <- merge(temp, groupedData12, by.x="image_url", by.y="image_url")
temp <- merge(temp, groupedData13, by.x="image_url", by.y="image_url")

temp$area[temp$bairro == "centro"] <- "norte"
temp$area[temp$bairro == "liberdade"] <- "oeste"
temp$area[temp$bairro == "catole"] <- "oeste"

agrad <- filter(temp, V1 == "agradavel?")#filter(temp, V1 == "agrad%C3%A1vel?")
seg <- filter(temp, V1 == "seguro?")

#Kendall adaptation to consider weights as the difference in amount of features between images
#Profiling https://tgmstat.wordpress.com/2013/09/25/profiling-r-code/
kendallWithWeights <- function(data, iterations, group1Id, group2Id){
    
    data$graffiti <- as.character(data$graffiti)
    data$graffiti[data$graffiti == "No"] <- 0
    data$graffiti[data$graffiti == "Yes"] <- 1
    data$build_diff_ages <- as.character(data$build_diff_ages)
    data$build_diff_ages[data$build_diff_ages == "No"] <- 0
    data$build_diff_ages[data$build_diff_ages == "yes"] <- 1
  
    #Amount of images
    amountOfItems <- nrow(data)

    #Maximum comparisons - worst scenario possible between these two groups!
    #data$index2 <- seq(amountOfItems, 1)#Fake index, completely opposite rank!
    
    #Improve? http://stackoverflow.com/questions/6269526/r-applying-a-function-to-all-row-pairs-of-a-matrix-without-for-loop
    featuresMapG1 <- data.frame(movCars = 0 , parkCars = 0, movCicly= 0, buildId = 0, buildNRec = 0, tree = 0, smallPla = 0, diffBuild = 0, streeFur = 0, basCol = 0, ligh = 0, accenCol = 0, peop = 0, graff = 0, buildDiffAges = 0, streetWid = 0, sidewalkWid = 0, debris = 0, pavement = 0, landscape = 0, propStreetWall = 0, propWind = 0, longSight = 0, propSkyAhead = 0, propSkyAcross = 0, buildHeight = 0, propActiveUse = 0, rmovCars = 0, rparkCars = 0, rmovCicly = 0, rbuildId = 0, rbuildNRec = 0, rtree = 0, rsmallPla = 0, rdiffBuild = 0, rstreeFur = 0, rbasCol = 0, rligh = 0, raccenCol = 0, rpeop = 0, rgraff = 0, rbuildDiffAges = 0, rstreetWid = 0, rsidewalkWid = 0, rdebris = 0, rpavement = 0, rlandscape = 0, rpropStreetWall = 0, rpropWind = 0, rlongSight = 0, rpropSkyAhead = 0, rpropSkyAcross = 0, rbuildHeight = 0, rpropActiveUse = 0, rsdMovCars = 0, rsdParkCars = 0, rsdMovCicly = 0, rsdBuildId = 0, rsdBuildNRec = 0, rsdTree = 0, rsdSmallPla = 0, rsdDiffBuild = 0, rsdStreeFur = 0, rsdBasCol = 0, rsdLigh = 0, rsdAccenCol = 0, rsdPeop = 0, rsdGraff = 0, rsdBuildDiffAges = 0, rsdStreetWid = 0, rsdSidewalkWid = 0, rsdDebris = 0, rsdPavement = 0, rsdLandscape = 0, rsdPropStreetWall = 0, rsdPropWind = 0, rsdLongSight = 0, rsdPropSkyAhead = 0, rsdPropSkyAcross = 0, rsdBuildHeight = 0, rsdPropActiveUse = 0, movCarsN = 0 , parkCarsN = 0, movCiclyN= 0, buildIdN = 0, buildNRecN = 0, treeN = 0, smallPlaN = 0, diffBuildN = 0, streeFurN = 0, basColN = 0, lighN = 0, accenColN = 0, peopN = 0, graffN = 0, buildDiffAgesN = 0, streetWidN = 0, sidewalkWidN = 0, debrisN = 0, pavementN = 0, landscapeN = 0, propStreetWallN = 0, propWindN = 0, longSightN = 0, propSkyAheadN = 0, propSkyAcrossN = 0, buildHeightN = 0, propActiveUseN = 0,  rmovCarsN = 0 , rparkCarsN = 0, rmovCiclyN= 0, rbuildIdN = 0, rbuildNRecN = 0, rtreeN = 0, rsmallPlaN = 0, rdiffBuildN = 0, rstreeFurN = 0, rbasColN = 0, rlighN = 0, raccenColN = 0, rpeopN = 0, rgraffN = 0, rbuildDiffAgesN = 0, rstreetWidN = 0, rsidewalkWidN = 0, rdebrisN = 0, rpavementN = 0, rlandscapeN = 0, rpropStreetWallN = 0, rpropWindN = 0, rlongSightN = 0, rpropSkyAheadN = 0, rpropSkyAcrossN = 0, rbuildHeightN = 0, rpropActiveUseN = 0)
    
    #Original data
    data <- arrange(data, rank)
    
    movCarsOrig <- data[["mov_cars"]]
    parkCarsOrig <- data[["park_cars"]]
    movCiclyOrig <- data[["mov_ciclyst"]]
    buildIdOrig <- data[["build_ident"]] 
    buildNRecOrig <- data[["build_nrectan"]]
    treeOrig <- data[["trees"]]
    smallPlaOrig <- data[["small_planters"]]
    diffBuildOrig <-data[["diff_build"]]
    streeFurOrig <- data[["street_furnit"]]
    basColOrig <- data[["basic_col"]]
    lighOrig <- data[["lights"]]
    accenColOrig <-  data[["accent_col"]]
    peopOrig <- data[["people"]]
    graffOrig <- data[["graffiti"]]
    buildDiffAgesOrig <- data[["build_diff_ages"]]
    streetWidOrig <- data[["street_wid"]]
    sidewalkWidOrig <- data[["sidewalk_wid"]]
    buildHeightOrig <- data[["build_height"]]
    longSightOrig <- data[["long_sight"]]
    debrisOrig <- data[["debris"]]
    pavementOrig <- data[["pavement"]]
    landscapeOrig <- data[["landscape"]]
    propStreetWallOrig <- data[["prop_street_wall"]]
    propWindOrig <- data[["prop_wind"]]
    propSkyAheadOrig <- data[["prop_sky_ahead"]]
    propSkyAcrossOrig <- data[["prop_sky_across"]]  
    propActiveUseOrig <- data[["prop_active_use"]]
    
    movCars <- parkCars <- movCicly<- buildId <- buildNRec <- tree <- smallPla <- diffBuild <- streeFur <- basCol <- ligh <- accenCol<- peop <- graff <- buildDiffAges <- streetWid <- sidewalkWid <- buildHeight <- longSight <- 0
    debris <- pavement <- landscape <- propStreetWall <- propWind <- propSkyAhead <- propSkyAcross <-  propActiveUse <- c()
    movCarsMax <- parkCarsMax <- movCiclyMax <- buildIdMax <- buildNRecMax <- treeMax <- smallPlaMax <- diffBuildMax <- streeFurMax <- basColMax <- lighMax <- accenColMax <- peopMax <- graffMax <- buildDiffAgesMax <- streetWidMax <- sidewalkWidMax <- buildHeightMax <- longSightMax <- 0
    debrisMax <- pavementMax <- landscapeMax <- propStreetWallMax <- propWindMax <- propSkyAheadMax <- propSkyAcrossMax <- propActiveUseMax <- c()
    
    #discordantPairs <- list()#Store discordant pairs in order to avoid check and comparisons multiple times!
    
    #First call, comparing for group 1
    for( i in seq(1, amountOfItems) ){
        rankLine1 <- data[i,]
        
        if(i+1 <= amountOfItems){
          
            for( j in seq(i+1, amountOfItems) ){
                rankLine2 <- data[j,]
                
                if( rankLine1[["rank"]] < rankLine2[["rank"]] & rankLine1[["index"]] > rankLine2[["index"]] ){
                    #discordantPairs[[length(discordantPairs) + 1]] <- c(i,j)
                  
                    movCars <- movCars + movCarsOrig[i] - movCarsOrig[j]
                    parkCars <- parkCars + parkCarsOrig[i] - parkCarsOrig[j]
                    movCicly <- movCicly + movCiclyOrig[i] - movCiclyOrig[j]
                    buildId <- buildId + buildIdOrig[i] - buildIdOrig[j]
                    buildNRec <- buildNRec + buildNRecOrig[i] - buildNRecOrig[j]
                    tree <- tree + treeOrig[i] - treeOrig[j]
                    smallPla <- smallPla + smallPlaOrig[i] - smallPlaOrig[j]
                    diffBuild <- diffBuild + diffBuildOrig[i] - diffBuildOrig[j]
                    streeFur <- streeFur + streeFurOrig[i] - streeFurOrig[j]
                    basCol <- basCol + basColOrig[i] - basColOrig[j]
                    ligh <- ligh + lighOrig[i] - lighOrig[j]
                    accenCol <- accenCol + accenColOrig[i] - accenColOrig[j]
                    peop <- peop + peopOrig[i] - peopOrig[j]
                    graff <- graff + as.integer(graffOrig[i]) - as.integer(graffOrig[j])
                    buildDiffAges <- buildDiffAges + as.integer(buildDiffAgesOrig[i]) - as.integer(buildDiffAgesOrig[j])
                    
                    streetWid <- streetWid + as.double(streetWidOrig[i]) - as.double(streetWidOrig[j])
                    sidewalkWid <- sidewalkWid + as.double(sidewalkWidOrig[i]) - as.double(sidewalkWidOrig[j])
                    debris <- cbind(debris, as.double(debrisOrig[i]) - as.double(debrisOrig[j]))
                    pavement <- cbind(pavement, as.double(pavementOrig[i]) - as.double(pavementOrig[j])) 
                    landscape <- cbind(landscape, as.double(landscapeOrig[i]) - as.double(landscapeOrig[j]))
                    propStreetWall <- cbind(propStreetWall, as.double(propStreetWallOrig[i]) - as.double(propStreetWallOrig[j]))
                    propWind <- cbind(propWind, as.double(propWindOrig[i]) - as.double(propWindOrig[j]))
                    longSight <- longSight + as.double(longSightOrig[i]) - as.double(longSightOrig[j])
                    propSkyAhead <- cbind(propSkyAhead, as.double(propSkyAheadOrig[i]) - as.double(propSkyAheadOrig[j]))
                    propSkyAcross <- cbind(propSkyAcross, as.double(propSkyAcrossOrig[i]) - as.double(propSkyAcrossOrig[j]))  
                    buildHeight <- buildHeight + as.double(buildHeightOrig[i]) - as.double(buildHeightOrig[j])
                    propActiveUse <- cbind(propActiveUse, as.double(propActiveUseOrig[i]) - as.double(propActiveUseOrig[j]))
                }  
                
                #Accounting differences for max!
                movCarsMax <- movCarsMax + abs(movCarsOrig[i] - movCarsOrig[j])
                parkCarsMax <- parkCarsMax + abs(parkCarsOrig[i] - parkCarsOrig[j])
                movCiclyMax <- movCiclyMax + abs(movCiclyOrig[i] - movCiclyOrig[j])
                buildIdMax <- buildIdMax + abs(buildIdOrig[i] - buildIdOrig[j])
                buildNRecMax <- buildNRecMax + abs(buildNRecOrig[i] - buildNRecOrig[j])
                treeMax <- treeMax + abs(treeOrig[i] - treeOrig[j])
                smallPlaMax <- smallPlaMax + abs(smallPlaOrig[i] - smallPlaOrig[j])
                diffBuildMax <- diffBuildMax + abs(diffBuildOrig[i] - diffBuildOrig[j])
                streeFurMax <- streeFurMax + abs(streeFurOrig[i] - streeFurOrig[j])
                basColMax <- basColMax + abs(basColOrig[i] - basColOrig[j])
                lighMax <- lighMax + abs(lighOrig[i] - lighOrig[j])
                accenColMax <- accenColMax + abs(accenColOrig[i] - accenColOrig[j])
                peopMax <- peopMax + abs(peopOrig[i] - peopOrig[j])
                graffMax <- graffMax + abs(as.integer(graffOrig[i]) - as.integer(graffOrig[j]))
                buildDiffAgesMax <- buildDiffAgesMax + abs(as.integer(buildDiffAgesOrig[i]) - as.integer(buildDiffAgesOrig[j]))
                
                streetWidMax <- streetWidMax + abs(as.double(streetWidOrig[i]) - as.double(streetWidOrig[j]))
                sidewalkWidMax <- sidewalkWidMax + abs(as.double(sidewalkWidOrig[i]) - as.double(sidewalkWidOrig[j]))
                debrisMax <- cbind(debrisMax, abs(as.double(debrisOrig[i]) - as.double(debrisOrig[j])))
                pavementMax <- cbind(pavementMax, abs(as.double(pavementOrig[i]) - as.double(pavementOrig[j]))) 
                landscapeMax <- cbind(landscapeMax, abs(as.double(landscapeOrig[i]) - as.double(landscapeOrig[j])))
                propStreetWallMax <- cbind(propStreetWallMax, abs(as.double(propStreetWallOrig[i]) - as.double(propStreetWallOrig[j])))
                propWindMax <- cbind(propWindMax, abs(as.double(propWindOrig[i]) - as.double(propWindOrig[j])))
                longSightMax <- longSightMax + abs(as.double(longSightOrig[i]) - as.double(longSightOrig[j]))
                propSkyAheadMax <- cbind(propSkyAheadMax, abs(as.double(propSkyAheadOrig[i]) - as.double(propSkyAheadOrig[j])))
                propSkyAcrossMax <- cbind(propSkyAcrossMax, abs(as.double(propSkyAcrossOrig[i]) - as.double(propSkyAcrossOrig[j]))) 
                buildHeightMax <- buildHeightMax + abs(as.double(buildHeightOrig[i]) - as.double(buildHeightOrig[j]))
                propActiveUseMax <- cbind(propActiveUseMax, abs(as.double(propActiveUseOrig[i]) - as.double(propActiveUseOrig[j])))
            }
        }
    }
    
    #Real world mean values for grades and proportions
    if( length(debris) > 0 ){
      featuresMapG1[["movCars"]] <- movCars
      featuresMapG1[["parkCars"]] <- parkCars
      featuresMapG1[["movCicly"]] <- movCicly
      featuresMapG1[["buildId"]] <- buildId
      featuresMapG1[["buildNRec"]] <- buildNRec
      featuresMapG1[["tree"]] <- tree
      featuresMapG1[["smallPla"]] <- smallPla
      featuresMapG1[["diffBuild"]] <- diffBuild
      featuresMapG1[["streeFur"]] <- streeFur
      featuresMapG1[["basCol"]] <- basCol
      featuresMapG1[["ligh"]] <- ligh
      featuresMapG1[["accenCol"]] <- accenCol
      featuresMapG1[["peop"]] <- peop
      featuresMapG1[["graff"]] <- graff
      featuresMapG1[["buildDiffAges"]] <- buildDiffAges
      featuresMapG1[["streetWid"]] <- streetWid
      featuresMapG1[["sidewalkWid"]] <- sidewalkWid
      featuresMapG1[["buildHeight"]] <- buildHeight
      featuresMapG1[["longSight"]] <- longSight
      
      featuresMapG1[["debris"]] <- .Internal(mean(debris))
      featuresMapG1[["pavement"]] <- .Internal(mean(pavement))
      featuresMapG1[["landscape"]]<- .Internal(mean(landscape))
      featuresMapG1[["propStreetWall"]] <- .Internal(mean(propStreetWall))
      featuresMapG1[["propWind"]] <- .Internal(mean(propWind))
      featuresMapG1[["propStreetWall"]] <- .Internal(mean(propStreetWall))
      featuresMapG1[["propWind"]] <- .Internal(mean(propWind))
      featuresMapG1[["propSkyAhead"]] <- .Internal(mean(propSkyAhead))
      featuresMapG1[["propSkyAcross"]] <- .Internal(mean(propSkyAcross))
      featuresMapG1[["propActiveUse"]] <- .Internal(mean(propActiveUse))
    }
    debrisMax <- .Internal(mean(debrisMax))
    pavementMax <- .Internal(mean(pavementMax))
    landscapeMax <- .Internal(mean(landscapeMax))
    propStreetWallMax <- .Internal(mean(propStreetWallMax))
    propWindMax <- .Internal(mean(propWindMax))
    propStreetWallMax <- .Internal(mean(propStreetWallMax))
    propWindMax <- .Internal(mean(propWindMax))
    propSkyAheadMax <- .Internal(mean(propSkyAheadMax))
    propSkyAcrossMax <- .Internal(mean(propSkyAcrossMax))
    propActiveUseMax <- .Internal(mean(propActiveUseMax))
    
    #Random world
    movCars <- parkCars <- movCicly <- buildId <- buildNRec <- tree <- smallPla <- diffBuild <-streeFur <- basCol <- ligh <-  accenCol <- peop <- graff <- buildDiffAges <- streetWid <- sidewalkWid <- longSight <- buildHeight <- debris <- pavement <- landscape <- propStreetWall <- propWind <-  propSkyAhead <- propSkyAcross <- propActiveUse <- c()
    
    for (k in seq(1, iterations)){
        #randomIndex <- sample(data[["index)
        randomCols <- sample(c("mov_cars", "park_cars", "mov_ciclyst", "build_ident", "build_nrectan", "trees", "small_planters", "diff_build", "street_furnit", "basic_col", "lights", "accent_col", "people", "graffiti", "build_diff_ages", "street_wid", "sidewalk_wid", "debris", "pavement", "landscape", "prop_street_wall", "prop_wind", "long_sight", "prop_sky_ahead",  "prop_sky_across", "build_height", "prop_active_use"))
        movCarsR <- parkCarsR <- movCiclyR <- buildIdR <- buildNRecR <- treeR <- smallPlaR <- diffBuildR <- streeFurR <- basColR <- lighR <-  accenColR <- peopR <- graffR <- buildDiffAgesR <- streetWidR <- sidewalkWidR <- longSightR <- buildHeightR <- 0
        debrisR <- pavementR <- landscapeR <- propStreetWallR <- propWindR <- propSkyAheadR <- propSkyAcrossR <- propActiveUseR <- c()
        
         for( i in seq(1, amountOfItems) ){
            rankLine1 <- data[i,]
            
            sampledQScores <- sample(c(rankLine1[[group1Id]], rankLine1[[group2Id]]))#Sampling for image i
            
            if(i+1 <= amountOfItems){
                for( j in seq(i+1, amountOfItems) ){
                    rankLine2 <- data[j,]
                    
                    sampledQScores2 <- sample(c(rankLine2[[group1Id]], rankLine2[[group2Id]]))#Sampling for image j
      	            if (!is.na(sampledQScores) & !is.na(sampledQScores2)){                
                        if( (sampledQScores[1] < sampledQScores2[1] & sampledQScores[2] > sampledQScores2[2]) | (sampledQScores[1] > sampledQScores2[1] & sampledQScores[2] < sampledQScores2[2]) ){
  #         if(length(discordantPairs) > 0){
  #               for(j in seq(1, length(discordantPairs))){
  #                      index1 <- discordantPairs[[j]][1] 
  #                      index2 <- discordantPairs[[j]][2]
  #                      rankLine1 <- data[index1,]
  #                      rankLine2 <- data[index2,]
                               
                              if( sampledQScores[1] < sampledQScores2[1] & sampledQScores[2] > sampledQScores2[2]) {
                        				firstImage <- j#Best ranked image for first group
                      					secondImage <- i
                    			    }else if(sampledQScores[1] > sampledQScores2[1] & sampledQScores[2] < sampledQScores2[2]){
                      					firstImage <- i#Best ranked image for first group
                      					secondImage <- j
        			               }
        		            
        		            movCarsR <- movCarsR +  movCarsOrig[firstImage] - movCarsOrig[secondImage]
        		            parkCarsR <- parkCarsR +  parkCarsOrig[firstImage] - parkCarsOrig[secondImage] 
        		            movCiclyR <- movCiclyR +  movCiclyOrig[firstImage] - movCiclyOrig[secondImage]
        		            buildIdR <- buildIdR +  buildIdOrig[firstImage] - buildIdOrig[secondImage]
        		            buildNRecR <- buildNRecR +  buildNRecOrig[firstImage] - buildNRecOrig[secondImage]
        		            treeR <- treeR +  treeOrig[firstImage] - treeOrig[secondImage]
        		            smallPlaR <- smallPlaR +  smallPlaOrig[firstImage] - smallPlaOrig[secondImage]
        		            diffBuildR <- diffBuildR +  diffBuildOrig[firstImage] - diffBuildOrig[secondImage]
        		            streeFurR <- streeFurR +  streeFurOrig[firstImage] - streeFurOrig[secondImage]
        		            basColR <- basColR +  basColOrig[firstImage] - basColOrig[secondImage]
        		            lighR <- lighR +  lighOrig[firstImage] - lighOrig[secondImage]
        		            accenColR <- accenColR +  accenColOrig[firstImage] - accenColOrig[secondImage]
        		            peopR <- peopR + peopOrig[firstImage] - peopOrig[secondImage]
        		            graffR <- graffR + as.integer(graffOrig[firstImage]) - as.integer(graffOrig[secondImage])
        		            buildDiffAgesR <- buildDiffAgesR + as.integer(buildDiffAgesOrig[firstImage]) - as.integer(buildDiffAgesOrig[secondImage])
        		                      
        		            streetWidR <- streetWidR + streetWidOrig[firstImage] - streetWidOrig[secondImage]
        		            sidewalkWidR <- sidewalkWidR + sidewalkWidOrig[firstImage] - sidewalkWidOrig[secondImage]
        		            debrisR <- cbind(debrisR, debrisOrig[firstImage] - debrisOrig[secondImage])
        		            pavementR <- cbind(pavementR, pavementOrig[firstImage] - pavementOrig[secondImage])
        		            landscapeR <- cbind(landscapeR, landscapeOrig[firstImage] - landscapeOrig[secondImage])
        		            propStreetWallR <- cbind(propStreetWallR, propStreetWallOrig[firstImage] - propStreetWallOrig[secondImage])
        		            propWindR <- cbind(propWindR, propWindOrig[firstImage] - propWindOrig[secondImage])
        		            longSightR <- longSightR + longSightOrig[firstImage] - longSightOrig[secondImage]
        		            propSkyAheadR <- cbind(propSkyAheadR, propSkyAheadOrig[firstImage] - propSkyAheadOrig[secondImage])
        		            propSkyAcrossR <- cbind(propSkyAcrossR, propSkyAcrossOrig[firstImage] - propSkyAcrossOrig[secondImage])
        		            buildHeightR <- buildHeightR + buildHeightOrig[firstImage] - buildHeightOrig[secondImage]
        		            propActiveUseR <- cbind(propActiveUseR, propActiveUseOrig[firstImage] - propActiveUseOrig[secondImage])
                }
              }
           }
         }
        }
        
        #Binding with previous iterations
        if( length(debrisR) > 0 ) {
            movCars <- cbind(movCars, movCarsR)
            parkCars <- cbind(parkCars, parkCarsR)
            movCicly <- cbind(movCicly, movCiclyR)
            buildId <- cbind(buildId, buildIdR)
            buildNRec <- cbind(buildNRec, buildNRecR)
            tree <- cbind(tree, treeR)
            smallPla <- cbind(smallPla, smallPlaR)
            diffBuild <- cbind(diffBuild, diffBuildR)
            streeFur <- cbind(streeFur, streeFurR)
            basCol <- cbind(basCol, basColR)
            ligh <-  cbind(ligh, lighR)
            accenCol <- cbind(accenCol, accenColR)
            peop <- cbind(peop, peopR)
            graff <- cbind(graff, graffR)
            buildDiffAges <- cbind(buildDiffAges, buildDiffAgesR)
                    
            streetWid <- cbind(streetWid, streetWidR)
            sidewalkWid <- cbind(sidewalkWid, sidewalkWidR)
            longSight <- cbind(longSight, longSightR)
            buildHeight <- cbind(buildHeight, buildHeightR)
            debris <- cbind(debris, .Internal(mean(debrisR)))
            pavement <- cbind(pavement, .Internal(mean(pavementR)))
            landscape <- cbind(landscape, .Internal(mean(landscapeR)))
            propStreetWall <- cbind(propStreetWall, .Internal(mean(propStreetWallR)))
            propWind <- cbind(propWind, .Internal(mean(propWindR)))
            propSkyAhead <- cbind(propSkyAhead, .Internal(mean(propSkyAheadR)))
            propSkyAcross <- cbind(propSkyAcross, .Internal(mean(propSkyAcrossR)))
            propActiveUse <- cbind(propActiveUse, .Internal(mean(propActiveUseR)))
        }
    }
    
    #Random world mean
    if(length(movCars) > 0){
        featuresMapG1[["rmovCars"]] <- .Internal(mean(movCars)) 
        featuresMapG1[["rparkCars"]] <- .Internal(mean(parkCars))
        featuresMapG1[["rmovCicly"]] <- .Internal(mean(movCicly))
        featuresMapG1[["rbuildId"]] <- .Internal(mean(buildId))
        featuresMapG1[["rbuildNRec"]] <- .Internal(mean(buildNRec))
        featuresMapG1[["rtree"]] <- .Internal(mean(tree))
        featuresMapG1[["rsmallPla"]] <- .Internal(mean(smallPla))
        featuresMapG1[["rdiffBuild"]] <- .Internal(mean(diffBuild))
        featuresMapG1[["rstreeFur"]] <- .Internal(mean(streeFur))
        featuresMapG1[["rbasCol"]] <- .Internal(mean(basCol)) 
        featuresMapG1[["rligh"]] <- .Internal(mean(ligh))
        featuresMapG1[["raccenCol"]] <- .Internal(mean(accenCol))
        featuresMapG1[["rpeop"]] <- .Internal(mean(peop))
        featuresMapG1[["rgraff"]] <- .Internal(mean(graff)) 
        featuresMapG1[["rbuildDiffAges"]] <- .Internal(mean(buildDiffAges))
        
        featuresMapG1[["rstreetWid"]] <- .Internal(mean(streetWid))
        featuresMapG1[["rsidewalkWid"]] <- .Internal(mean(sidewalkWid))
        featuresMapG1[["rlongSight"]] <- .Internal(mean(longSight))
        featuresMapG1[["rbuildHeight"]] <- .Internal(mean(buildHeight))
        featuresMapG1[["rdebris"]] <- .Internal(mean(debris))
        featuresMapG1[["rpavement"]] <- .Internal(mean(pavement))
        featuresMapG1[["rlandscape"]] <- .Internal(mean(landscape))
        featuresMapG1[["rpropStreetWall"]] <- .Internal(mean(propStreetWall))
        featuresMapG1[["rpropWind"]] <- .Internal(mean(propWind))
        featuresMapG1[["rpropSkyAhead"]] <- .Internal(mean(propSkyAhead))
        featuresMapG1[["rpropSkyAcross"]] <- .Internal(mean(propSkyAcross))
        featuresMapG1[["rpropActiveUse"]] <- .Internal(mean(propActiveUse))
    }    
    
    featuresMapG1[["rsdMovCars"]] <- sd(movCars) 
    featuresMapG1[["rsdParkCars"]] <- sd(parkCars)
    featuresMapG1[["rsdMovCicly"]] <- sd(movCicly)
    featuresMapG1[["rsdBuildId"]] <- sd(buildId) 
    featuresMapG1[["rsdBuildNRec"]] <- sd(buildNRec) 
    featuresMapG1[["rsdTree"]] <- sd(tree)
    featuresMapG1[["rsdSmallPla"]] <- sd(smallPla)
    featuresMapG1[["rsdDiffBuild"]] <- sd(diffBuild)
    featuresMapG1[["rsdStreeFur"]] <- sd(streeFur) 
    featuresMapG1[["rsdBasCol"]] <- sd(basCol) 
    featuresMapG1[["rsdLigh"]] <- sd(ligh)
    featuresMapG1[["rsdAccenCol"]] <- sd(accenCol) 
    featuresMapG1[["rsdPeop"]] <- sd(peop) 
    featuresMapG1[["rsdGraff"]] <- sd(graff) 
    featuresMapG1[["rsdBuildDiffAges"]] <- sd(buildDiffAges)
    
    featuresMapG1[["rsdStreetWid"]] <- sd(streetWid)
    featuresMapG1[["rsdSidewalkWid"]] <- sd(sidewalkWid)
    featuresMapG1[["rsdLongSight"]] <- sd(longSight)
    featuresMapG1[["rsdBuildHeight"]] <- sd(buildHeight)
    featuresMapG1[["rsdDebris"]] <- sd(debris)
    featuresMapG1[["rsdPavement"]] <- sd(pavement)
    featuresMapG1[["rsdLandscape"]] <- sd(landscape)
    featuresMapG1[["rsdPropStreetWall"]] <- sd(propStreetWall)
    featuresMapG1[["rsdPropWind"]] <- sd(propWind)
    featuresMapG1[["rsdPropSkyAhead"]] <- sd(propSkyAhead)
    featuresMapG1[["rsdPropSkyAcross"]] <- sd(propSkyAcross)
    featuresMapG1[["rsdPropActiveUse"]] <- sd(propActiveUse)
    
    #Adding random mean values - normalized
    if(length(movCars) > 0){
          featuresMapG1[["rmovCarsN"]] <- .Internal(mean(movCars)) / movCarsMax#/ (maxMovCars*den)
          featuresMapG1[["rparkCarsN"]] <- .Internal(mean(parkCars)) / parkCarsMax#/ (maxParkCars*den)
          featuresMapG1[["rmovCiclyN"]] <- .Internal(mean(movCicly)) / movCiclyMax #/ (maxMovCicly*den)
          featuresMapG1[["rbuildIdN"]] <- .Internal(mean(buildId)) / buildIdMax#/ (maxBuildId*den)
          featuresMapG1[["rbuildNRecN"]] <- .Internal(mean(buildNRec)) / buildNRecMax#/ (maxBuildNRec*den)
          featuresMapG1[["rtreeN"]] <- .Internal(mean(tree)) / treeMax#/ (maxTree*den)
          featuresMapG1[["rsmallPlaN"]] <- .Internal(mean(smallPla)) / smallPlaMax#/ (maxSmallPla*den)
          featuresMapG1[["rdiffBuildN"]] <- .Internal(mean(diffBuild)) / diffBuildMax#/ (maxDiffBuild*den)
          featuresMapG1[["rstreeFurN"]] <- .Internal(mean(streeFur)) / streeFurMax#/ (maxStreeFur*den)
          featuresMapG1[["rbasColN"]] <- .Internal(mean(basCol)) / basColMax#/ (maxBasCol*den)
          featuresMapG1[["rlighN"]] <- .Internal(mean(ligh)) / lighMax#/ (maxLigh*den)
          featuresMapG1[["raccenColN"]] <- .Internal(mean(accenCol)) / accenColMax#/ (maxAccenCol*den)
          featuresMapG1[["rpeopN"]] <- .Internal(mean(peop)) / peopMax#/ (maxPeop*den)
          featuresMapG1[["rgraffN"]] <- .Internal(mean(graff)) / graffMax#/ (maxGraff*den)
          featuresMapG1[["rbuildDiffAgesN"]] <- .Internal(mean(buildDiffAges)) / buildDiffAgesMax#/ (maxBuildDiffAges*den)

          featuresMapG1[["rstreetWidN"]] <- .Internal(mean(streetWid)) / streetWidMax
          featuresMapG1[["rsidewalkWidN"]] <- .Internal(mean(sidewalkWid)) / sidewalkWidMax
          featuresMapG1[["rdebrisN"]] <- .Internal(mean(debris)) / debrisMax
          featuresMapG1[["rpavementN"]] <- .Internal(mean(pavement)) / pavementMax
          featuresMapG1[["rlandscapeN"]] <- .Internal(mean(landscape)) / landscapeMax
          featuresMapG1[["rpropStreetWallN"]] <- .Internal(mean(propStreetWall)) / propStreetWallMax
          featuresMapG1[["rpropWindN"]] <- .Internal(mean(propWind)) / propWindMax
          featuresMapG1[["rlongSightN"]] <- .Internal(mean(longSight)) / longSightMax
          featuresMapG1[["rpropSkyAheadN"]] <- .Internal(mean(propSkyAhead)) / propSkyAheadMax
          featuresMapG1[["rpropSkyAcrossN"]] <- .Internal(mean(propSkyAcross)) / propSkyAcrossMax
          featuresMapG1[["rbuildHeightN"]] <- .Internal(mean(buildHeight)) / buildHeightMax
          featuresMapG1[["rpropActiveUseN"]] <- .Internal(mean(propActiveUse)) / propActiveUseMax
    }

    #Normalizing real values
    featuresMapG1[["movCarsN"]] <- featuresMapG1[["movCars"]] / movCarsMax#(maxMovCars*den)
    featuresMapG1[["parkCarsN"]] <- featuresMapG1[["parkCars"]]  / parkCarsMax#(maxParkCars*den)
    featuresMapG1[["movCiclyN"]] <-  featuresMapG1[["movCicly"]] / movCiclyMax#(maxMovCicly*den)
    featuresMapG1[["buildIdN"]] <- featuresMapG1[["buildId"]]/ buildIdMax#(maxBuildId*den)
    featuresMapG1[["buildNRecN"]] <- featuresMapG1[["buildNRec"]] / buildNRecMax#(maxBuildNRec*den)
    featuresMapG1[["treeN"]] <- featuresMapG1[["tree"]] / treeMax#(maxTree*den)
    featuresMapG1[["smallPlaN"]] <- featuresMapG1[["smallPla"]] / smallPlaMax#(maxSmallPla*den)
    featuresMapG1[["diffBuildN"]] <- featuresMapG1[["diffBuild"]] / diffBuildMax#(maxDiffBuild*den)
    featuresMapG1[["streeFurN"]] <- featuresMapG1[["streeFur"]] / streeFurMax#(maxStreeFur*den)
    featuresMapG1[["basColN"]] <- featuresMapG1[["basCol"]] / basColMax#(maxBasCol*den)
    featuresMapG1[["lighN"]] <- featuresMapG1[["ligh"]] / lighMax#(maxLigh*den)
    featuresMapG1[["accenColN"]] <- featuresMapG1[["accenCol"]] / accenColMax#(maxAccenCol*den)
    featuresMapG1[["peopN"]] <- featuresMapG1[["peop"]]  / peopMax#(maxPeop*den)
    featuresMapG1[["graffN"]] <- featuresMapG1[["graff"]]/ graffMax#(maxGraff*den)
    featuresMapG1[["buildDiffAgesN"]] <- featuresMapG1[["buildDiffAges"]] / buildDiffAgesMax#(maxBuildDiffAges*den)
    featuresMapG1[["streetWidN"]] <- featuresMapG1[["streetWid"]] / streetWidMax
    featuresMapG1[["sidewalkWidN"]] <- featuresMapG1[["sidewalkWid"]] / sidewalkWidMax
    featuresMapG1[["debrisN"]] <- featuresMapG1[["debris"]] / debrisMax
    featuresMapG1[["pavementN"]] <- featuresMapG1[["pavement"]] / pavementMax
    featuresMapG1[["landscapeN"]] <- featuresMapG1[["landscape"]] / landscapeMax
    featuresMapG1[["propStreetWallN"]] <- featuresMapG1[["propStreetWall"]] / propStreetWallMax
    featuresMapG1[["propWindN"]] <- featuresMapG1[["propWind"]] / propWindMax
    featuresMapG1[["longSightN"]] <- featuresMapG1[["longSight"]] / longSightMax
    featuresMapG1[["propSkyAheadN"]] <- featuresMapG1[["propSkyAhead"]] / propSkyAheadMax
    featuresMapG1[["propSkyAcrossN"]] <- featuresMapG1[["propSkyAcross"]] / propSkyAcrossMax
    featuresMapG1[["buildHeightN"]] <- featuresMapG1[["buildHeight"]] / buildHeightMax
    featuresMapG1[["propActiveUseN"]] <- featuresMapG1[["propActiveUse"]] / propActiveUseMax
    
    return ( featuresMapG1 )
}

#DEPRECATED Calculates maximum denominator for normalization
calcGreatesSum <- function(maxFeature, amountOfImages) {
  sumFeat <- 0
	maxDiff <- amountOfImages - 1
	reuse <- FALSE

	for (i in seq(1, amountOfImages)){
		sumFeat <- sumFeat + maxFeature * (maxDiff)		
		if(maxDiff == 0 | maxDiff == 1){
			maxDiff <- amountOfImages - 1
		}else{
			maxDiff <- maxDiff - 2
		}
	}
	return (sumFeat)
}

#DEPRECATED Evaluates presence and coefficients for each picture
calcDanieleCoeff <- function (data) {
    data$diff <- data$rank - data$index
    
    data$movCars <- (data$mov_cars * (data$diff/107)) / sum(data$mov_cars)
    data$parkCars <- (data$park_cars * (data$diff/107)) / sum(data$park_cars)
    data$movCicly <- (data$mov_ciclyst * (data$diff/107)) / sum(data$mov_ciclyst)
    data$buildId <- (data$build_ident * (data$diff/107)) / sum(data$build_ident)
    data$buildNRec <- (data$build_nrectan * (data$diff/107)) / sum(data$build_nrectan)
    data$tree <- (data$trees * (data$diff/107)) / sum(data$trees)
    data$smallPla <- (data$small_planters * (data$diff/107)) / sum(data$small_planters)
    data$diffBuild <- (data$diff_build * (data$diff/107)) / sum(data$diff_build)
    data$streeFur <- (data$street_furnit * (data$diff/107)) / sum(data$street_furnit)
    data$basCol <- (data$basic_col * (data$diff/107)) / sum(data$basic_col)
    data$ligh <- (data$lights * (data$diff/107)) / sum(data$lights)
    data$accenCol <- (data$accent_col * (data$diff/107)) / sum(data$accent_col)
    data$peop <- (data$people * (data$diff/107)) / sum(data$people)
    
    data$graffiti <- as.character(data$graffiti)
    data$graffiti[data$graffiti == "No"] <- 0
    data$graffiti[data$graffiti == "Yes"] <- 1
    data$graff <- (data$diff/107 * as.integer(data$graffiti)) / sum(as.integer(data$graffiti))
    data$build_diff_ages <- as.character(data$build_diff_ages)
    data$build_diff_ages[data$build_diff_ages == "No"] <- 0
    data$build_diff_ages[data$build_diff_ages == "yes"] <- 1
    data$buildDiffAges <- (data$diff/107 * as.integer(data$build_diff_ages)) / sum(as.integer(data$build_diff_ages))
    
    data$movCars2 <- (data$mov_cars * abs(data$diff))
    data$parkCars2 <- (data$park_cars * abs(data$diff))
    data$movCicly2 <- (data$mov_ciclyst * abs(data$diff))
    data$buildId2 <- (data$build_ident * abs(data$diff))
    data$buildNRec2 <- (data$build_nrectan * abs(data$diff))
    data$tree2 <- (data$trees * abs(data$diff))
    data$diffBuild2 <- (data$diff_build * abs(data$diff))
    data$streeFur2 <- (data$street_furnit * abs(data$diff))
    data$smallPla2 <- (data$small_planters * abs(data$diff))
    data$basCol2 <- (data$basic_col * abs(data$diff))
    data$ligh2 <- (data$lights * abs(data$diff))
    data$accenCol2 <- (data$accent_col * abs(data$diff))
    data$peop2 <- (data$people * abs(data$diff))
    data$graff2 <- (abs(data$diff) * as.integer(data$graffiti)) 
    data$buildDiffAges2 <- (abs(data$diff) * as.integer(data$build_diff_ages)) 

    size <- nrow(data)
    data$sumMovCars <- calcGreatesSum(max(data$mov_cars),  size)
    data$sumParkCars <- calcGreatesSum(max(data$park_cars), size)
    data$sumMovCicly <- calcGreatesSum(max(data$mov_ciclyst), size)
    data$sumBuildId <- calcGreatesSum(max(data$build_ident),size)
    data$sumBuildNRec <- calcGreatesSum(max(data$build_nrectan),size)
    data$sumTree <- calcGreatesSum(max(data$trees),size)
    data$sumSmallPla <- calcGreatesSum(max(data$small_planters),size)
    data$sumDiffBuild <- calcGreatesSum(max(data$diff_build),size)
    data$sumStreeFur <- calcGreatesSum(max(data$street_furnit),size)
    data$sumBasCol <- calcGreatesSum(max(data$basic_col),size)
    data$sumLigh <-  calcGreatesSum(max(data$lights),size)
    data$sumAccenCol <- calcGreatesSum(max(data$accent_col),size)
    data$sumPeop <- calcGreatesSum(max(data$people),size)
    data$sumGraff <- calcGreatesSum(max(as.integer(data$graffiti)),size)
    data$sumBuildDiffAges <- calcGreatesSum(max(as.integer(data$build_diff_ages)),size)

    data$maxMovCars <- max(data$mov_cars)
    data$maxParkCars <- max(data$park_cars)
    data$maxMovCicly <- max(data$mov_ciclyst)
    data$maxBuildId <- max(data$build_ident)
    data$maxBuildNRec <- max(data$build_nrectan)
    data$maxTree <- max(data$trees)
    data$maxSmallPla <- max(data$small_planters)
    data$maxDiffBuild <- max(data$diff_build)
    data$maxStreeFur <- max(data$street_furnit)
    data$maxBasCol <- max(data$basic_col)
    data$maxLigh <- max(data$lights)
    data$maxAccenCol <- max(data$accent_col)
    data$maxPeop <- max(data$people)
    data$maxGraff <- max(as.integer(data$graffiti))
    data$maxBuildDiffAges <- max(as.integer(data$build_diff_ages))

    return (data)
}

#DEPRECATED
randomizeCoeff <- function (data, iterations) {
    movCars <- parkCars <- movCicly <- buildId <- buildNRec <- tree <- smallPla <- diffBuild <-streeFur <- basCol <- ligh <-  accenCol <- peop <- graff <- buildDiffAges <- deb <- pav <- land <- propStreetWall <- propWind <- propSkyAhe <- propActiv <- streetW <- sidewalW <- buildHei <- c()
    
    movCars2 <- parkCars2 <- movCicly2 <- buildId2 <- buildNRec2 <- tree2 <- smallPla2 <- diffBuild2 <- streeFur2 <- basCol2 <- ligh2 <-  accenCol2 <- peop2 <- graff2 <- buildDiffAges2 <- deb2 <- pav2 <- land2 <- propStreetWall2 <- propWind2 <- propSkyAhe2 <- propActiv2 <- streetW2 <- sidewalW2 <- buildHei2 <- c()
    
    graffiti <- as.character(data$graffiti)
    graffiti[data$graffiti == "No"] <- 0
    graffiti[data$graffiti == "Yes"] <- 1
    build_diff_ages <- as.character(data$build_diff_ages)
    build_diff_ages[data$build_diff_ages == "No"] <- 0
    build_diff_ages[data$build_diff_ages == "yes"] <- 1
    
    for (i in seq(1, iterations)){#Creating shuffled values
    
        differences <- sample(data$diff)
        
        movCars <- cbind(movCars, (data$mov_cars * differences[2]/107) / sum(data$mov_cars))
        parkCars <- cbind(parkCars, (data$park_cars * differences[3]/107) / sum(data$park_cars))
        movCicly <- cbind(movCicly, (data$mov_ciclyst * differences[4]/107) / sum(data$mov_ciclyst))
        buildId <- cbind(buildId, (data$build_ident * differences[8])/107 / sum(data$build_ident))
        buildNRec <- cbind(buildNRec,(data$build_nrectan * differences[9]/107) / sum(data$build_nrectan))
        tree <- cbind(tree,(data$trees * differences[15]/107) / sum(data$trees))
        smallPla <- cbind(smallPla,(data$small_planters * differences[16]/107) / sum(data$small_planters))
        diffBuild <- cbind(diffBuild,(data$diff_build * differences[19]/107) / sum(data$diff_build))
        streeFur <- cbind(streeFur, (data$street_furnit * differences[20]/107) / sum(data$street_furnit))
        basCol <- cbind(basCol, (data$basic_col * differences[21]/107) / sum(data$basic_col))
        ligh <- cbind(ligh, (data$lights * differences[22]/107) / sum(data$lights))
        accenCol <- cbind(accenCol, (data$accent_col * differences[23]/107) / sum(data$accent_col))
        peop <- cbind(peop, (data$people * differences[24]/107) / sum(data$people))
        
        graff <- cbind(graff, (differences[14]/107 * as.integer(data$graffiti)) / sum(as.integer(data$graffiti)))
        buildDiffAges <- cbind(buildDiffAges, (differences[18]/107 * as.integer(data$build_diff_ages)) / sum(as.integer(data$build_diff_ages)))
        
        movCars2 <- cbind(movCars2, (data$mov_cars * abs(differences[2])))
        parkCars2 <- cbind(parkCars2, (data$park_cars * abs(differences[3])))
        movCicly2 <- cbind(movCicly2, (data$mov_ciclyst * abs(differences[4])))
        buildId2 <- cbind(buildId2, (data$build_ident * abs(differences[8])))
        buildNRec2 <- cbind(buildNRec2,(data$build_nrectan * abs(differences[9])))
        tree2 <- cbind(tree2,(data$trees * abs(differences[15])))
        smallPla2 <- cbind(smallPla2,(data$small_planters * abs(differences[16])))
        diffBuild2 <- cbind(diffBuild2,(data$diff_build * abs(differences[19])))
        streeFur2 <- cbind(streeFur2, (data$street_furnit * abs(differences[20])))
        basCol2 <- cbind(basCol2, (data$basic_col * abs(differences[21])))
        ligh2 <- cbind(ligh2, (data$lights * abs(differences[22])))
        accenCol2 <- cbind(accenCol2, (data$accent_col * abs(differences[23])))
        peop2 <- cbind(peop2, (data$people * abs(differences[24])))
        
        graff2 <- cbind(graff2, (abs(differences[14]) * as.integer(data$graffiti))) 
        buildDiffAges2 <- cbind(buildDiffAges2, (abs(differences[18]) * as.integer(data$build_diff_ages)))
        
    }    
    
        #Shuffle mean and sd
        data$rmovCars <- apply(movCars, 1, mean)
        data$rsdmovCars <- apply(movCars, 1, sd)
        data$rparkCars <- apply(parkCars, 1, mean)
        data$rsdparkCars <- apply(parkCars, 1, sd)
        data$rmovCicly <- apply(movCicly, 1, mean)
        data$rsdmovCicly <- apply(movCicly, 1, sd)
        data$rbuildId <- apply(buildId, 1, mean)
        data$rsdbuildId <- apply(buildId, 1, sd)
        data$rbuildNRec <- apply(buildNRec, 1, mean)
        data$rsdbuildNRec <- apply(buildNRec, 1, sd)
        data$rtree <- apply(tree, 1, mean)
        data$rsdtree <- apply(tree, 1, sd)
        data$rsmallPla <- apply(smallPla, 1, mean)
        data$rsdsmallPla <- apply(smallPla, 1, sd)
        data$rdiffBuild <- apply(diffBuild, 1, mean)
        data$rsddiffBuild <- apply(diffBuild, 1, sd)
        data$rstreeFur <- apply(streeFur, 1, mean)
        data$rsdstreeFur <- apply(streeFur, 1, sd)
        data$rbasCol <- apply(basCol, 1, mean)
        data$rsdbasCol <- apply(basCol, 1, sd)
        data$rligh <- apply(ligh, 1, mean)
        data$rsdligh <- apply(ligh, 1, sd)
        data$raccenCol <- apply(accenCol, 1, mean)
        data$rsdaccenCol <- apply(accenCol, 1, sd)
        data$rpeop <- apply(peop, 1, mean)
        data$rsdpeop <- apply(peop, 1, sd)
        
        data$rgraff <- apply(graff, 1, mean)
        data$rsdgraff <- apply(graff, 1, sd)
        data$rbuildDiffAges <- apply(buildDiffAges, 1, mean)
        data$rsdbuildDiffAges <- apply(buildDiffAges, 1, sd)

        #Shuffle mean and sd
        data$rmovCars2 <- apply(movCars2, 1, mean)
        data$rsdmovCars2 <- apply(movCars2, 1, sd)
        data$rparkCars2 <- apply(parkCars2, 1, mean)
        data$rsdparkCars2 <- apply(parkCars2, 1, sd)
        data$rmovCicly2 <- apply(movCicly2, 1, mean)
        data$rsdmovCicly2 <- apply(movCicly2, 1, sd)
        data$rbuildId2 <- apply(buildId2, 1, mean)
        data$rsdbuildId2 <- apply(buildId2, 1, sd)
        data$rbuildNRec2 <- apply(buildNRec2, 1, mean)
        data$rsdbuildNRec2 <- apply(buildNRec2, 1, sd)
        data$rtree2 <- apply(tree2, 1, mean)
        data$rsdtree2 <- apply(tree2, 1, sd)
        data$rsmallPla2 <- apply(smallPla2, 1, mean)
        data$rsdsmallPla2 <- apply(smallPla2, 1, sd)
        data$rdiffBuild2 <- apply(diffBuild2, 1, mean)
        data$rsddiffBuild2 <- apply(diffBuild2, 1, sd)
        data$rstreeFur2 <- apply(streeFur2, 1, mean)
        data$rsdstreeFur2 <- apply(streeFur2, 1, sd)
        data$rbasCol2 <- apply(basCol2, 1, mean)
        data$rsdbasCol2 <- apply(basCol2, 1, sd)
        data$rligh2 <- apply(ligh2, 1, mean)
        data$rsdligh2 <- apply(ligh2, 1, sd)
        data$raccenCol2 <- apply(accenCol2, 1, mean)
        data$rsdaccenCol2 <- apply(accenCol2, 1, sd)
        data$rpeop2 <- apply(peop2, 1, mean)
        data$rsdpeop2 <- apply(peop2, 1, sd)
        
        data$rgraff2 <- apply(graff2, 1, mean)
        data$rsdgraff2 <- apply(graff2, 1, sd)
        data$rbuildDiffAges2 <- apply(buildDiffAges2, 1, mean)
        data$rsdbuildDiffAges2 <- apply(buildDiffAges2, 1, sd)
        
    return (data)
}

#DEPRECATED
simulateCoefShuffle <- function(agrad.l, iterations){

  cmov <- cpark <- ccic <- cbuiid <- cbuiNR <- ctree <- csmalP <- cdiffB <- cfur <- cbcol <- clig <- cacol <- cgraf <- cdiffA <- cdeb <- cpav <- clan <- cwall <- cwind <- cskyA <- cskyAc <- cstreet <- cside <- cbuiH <- cpeop <- cacti <- 0
  
  agrad.l2 <- randomizeCoeff(agrad.l, iterations)

  print("### P-values for Coeff - Flavio")
  res <- wilcox.test(agrad.l$movCars2, agrad.l2$rmovCars2, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
   cmov = res$p.value

    res <- wilcox.test(agrad.l$parkCars2, agrad.l2$rparkCars2, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    cpark = res$p.value

    res <- wilcox.test(agrad.l$movCicly2, agrad.l2$rmovCicly2, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    ccic = res$p.value

    res <- wilcox.test(agrad.l$buildId2, agrad.l2$rbuildId2, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    cbuiid = res$p.value

    res <- wilcox.test(agrad.l$buildNRec2, agrad.l2$rbuildNRec2, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    cbuiNR = res$p.value

    res <- wilcox.test(agrad.l$tree2, agrad.l2$rtree2, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    ctree = res$p.value

    res <- wilcox.test(agrad.l$smallPla2, agrad.l2$rsmallPla2, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    csmalP= res$p.value

    res <- wilcox.test(agrad.l$diffBuild2, agrad.l2$rdiffBuild2, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    cdiffB = res$p.value

    res <- wilcox.test(agrad.l$streeFur2, agrad.l2$rstreeFur2, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    cfur = res$p.value

    res <- wilcox.test(agrad.l$basCol2, agrad.l2$rbasCol2, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    cbcol = res$p.value

    res <- wilcox.test(agrad.l$ligh2, agrad.l2$rligh2, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    clig = res$p.value

    res <- wilcox.test(agrad.l$accenCol2, agrad.l2$raccenCol2, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    cacol = res$p.value

    res <- wilcox.test(agrad.l$peop2, agrad.l2$rpeop2, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    cpeop = res$p.value
    
    res <- wilcox.test(agrad.l$graff2, agrad.l2$rgraff2, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    cgraf = res$p.value

    res <- wilcox.test(agrad.l$buildDiffAges2, agrad.l2$rbuildDiffAges2, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    cdiffA = res$p.value

    
  print(paste("P-values - mov cars", cmov)) #/ iterations))
  print(paste("P-values - park cars", cpark)) #/ iterations))
  print(paste("P-values - cyclists", ccic)) #/ iterations))
  print(paste("P-values - build ident", cbuiid)) #/ iterations))
  print(paste("P-values - build n rect", cbuiNR)) #/ iterations))
  print(paste("P-values - trees", ctree)) #/ iterations))
  print(paste("P-values - small planters",csmalP))# / iterations))
  print(paste("P-values - diff buildings", cdiffB)) #/ iterations))
  print(paste("P-values - furniture", cfur)) #/ iterations))
  print(paste("P-values - bas col", cbcol)) #/ iterations))
  print(paste("P-values - acce col", cacol)) #/ iterations))
  print(paste("P-values - lig", clig)) #/ iterations))
  print(paste("P-values - peop", cpeop)) #/ iterations))
  print(paste("P-values - graffiti", cgraf)) #/ iterations))
  print(paste("P-values - build diff ages", cdiffA)) #/ iterations))

print("### P-values for Coeff - Daniele")
  res <- wilcox.test(agrad.l$movCars, agrad.l2$rmovCars, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
   cmov = res$p.value

    res <- wilcox.test(agrad.l$parkCars, agrad.l2$rparkCars, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    cpark = res$p.value

    res <- wilcox.test(agrad.l$movCicly, agrad.l2$rmovCicly, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    ccic = res$p.value

    res <- wilcox.test(agrad.l$buildId, agrad.l2$rbuildId, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    cbuiid = res$p.value

    res <- wilcox.test(agrad.l$buildNRec, agrad.l2$rbuildNRec, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    cbuiNR = res$p.value

    res <- wilcox.test(agrad.l$tree, agrad.l2$rtree, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    ctree = res$p.value

    res <- wilcox.test(agrad.l$smallPla, agrad.l2$rsmallPla, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    csmalP= res$p.value

    res <- wilcox.test(agrad.l$diffBuild, agrad.l2$rdiffBuild, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    cdiffB = res$p.value

    res <- wilcox.test(agrad.l$streeFur, agrad.l2$rstreeFur, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    cfur = res$p.value

    res <- wilcox.test(agrad.l$basCol, agrad.l2$rbasCol, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    cbcol = res$p.value

    res <- wilcox.test(agrad.l$ligh, agrad.l2$rligh, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    clig = res$p.value

    res <- wilcox.test(agrad.l$accenCol, agrad.l2$raccenCol, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    cacol = res$p.value

    res <- wilcox.test(agrad.l$peop, agrad.l2$rpeop, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    cpeop = res$p.value
    
    res <- wilcox.test(agrad.l$graff, agrad.l2$rgraff, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    cgraf = res$p.value

    res <- wilcox.test(agrad.l$buildDiffAges, agrad.l2$rbuildDiffAges, na.action = na.exclude, conf.int = TRUE, paired = TRUE)
    cdiffA = res$p.value

    
  print(paste("P-values - mov cars", cmov)) #/ iterations))
  print(paste("P-values - park cars", cpark)) #/ iterations))
  print(paste("P-values - cyclists", ccic)) #/ iterations))
  print(paste("P-values - build ident", cbuiid)) #/ iterations))
  print(paste("P-values - build n rect", cbuiNR)) #/ iterations))
  print(paste("P-values - trees", ctree)) #/ iterations))
  print(paste("P-values - small planters",csmalP))# / iterations))
  print(paste("P-values - diff buildings", cdiffB)) #/ iterations))
  print(paste("P-values - furniture", cfur)) #/ iterations))
  print(paste("P-values - bas col", cbcol)) #/ iterations))
  print(paste("P-values - acce col", cacol)) #/ iterations))
  print(paste("P-values - lig", clig)) #/ iterations))
  print(paste("P-values - peop", cpeop)) #/ iterations))
  print(paste("P-values - graffiti", cgraf)) #/ iterations))
  print(paste("P-values - build diff ages", cdiffA)) #/ iterations))


  return (agrad.l2)

}
#DEPRECATED
printOutputOneListPerFeature <- function(agrad.l2, column1, column2){
     print(">>>>>>>> One list - top 10 ordered by real world coef and containing real world and shuffle world data - Daniele")
      print(head(arrange(select_(agrad.l2, "movCars", "rmovCars", "rsdmovCars", "maxMovCars", "sumMovCars", "image_url", column1, column2, "diff"), desc(movCars)), n = 10))
      print(head(arrange(select_(agrad.l2, "parkCars", "rparkCars", "rsdparkCars", "maxParkCars","sumParkCars", "image_url", column1, column2, "diff"), desc(parkCars)), n = 10))
      print(head(arrange(select_(agrad.l2, "movCicly", "rmovCicly", "rsdmovCicly", "maxMovCicly", "sumMovCicly", "image_url", column1, column2, "diff"), desc(movCicly)), n = 10))
      print(head(arrange(select_(agrad.l2, "buildId", "rbuildId", "rsdbuildId", "maxBuildId", "sumBuildId","image_url", column1, column2, "diff"), desc(buildId)), n = 10))
      print(head(arrange(select_(agrad.l2, "buildNRec", "rbuildNRec", "rsdbuildNRec", "maxBuildNRec", "sumBuildNRec", "image_url", column1, column2, "diff"), desc(buildNRec)), n = 10))
      print(head(arrange(select_(agrad.l2, "tree", "rtree", "rsdtree", "maxTree", "sumTree", "image_url", column1, column2, "diff"), desc(tree)), n = 10))
      print(head(arrange(select_(agrad.l2, "smallPla", "rsmallPla", "rsdsmallPla", "maxSmallPla","sumSmallPla", "image_url", column1, column2, "diff"), desc(smallPla)), n = 10))
      print(head(arrange(select_(agrad.l2, "diffBuild", "rdiffBuild", "rsddiffBuild", "maxDiffBuild", "sumDiffBuild","image_url", column1, column2, "diff"), desc(diffBuild)), n = 10))
      print(head(arrange(select_(agrad.l2, "streeFur", "rstreeFur", "rsdstreeFur", "maxStreeFur", "sumStreeFur", "image_url", column1, column2, "diff"), desc(streeFur)), n = 10))
      print(head(arrange(select_(agrad.l2, "basCol", "rbasCol", "rsdbasCol", "maxBasCol", "sumBasCol", "image_url", column1, column2, "diff"), desc(basCol)), n = 10))
      print(head(arrange(select_(agrad.l2, "accenCol", "raccenCol", "rsdaccenCol", "maxAccenCol", "sumAccenCol","image_url", column1, column2, "diff"), desc(accenCol)), n = 10))
      print(head(arrange(select_(agrad.l2, "ligh", "rligh", "rsdligh", "maxLigh", "sumLigh","image_url", column1, column2, "diff"), desc(ligh)), n = 10))
      print(head(arrange(select_(agrad.l2, "peop", "rpeop", "rsdpeop", "maxPeop", "sumPeop","image_url", column1, column2, "diff"), desc(peop)), n = 10))
      print(head(arrange(select_(agrad.l2, "graff", "rgraff", "rsdgraff", "maxGraff", "sumGraff","image_url", column1, column2, "diff"), desc(graff)), n = 10))
      print(head(arrange(select_(agrad.l2, "buildDiffAges", "rbuildDiffAges", "rsdbuildDiffAges", "maxBuildDiffAges", "sumBuildDiffAges","image_url", column1, column2, "diff"), desc(buildDiffAges)), n = 10))


     print(">>>>>>>> One list - top 10 ordered by real world coef and containing real world and shuffle world data - Flavio")
      print(head(arrange(select_(agrad.l2, "movCars2", "rmovCars2", "rsdmovCars2", "maxMovCars", "sumMovCars", "image_url", column1, column2, "diff"), desc(movCars2)), n = 10))
      print(head(arrange(select_(agrad.l2, "parkCars2", "rparkCars2", "rsdparkCars2", "maxParkCars", "sumParkCars","image_url", column1, column2, "diff"), desc(parkCars2)), n = 10))
      print(head(arrange(select_(agrad.l2, "movCicly2", "rmovCicly2", "rsdmovCicly2", "maxMovCicly", "sumMovCicly","image_url", column1, column2, "diff"), desc(movCicly2)), n = 10))
      print(head(arrange(select_(agrad.l2, "buildId2", "rbuildId2", "rsdbuildId2", "maxBuildId", "sumBuildId","image_url", column1, column2, "diff"), desc(buildId2)), n = 10))
      print(head(arrange(select_(agrad.l2, "buildNRec2", "rbuildNRec2", "rsdbuildNRec2", "maxBuildNRec", "sumBuildNRec","image_url", column1, column2, "diff"), desc(buildNRec2)), n = 10))
      print(head(arrange(select_(agrad.l2, "tree2", "rtree2", "rsdtree2", "maxTree", "sumTree", "image_url", column1, column2, "diff"), desc(tree2)), n = 10))
      print(head(arrange(select_(agrad.l2, "smallPla2", "rsmallPla2", "rsdsmallPla2", "maxSmallPla", "sumSmallPla","image_url", column1, column2, "diff"), desc(smallPla2)), n = 10))
      print(head(arrange(select_(agrad.l2, "diffBuild2", "rdiffBuild2", "rsddiffBuild2", "maxDiffBuild", "sumDiffBuild","image_url", column1, column2, "diff"), desc(diffBuild2)), n = 10))
      print(head(arrange(select_(agrad.l2, "streeFur2", "rstreeFur2", "rsdstreeFur2", "maxStreeFur", "sumStreeFur", "image_url", column1, column2, "diff"), desc(streeFur2)), n = 10))
      print(head(arrange(select_(agrad.l2, "basCol2", "rbasCol2", "rsdbasCol2", "maxBasCol", "sumBasCol","image_url", column1, column2, "diff"), desc(basCol2)), n = 10))
      print(head(arrange(select_(agrad.l2, "accenCol2", "raccenCol2", "rsdaccenCol2", "maxAccenCol", "sumAccenCol","image_url", column1, column2, "diff"), desc(accenCol2)), n = 10))
      print(head(arrange(select_(agrad.l2, "ligh2", "rligh2", "rsdligh2", "maxLigh",  "sumLigh","image_url", column1, column2, "diff"), desc(ligh2)), n = 10))
      print(head(arrange(select_(agrad.l2, "peop2", "rpeop2", "rsdpeop2", "maxPeop", "sumPeop","image_url", column1, column2, "diff"), desc(peop2)), n = 10))
      print(head(arrange(select_(agrad.l2, "graff2", "rgraff2", "rsdgraff2", "maxGraff", "sumGraff","image_url", column1, column2, "diff"), desc(graff2)), n = 10))
      print(head(arrange(select_(agrad.l2, "buildDiffAges2", "rbuildDiffAges2", "rsdbuildDiffAges2", "maxBuildDiffAges","sumBuildDiffAges", "image_url", column1, column2, "diff"), desc(buildDiffAges2)), n = 10))
  
}
#DEPRECATED
printOutputTwoListsPerFeature <- function(agrad.l2, column1, column2){
      print(">>>>>>>> Two lists - top 10 ordered by real world coef ; top 10 ordered by shuffle world - Daniele")

      print(head(arrange(select_(agrad.l2, "movCars", "maxMovCars", "image_url", column1, column2, "diff"), desc(movCars)), n = 10))
      print(head(arrange(select_(agrad.l2, "rmovCars", "rsdmovCars", "maxMovCars", "image_url", column1, column2, "diff"), desc(rmovCars)), n = 10))
      print(head(arrange(select_(agrad.l2, "parkCars", "maxParkCars", "image_url", column1, column2, "diff"), desc(parkCars)), n = 10))
      print(head(arrange(select_(agrad.l2, "rparkCars", "rsdparkCars", "maxParkCars", "image_url", column1, column2, "diff"), desc(rparkCars)), n = 10))
      print(head(arrange(select_(agrad.l2, "movCicly", "maxMovCicly", "image_url", column1, column2, "diff"), desc(movCicly)), n = 10))
      print(head(arrange(select_(agrad.l2, "rmovCicly", "rsdmovCicly", "maxMovCicly", "image_url", column1, column2, "diff"), desc(rmovCicly)), n = 10))
      print(head(arrange(select_(agrad.l2, "buildId", "maxBuildId", "image_url", column1, column2, "diff"), desc(buildId)), n = 10))
      print(head(arrange(select_(agrad.l2, "rbuildId", "rsdbuildId", "maxBuildId", "image_url", column1, column2, "diff"), desc(rbuildId)), n = 10))
      print(head(arrange(select_(agrad.l2, "buildNRec", "maxBuildNRec", "image_url", column1, column2, "diff"), desc(buildNRec)), n = 10))
      print(head(arrange(select_(agrad.l2, "rbuildNRec", "rsdbuildNRec", "maxBuildNRec", "image_url", column1, column2, "diff"), desc(rbuildNRec)), n = 10))
      print(head(arrange(select_(agrad.l2, "tree", "maxTree", "image_url", column1, column2, "diff"), desc(tree)), n = 10))
      print(head(arrange(select_(agrad.l2, "rtree", "rsdtree", "maxTree", "image_url", column1, column2, "diff"), desc(rtree)), n = 10))
      print(head(arrange(select_(agrad.l2, "smallPla", "maxSmallPla", "image_url", column1, column2, "diff"), desc(smallPla)), n = 10))
      print(head(arrange(select_(agrad.l2, "rsmallPla", "rsdsmallPla", "maxSmallPla", "image_url", column1, column2, "diff"), desc(rsmallPla)), n = 10))
      print(head(arrange(select_(agrad.l2, "diffBuild", "maxDiffBuild", "image_url", column1, column2, "diff"), desc(diffBuild)), n = 10))
      print(head(arrange(select_(agrad.l2, "rdiffBuild", "rsddiffBuild", "maxDiffBuild", "image_url", column1, column2, "diff"), desc(rdiffBuild)), n = 10))
      print(head(arrange(select_(agrad.l2, "streeFur", "maxStreeFur", "image_url", column1, column2, "diff"), desc(streeFur)), n = 10))
      print(head(arrange(select_(agrad.l2, "rstreeFur", "rsdstreeFur", "maxStreeFur", "image_url", column1, column2, "diff"), desc(rstreeFur)), n = 10))
      print(head(arrange(select_(agrad.l2, "basCol", "maxBasCol", "image_url", column1, column2, "diff"), desc(basCol)), n = 10))
      print(head(arrange(select_(agrad.l2, "rbasCol", "rsdbasCol", "maxBasCol", "image_url", column1, column2, "diff"), desc(rbasCol)), n = 10))
      print(head(arrange(select_(agrad.l2, "accenCol", "maxAccenCol", "image_url", column1, column2, "diff"), desc(accenCol)), n = 10))
      print(head(arrange(select_(agrad.l2, "raccenCol", "rsdaccenCol", "maxAccenCol", "image_url", column1, column2, "diff"), desc(raccenCol)), n = 10))
      print(head(arrange(select_(agrad.l2, "ligh", "maxLigh", "image_url", column1, column2, "diff"), desc(ligh)), n = 10))
      print(head(arrange(select_(agrad.l2, "rligh", "rsdligh", "maxLigh", "image_url", column1, column2, "diff"), desc(rligh)), n = 10))
      print(head(arrange(select_(agrad.l2, "peop", "maxPeop", "image_url", column1, column2, "diff"), desc(peop)), n = 10))
      print(head(arrange(select_(agrad.l2, "rpeop", "rsdpeop", "maxPeop", "image_url", column1, column2, "diff"), desc(rpeop)), n = 10))
      print(head(arrange(select_(agrad.l2, "graff", "maxGraff", "image_url", column1, column2, "diff"), desc(graff)), n = 10))
      print(head(arrange(select_(agrad.l2, "rgraff", "rsdgraff", "maxGraff", "image_url", column1, column2, "diff"), desc(rgraff)), n = 10))
      print(head(arrange(select_(agrad.l2, "buildDiffAges", "maxBuildDiffAges", "image_url", column1, column2, "diff"), desc(buildDiffAges)), n = 10))
      print(head(arrange(select_(agrad.l2, "rbuildDiffAges", "rsdbuildDiffAges", "maxBuildDiffAges", "image_url", column1, column2, "diff"), desc(rbuildDiffAges)), n = 10))


      print(">>>>>>>> Two lists - top 10 ordered by real world coef ; top 10 ordered by shuffle world - Flavio")
      print(head(arrange(select_(agrad.l2, "movCars2", "maxMovCars", "sumMovCars","image_url", column1, column2, "diff"), desc(movCars2)), n = 10))
      print(head(arrange(select_(agrad.l2, "rmovCars2", "rsdmovCars2", "maxMovCars", "sumMovCars", "image_url", column1, column2, "diff"), desc(rmovCars2)), n = 10))
      print(head(arrange(select_(agrad.l2, "parkCars2", "maxParkCars", "sumParkCars","image_url", column1, column2, "diff"), desc(parkCars2)), n = 10))
      print(head(arrange(select_(agrad.l2, "rparkCars2", "rsdparkCars2", "maxParkCars", "sumParkCars","image_url", column1, column2, "diff"), desc(rparkCars2)), n = 10))
      print(head(arrange(select_(agrad.l2, "movCicly2", "maxMovCicly", "sumMovCicly","image_url", column1, column2, "diff"), desc(movCicly2)), n = 10))
      print(head(arrange(select_(agrad.l2, "rmovCicly2", "rsdmovCicly2", "maxMovCicly", "sumMovCicly","image_url", column1, column2, "diff"), desc(rmovCicly2)), n = 10))
      print(head(arrange(select_(agrad.l2, "buildId2", "maxBuildId", "sumBuildId","image_url", column1, column2, "diff"), desc(buildId2)), n = 10))
      print(head(arrange(select_(agrad.l2, "rbuildId2", "rsdbuildId2", "maxBuildId", "sumBuildId","image_url", column1, column2, "diff"), desc(rbuildId2)), n = 10))
      print(head(arrange(select_(agrad.l2, "buildNRec2", "maxBuildNRec", "sumBuildNRec","image_url", column1, column2, "diff"), desc(buildNRec2)), n = 10))
      print(head(arrange(select_(agrad.l2, "rbuildNRec2", "rsdbuildNRec2", "maxBuildNRec", "sumBuildNRec","image_url", column1, column2, "diff"), desc(rbuildNRec2)), n = 10))
      print(head(arrange(select_(agrad.l2, "tree2", "maxTree", "sumTree","image_url", column1, column2, "diff"), desc(tree2)), n = 10))
      print(head(arrange(select_(agrad.l2, "rtree2", "rsdtree2", "maxTree", "sumTree","image_url", column1, column2, "diff"), desc(rtree2)), n = 10))
      print(head(arrange(select_(agrad.l2, "smallPla2", "maxSmallPla", "sumSmallPla","image_url", column1, column2, "diff"), desc(smallPla2)), n = 10))
      print(head(arrange(select_(agrad.l2, "rsmallPla2", "rsdsmallPla2", "maxSmallPla", "sumSmallPla","image_url", column1, column2, "diff"), desc(rsmallPla2)), n = 10))
      print(head(arrange(select_(agrad.l2, "diffBuild2", "maxDiffBuild", "sumDiffBuild","image_url", column1, column2, "diff"), desc(diffBuild2)), n = 10))
      print(head(arrange(select_(agrad.l2, "rdiffBuild2", "rsddiffBuild2", "maxDiffBuild", "sumDiffBuild","image_url", column1, column2, "diff"), desc(rdiffBuild2)), n = 10))
      print(head(arrange(select_(agrad.l2, "streeFur2", "maxStreeFur", "sumStreeFur","image_url", column1, column2, "diff"), desc(streeFur2)), n = 10))
      print(head(arrange(select_(agrad.l2, "rstreeFur2", "rsdstreeFur2", "maxStreeFur", "sumStreeFur","image_url", column1, column2, "diff"), desc(rstreeFur2)), n = 10))
      print(head(arrange(select_(agrad.l2, "basCol2", "maxBasCol", "sumBasCol","image_url", column1, column2, "diff"), desc(basCol2)), n = 10))
      print(head(arrange(select_(agrad.l2, "rbasCol2", "rsdbasCol2", "maxBasCol", "sumBasCol","image_url", column1, column2, "diff"), desc(rbasCol2)), n = 10))
      print(head(arrange(select_(agrad.l2, "accenCol2", "maxAccenCol", "sumAccenCol","image_url", column1, column2, "diff"), desc(accenCol2)), n = 10))
      print(head(arrange(select_(agrad.l2, "raccenCol2", "rsdaccenCol2", "maxAccenCol", "sumAccenCol","image_url", column1, column2, "diff"), desc(raccenCol2)), n = 10))
      print(head(arrange(select_(agrad.l2, "ligh2", "maxLigh",  "sumLigh","image_url", column1, column2, "diff"), desc(ligh2)), n = 10))
      print(head(arrange(select_(agrad.l2, "rligh2", "rsdligh2", "maxLigh", "sumLigh","image_url", column1, column2, "diff"), desc(rligh2)), n = 10))
      print(head(arrange(select_(agrad.l2, "peop2", "maxPeop", "sumPeop","image_url", column1, column2, "diff"), desc(peop2)), n = 10))
      print(head(arrange(select_(agrad.l2, "rpeop2", "rsdpeop2", "maxPeop", "sumPeop","image_url", column1, column2, "diff"), desc(rpeop2)), n = 10))
      print(head(arrange(select_(agrad.l2, "graff2", "maxGraff","sumGraff", "image_url", column1, column2, "diff"), desc(graff2)), n = 10))
      print(head(arrange(select_(agrad.l2, "rgraff2", "rsdgraff2", "maxGraff", "sumGraff","image_url", column1, column2, "diff"), desc(rgraff2)), n = 10))
      print(head(arrange(select_(agrad.l2, "buildDiffAges2", "maxBuildDiffAges", "sumBuildDiffAges","image_url", column1, column2, "diff"), desc(buildDiffAges2)), n = 10))
      print(head(arrange(select_(agrad.l2, "rbuildDiffAges2", "rsdbuildDiffAges2", "maxBuildDiffAges", "sumBuildDiffAges","image_url", column1, column2, "diff"), desc(rbuildDiffAges2)), n = 10))
  
}
#DEPRECATED
printOutputTwoListsAllFeaturesTog <- function(agrad.l2){
      library(reshape)

      print(">>>>>>>> One list with all features together with Daniele coeff - real world and shuffle world")
      all <- melt(select(agrad.l2, movCars, parkCars, movCicly, buildId, buildNRec, tree, smallPla, diffBuild, streeFur, basCol, ligh, accenCol, peop, graff, buildDiffAges, image_url), id=c("image_url"))
      
      all$random <- 0
      all[all$variable == "movCars",]$random<- sum(agrad.l2$rmovCars)
      all[all$variable == "parkCars",]$random<- sum(agrad.l2$rparkCars)
      all[all$variable == "movCicly",]$random<- sum(agrad.l2$rmovCicly)
      all[all$variable == "buildId",]$random<- sum(agrad.l2$rbuildId)
      all[all$variable == "buildNRec",]$random<- sum(agrad.l2$rbuildNRec)
      all[all$variable == "tree",]$random<- sum(agrad.l2$rtree)
      all[all$variable == "smallPla",]$random<- sum(agrad.l2$rsmallPla)
      all[all$variable == "diffBuild",]$random<- sum(agrad.l2$rdiffBuild)
      all[all$variable == "streeFur",]$random<- sum(agrad.l2$rstreeFur)
      all[all$variable == "basCol",]$random<- sum(agrad.l2$rbasCol)
      all[all$variable == "accenCol",]$random<- sum(agrad.l2$raccenCol)
      all[all$variable == "peop",]$random<- sum(agrad.l2$rpeop)
      all[all$variable == "buildDiffAges",]$random<- sum(agrad.l2$rbuildDiffAges)
      all[all$variable == "graff",]$random<- sum(agrad.l2$rgraff)
      all[all$variable == "ligh",]$random<- sum(agrad.l2$rligh)
      all$sd <- 0
      all[all$variable == "movCars",]$sd <- agrad.l2$rsdmovCars
      all[all$variable == "parkCars",]$sd <- agrad.l2$rsdparkCars
      all[all$variable == "movCicly",]$sd <- agrad.l2$rsdmovCicly
      all[all$variable == "buildId",]$sd <- agrad.l2$rsdbuildId
      all[all$variable == "buildNRec",]$sd <- agrad.l2$rsdbuildNRec
      all[all$variable == "tree",]$sd <- agrad.l2$rsdtree
      all[all$variable == "smallPla",]$sd <- agrad.l2$rsdsmallPla
      all[all$variable == "diffBuild",]$sd <- agrad.l2$rsddiffBuild
      all[all$variable == "streeFur",]$sd <- agrad.l2$rsdstreeFur
      all[all$variable == "basCol",]$sd <- agrad.l2$rsdbasCol
      all[all$variable == "accenCol",]$sd <- agrad.l2$rsdaccenCol
      all[all$variable == "peop",]$sd <- agrad.l2$rsdpeop
      all[all$variable == "buildDiffAges",]$sd <- agrad.l2$rsdbuildDiffAges
      all[all$variable == "graff",]$sd <- agrad.l2$rsdgraff
      all[all$variable == "ligh",]$sd <- agrad.l2$rsdligh

      print("### All")
      print("##### Summary")
      print( all %>% group_by(variable) %>% summarise( som=sum(value), rand=mean(random), std=mean(sd) ) %>% arrange(desc(som)) )
      print("##### List")
      print( arrange(all, desc(value)) )
      
      print(">>>>>>>> Two lists with all features together with Daniele coeff - real world and shuffle world")
      real <- melt(select(agrad.l2, movCars, parkCars, movCicly, buildId, buildNRec, tree, smallPla, diffBuild, streeFur, basCol, ligh, accenCol, peop, graff, buildDiffAges, image_url), id=c("image_url"))
      
      shuff <- melt(select(agrad.l2, rmovCars, rparkCars, rmovCicly, rbuildId, rbuildNRec, rtree, rsmallPla, rdiffBuild, rstreeFur, rbasCol, rligh, raccenCol, rpeop, rgraff, rbuildDiffAges, image_url), id=c("image_url"))
      shuff$sd <- 0
      shuff[shuff$variable == "rmovCars",]$sd <- agrad.l2$rsdmovCars
      shuff[shuff$variable == "rparkCars",]$sd <- agrad.l2$rsdparkCars
      shuff[shuff$variable == "rmovCicly",]$sd <- agrad.l2$rsdmovCicly
      shuff[shuff$variable == "rbuildId",]$sd <- agrad.l2$rsdbuildId
      shuff[shuff$variable == "rbuildNRec",]$sd <- agrad.l2$rsdbuildNRec
      shuff[shuff$variable == "rtree",]$sd <- agrad.l2$rsdtree
      shuff[shuff$variable == "rsmallPla",]$sd <- agrad.l2$rsdsmallPla
      shuff[shuff$variable == "rdiffBuild",]$sd <- agrad.l2$rsddiffBuild
      shuff[shuff$variable == "rstreeFur",]$sd <- agrad.l2$rsdstreeFur
      shuff[shuff$variable == "rbasCol",]$sd <- agrad.l2$rsdbasCol
      shuff[shuff$variable == "raccenCol",]$sd <- agrad.l2$rsdaccenCol
      shuff[shuff$variable == "rpeop",]$sd <- agrad.l2$rsdpeop
      shuff[shuff$variable == "rbuildDiffAges",]$sd <- agrad.l2$rsdbuildDiffAges
      shuff[shuff$variable == "rgraff",]$sd <- agrad.l2$rsdgraff
      shuff[shuff$variable == "rligh",]$sd <- agrad.l2$rsdligh

      print("### Real")
      print("##### Summary")
      print( real %>% group_by(variable) %>% summarise( som=sum(value) ) %>% arrange(desc(som)) )
      print("##### List")
      print( arrange(real, desc(value)) )
      print("### Shuffle")
      print("##### Summary")
      print( shuff %>% group_by(variable) %>% summarise( som=sum(value), std=mean(sd) ) %>% arrange(desc(som)) )
      print("##### List")
      print( arrange(shuff, desc(value)) )

       print(">>>>>>>> One list with all features together with Flavio coeff - real world and shuffle world")
       all <- melt(select(agrad.l2, movCars2, parkCars2, movCicly2, buildId2, buildNRec2, tree2, smallPla2, diffBuild2, streeFur2, basCol2, ligh2, accenCol2, peop2, graff2, buildDiffAges2, image_url), id=c("image_url"))
      
      all$sumDen <- 0
      all[all$variable == "movCars2",]$sumDen <- agrad.l2$sumMovCars
      all[all$variable == "parkCars2",]$sumDen <- agrad.l2$sumParkCars
      all[all$variable == "movCicly2",]$sumDen <- agrad.l2$sumMovCicly
      all[all$variable == "buildId2",]$sumDen <- agrad.l2$sumBuildId
      all[all$variable == "buildNRec2",]$sumDen <- agrad.l2$sumBuildNRec
      all[all$variable == "tree2",]$sumDen <- agrad.l2$sumTree
      all[all$variable == "smallPla2",]$sumDen <- agrad.l2$sumSmallPla
      all[all$variable == "diffBuild2",]$sumDen <- agrad.l2$sumDiffBuild
      all[all$variable == "streeFur2",]$sumDen <- agrad.l2$sumStreeFur
      all[all$variable == "basCol2",]$sumDen <- agrad.l2$sumBasCol
      all[all$variable == "accenCol2",]$sumDen <- agrad.l2$sumAccenCol
      all[all$variable == "peop2",]$sumDen <- agrad.l2$sumPeop
      all[all$variable == "buildDiffAges2",]$sumDen <- agrad.l2$sumBuildDiffAges
      all[all$variable == "graff2",]$sumDen <- agrad.l2$sumGraff
      all[all$variable == "ligh2",]$sumDen <- agrad.l2$sumLigh

      all$random <- 0
      all[all$variable == "movCars2",]$random<- sum(agrad.l2$rmovCars2)
      all[all$variable == "parkCars2",]$random<- sum(agrad.l2$rparkCars2)
      all[all$variable == "movCicly2",]$random<- sum(agrad.l2$rmovCicly2)
      all[all$variable == "buildId2",]$random<- sum(agrad.l2$rbuildId2)
      all[all$variable == "buildNRec2",]$random<- sum(agrad.l2$rbuildNRec2)
      all[all$variable == "tree2",]$random<- sum(agrad.l2$rtree2)
      all[all$variable == "smallPla2",]$random<- sum(agrad.l2$rsmallPla2)
      all[all$variable == "diffBuild2",]$random<- sum(agrad.l2$rdiffBuild2)
      all[all$variable == "streeFur2",]$random<- sum(agrad.l2$rstreeFur2)
      all[all$variable == "basCol2",]$random<- sum(agrad.l2$rbasCol2)
      all[all$variable == "accenCol2",]$random<- sum(agrad.l2$raccenCol2)
      all[all$variable == "peop2",]$random<- sum(agrad.l2$rpeop2)
      all[all$variable == "buildDiffAges2",]$random<- sum(agrad.l2$rbuildDiffAges2)
      all[all$variable == "graff2",]$random<- sum(agrad.l2$rgraff2)
      all[all$variable == "ligh2",]$random<- sum(agrad.l2$rligh2)
      all$sd <- 0
      all[all$variable == "movCars2",]$sd <- agrad.l2$rsdmovCars2
      all[all$variable == "parkCars2",]$sd <- agrad.l2$rsdparkCars2
      all[all$variable == "movCicly2",]$sd <- agrad.l2$rsdmovCicly2
      all[all$variable == "buildId2",]$sd <- agrad.l2$rsdbuildId2
      all[all$variable == "buildNRec2",]$sd <- agrad.l2$rsdbuildNRec2
      all[all$variable == "tree2",]$sd <- agrad.l2$rsdtree2
      all[all$variable == "smallPla2",]$sd <- agrad.l2$rsdsmallPla2
      all[all$variable == "diffBuild2",]$sd <- agrad.l2$rsddiffBuild2
      all[all$variable == "streeFur2",]$sd <- agrad.l2$rsdstreeFur2
      all[all$variable == "basCol2",]$sd <- agrad.l2$rsdbasCol2
      all[all$variable == "accenCol2",]$sd <- agrad.l2$rsdaccenCol2
      all[all$variable == "peop2",]$sd <- agrad.l2$rsdpeop2
      all[all$variable == "buildDiffAges2",]$sd <- agrad.l2$rsdbuildDiffAges2
      all[all$variable == "graff2",]$sd <- agrad.l2$rsdgraff2
      all[all$variable == "ligh2",]$sd <- agrad.l2$rsdligh2
      print("### All")
      print("##### Summary")
      print( all %>% group_by(variable) %>% summarise( som=sum(value)/mean(sumDen), rand=mean(random)/mean(sumDen), std=mean(sd)/mean(sumDen) ) %>% arrange(desc(som)) )
      print("##### List")
      print( arrange(all, desc(value)) )
      
      print(">>>>>>>> Two lists with all features together Flavio coeff - real world and shuffle world")
      real <- melt(select(agrad.l2, movCars2, parkCars2, movCicly2, buildId2, buildNRec2, tree2, smallPla2, diffBuild2, streeFur2, basCol2, ligh2, accenCol2, peop2, graff2, buildDiffAges2, image_url), id=c("image_url"))
      real$sumDen <- 0
      real[real$variable == "movCars2",]$sumDen <- agrad.l2$sumMovCars
      real[real$variable == "parkCars2",]$sumDen <- agrad.l2$sumParkCars
      real[real$variable == "movCicly2",]$sumDen <- agrad.l2$sumMovCicly
      real[real$variable == "buildId2",]$sumDen <- agrad.l2$sumBuildId
      real[real$variable == "buildNRec2",]$sumDen <- agrad.l2$sumBuildNRec
      real[real$variable == "tree2",]$sumDen <- agrad.l2$sumTree
      real[real$variable == "smallPla2",]$sumDen <- agrad.l2$sumSmallPla
      real[real$variable == "diffBuild2",]$sumDen <- agrad.l2$sumDiffBuild
      real[real$variable == "streeFur2",]$sumDen <- agrad.l2$sumStreeFur
      real[real$variable == "basCol2",]$sumDen <- agrad.l2$sumBasCol
      real[real$variable == "accenCol2",]$sumDen <- agrad.l2$sumAccenCol
      real[real$variable == "peop2",]$sumDen <- agrad.l2$sumPeop
      real[real$variable == "buildDiffAges2",]$sumDen <- agrad.l2$sumBuildDiffAges
      real[real$variable == "graff2",]$sumDen <- agrad.l2$sumGraff
      real[real$variable == "ligh2",]$sumDen <- agrad.l2$sumLigh
      
      shuff <- melt(select(agrad.l2, rmovCars2, rparkCars2, rmovCicly2, rbuildId2, rbuildNRec2, rtree2, rsmallPla2, rdiffBuild2, rstreeFur2, rbasCol2, rligh2, raccenCol2, rpeop2, rgraff2, rbuildDiffAges2, image_url), id=c("image_url"))
      shuff$sd <- 0
      shuff[shuff$variable == "rmovCars2",]$sd <- agrad.l2$rsdmovCars2
      shuff[shuff$variable == "rparkCars2",]$sd <- agrad.l2$rsdparkCars2
      shuff[shuff$variable == "rmovCicly2",]$sd <- agrad.l2$rsdmovCicly2
      shuff[shuff$variable == "rbuildId2",]$sd <- agrad.l2$rsdbuildId2
      shuff[shuff$variable == "rbuildNRec2",]$sd <- agrad.l2$rsdbuildNRec2
      shuff[shuff$variable == "rtree2",]$sd <- agrad.l2$rsdtree2
      shuff[shuff$variable == "rsmallPla2",]$sd <- agrad.l2$rsdsmallPla2
      shuff[shuff$variable == "rdiffBuild2",]$sd <- agrad.l2$rsddiffBuild2
      shuff[shuff$variable == "rstreeFur2",]$sd <- agrad.l2$rsdstreeFur2
      shuff[shuff$variable == "rbasCol2",]$sd <- agrad.l2$rsdbasCol2
      shuff[shuff$variable == "raccenCol2",]$sd <- agrad.l2$rsdaccenCol2
      shuff[shuff$variable == "rpeop2",]$sd <- agrad.l2$rsdpeop2
      shuff[shuff$variable == "rbuildDiffAges2",]$sd <- agrad.l2$rsdbuildDiffAges2
      shuff[shuff$variable == "rgraff2",]$sd <- agrad.l2$rsdgraff2
      shuff[shuff$variable == "rligh2",]$sd <- agrad.l2$rsdligh2

      shuff$sumDen <- 0
      shuff[shuff$variable == "rmovCars2",]$sumDen <- agrad.l2$sumMovCars
      shuff[shuff$variable == "rparkCars2",]$sumDen <- agrad.l2$sumParkCars
      shuff[shuff$variable == "rmovCicly2",]$sumDen <- agrad.l2$sumMovCicly
      shuff[shuff$variable == "rbuildId2",]$sumDen <- agrad.l2$sumBuildId
      shuff[shuff$variable == "rbuildNRec2",]$sumDen <- agrad.l2$sumBuildNRec
      shuff[shuff$variable == "rtree2",]$sumDen <- agrad.l2$sumTree
      shuff[shuff$variable == "rsmallPla2",]$sumDen <- agrad.l2$sumSmallPla
      shuff[shuff$variable == "rdiffBuild2",]$sumDen <- agrad.l2$sumDiffBuild
      shuff[shuff$variable == "rstreeFur2",]$sumDen <- agrad.l2$sumStreeFur
      shuff[shuff$variable == "rbasCol2",]$sumDen <- agrad.l2$sumBasCol
      shuff[shuff$variable == "raccenCol2",]$sumDen <- agrad.l2$sumAccenCol
      shuff[shuff$variable == "rpeop2",]$sumDen <- agrad.l2$sumPeop
      shuff[shuff$variable == "rbuildDiffAges2",]$sumDen <- agrad.l2$sumBuildDiffAges
      shuff[shuff$variable == "rgraff2",]$sumDen <- agrad.l2$sumGraff
      shuff[shuff$variable == "rligh2",]$sumDen <- agrad.l2$sumLigh
      
      print("### Real")
      print("##### Summary")
      print( real %>% group_by(variable) %>% summarise( som=sum(value)/(mean(sumDen)) ) %>% arrange(desc(som)) )
      print("##### List")
      print( arrange(real, desc(value)) )
      print("### Shuffle")
      print("##### Summary")
      print( shuff %>% group_by(variable) %>% summarise( som=sum(value)/(mean(sumDen)), std=mean(sd) ) %>% arrange(desc(som)) )
      print("##### List")
      print( arrange(shuff, desc(value)) )
}

iterations <- 10000

mergeSort <- function(x){
  if(length(x) == 1){
    inv <- 0
  } else {
    n <- length(x)
    n1 <- ceiling(n/2)
    n2 <- n-n1
    y1 <- mergeSort(x[1:n1])
    y2 <- mergeSort(x[n1+1:n2])
    inv <- y1$inversions + y2$inversions
    x1 <- y1$sortedVector
    x2 <- y2$sortedVector
    i1 <- 1
    i2 <- 1
    while(i1+i2 <= n1+n2+1){
      if(i2 > n2 || (i1 <= n1 && x1[i1] <= x2[i2])){
        x[i1+i2-1] <- x1[i1]
        i1 <- i1 + 1
      } else {
        inv <- inv + n1 + 1 - i1
        x[i1+i2-1] <- x2[i2]
        i2 <- i2 + 1
      }
    }
  }
  return (list(inversions=inv,sortedVector=x))
}

numberOfInversions <- function(x){
  r <- mergeSort(x)
  return (r$inversions)
}

normalizedKendallTauDistance2 <- function(data1, data2){
  x <- data1
  y <- data2
  
  tau = numberOfInversions(order(x)[rank(y)])
  nItens = length(x)
  maxNumberOfInverstions <- (nItens*(nItens-1))/2
  normalized = tau/maxNumberOfInverstions

  print (normalized)
}

#Summary of neighborhoods city
citySummary <- function(groupName, data){
   print(paste("Total summary ", groupName))
   print(summary(data[groupName]))
   centerData <- filter(data, bairro == "centro")[groupName]
   print( paste("City Center summary ") )
   print(summary(centerData))
   libData <- filter(data, bairro == "liberdade")[groupName]
   print( paste("Liberdade summary ") )
   print(summary(libData))
   catData <- filter(data, bairro == "catole")[groupName]
   print( paste("CatolÃ© summary ") )
   print(summary(catData))
   
   #For census sectors
   sectors <- c("25040090500004", "250400905000013", "250400905000023", "250400905000060", "250400905000062", "250400905000089", "250400905000095")
   for (sec in sectors){
       secData <- filter(data, setor == sec)[groupName]
       print( paste(sec, " summary ") )
       print(summary(secData))
   }
}

#Correlation of features
novo <- select(temp, street_wid, sidewalk_wid, public_art, mov_cars,park_cars ,mov_ciclyst,debris ,pavement ,landscape ,courtyards ,major_landsc ,build_ident ,build_nrectan ,prop_street_wall ,prop_wind ,long_sight ,prop_sky_ahead ,prop_sky_across , trees ,small_planters ,build_height , diff_build ,prop_hist_build ,street_furnit ,basic_col ,lights ,accent_col ,people ,prop_active_use)

correlacao <- cor(x = novo)
library(lattice)
rb.palette <- colorRampPalette(c("yellow", "red"), space = "rgb")
levelplot(correlacao, main = "Urban Features Correlation", col.regions = rb.palette(120), cuts=100, at = seq(0, 1, 0.01), xlab = "Urban Features", ylab = "Urban Features", )

#General QScore regression
# library(leaps)
# 
# regsubsetsAgrad.out <<- regsubsets(V3.Geral ~ street_wid + sidewalk_wid + public_art + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + courtyards + major_landsc + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + prop_hist_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, na.action = na.exclude, data = agrad, nbest = 1, nvmax = NULL, force.in = NULL, force.out = NULL, method = "exhaustive")
# plot(regsubsetsAgrad.out, scale = "adjr2", main = "Adjusted R^2")

#regGeralAgrad <- lm(agrad$V3.Geral ~ agrad$street_wid + agrad$sidewalk_wid + agrad$public_art + agrad$mov_cars + agrad$park_cars + agrad$mov_ciclyst + agrad$debris + agrad$pavement + agrad$landscape + agrad$courtyards + agrad$major_landsc + agrad$build_ident + agrad$build_nrectan + agrad$prop_street_wall + agrad$prop_wind + agrad$long_sight + agrad$prop_sky_ahead + agrad$prop_sky_across + agrad$trees + agrad$small_planters + agrad$build_height + agrad$diff_build + agrad$prop_hist_build + agrad$outdoor_table + agrad$street_furnit + agrad$basic_col + agrad$lights + agrad$accent_col + agrad$people + agrad$prop_active_use, na.action = na.exclude)
# regGeralAgrad <- lm(V3.Geral ~ street_wid + public_art + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + courtyards + major_landsc + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + small_planters + build_height + prop_hist_build + street_furnit + basic_col + accent_col + people, na.action = na.exclude, data = agrad)
# texreg(regGeralAgrad)
# summary(regGeralAgrad)


```

```{r, echo=FALSE, fig.show='asis', fig.width=10, fig.height=5}
#Unit tests FIXME for proportions means!
library(RUnit)

test.kendallWithEqualRankingsAndZeroFeature <- function(){
   mov_cars <- c(0,0,0,0,0)
   park_cars <- c(0,0,0,0,0)
   mov_ciclyst <- c(0,0,0,0,0)
   build_ident <- c(0,0,0,0,0)
   build_nrectan <- c(0,0,0,0,0)
   trees <- c(0,0,0,0,0)
   small_planters <- c(0,0,0,0,0)
   diff_build <- c(0,0,0,0,0)
   street_furnit <- c(0,0,0,0,0)
   basic_col <- c(0,0,0,0,0)
   lights <- c(0,0,0,0,0)
   accent_col <- c(0,0,0,0,0)
   people <- c(0,0,0,0,0)
   graffiti <- c(0,0,0,0,0)
   build_diff_ages <- c(0,0,0,0,0)
   street_wid <- c(0,0,0,0,0)
   sidewalk_wid<- c(0,0,0,0,0)
   debris<- c(0,0,0,0,0)
   pavement<- c(0,0,0,0,0)
   landscape<- c(0,0,0,0,0)
   prop_street_wall<- c(0,0,0,0,0)
   prop_wind<- c(0,0,0,0,0)
   long_sight<- c(0,0,0,0,0)
   prop_sky_ahead<- c(0,0,0,0,0)
   prop_sky_across<- c(0,0,0,0,0)
   build_height<- c(0,0,0,0,0)
   prop_active_use<- c(0,0,0,0,0)
   
   agradTest <- data.frame(rank=c(1,2,3,4,5), index=c(1,2,3,4,5), mov_cars=mov_cars, park_cars=park_cars, mov_ciclyst = mov_ciclyst, build_ident = build_ident, build_nrectan = build_nrectan, trees = trees, small_planters = small_planters, diff_build = diff_build, street_furnit = street_furnit, basic_col = basic_col, lights = lights, accent_col = accent_col, people = people, graffiti = graffiti, build_diff_ages = build_diff_ages, street_wid = street_wid, sidewalk_wid = sidewalk_wid, debris = debris, pavement = pavement, landscape = landscape, prop_street_wall = prop_street_wall, prop_wind = prop_wind, long_sight = long_sight, prop_sky_ahead = prop_sky_ahead, prop_sky_across = prop_sky_across, build_height = build_height, prop_active_use = prop_active_use, masc=c(1,2,3,4,5), fem=c(1,2,3,4,5))
   iterations <- 1

   result <- kendallWithWeights(agradTest, iterations, "masc", "fem")
   checkEquals(length(result), 135)
   checkTrue(result$movCars == 0)
   checkTrue(result$parkCars == 0)
   checkTrue(result$movCicly == 0)
   checkTrue(result$buildId == 0)
   checkTrue(result$buildNRec == 0)
   checkTrue(result$tree == 0)
   checkTrue(result$smallPla == 0)
   checkTrue(result$diffBuild == 0)
   checkTrue(result$streeFur == 0)
   checkTrue(result$basCol == 0)
   checkTrue(result$ligh == 0)
   checkTrue(result$accenCol == 0)
   checkTrue(result$peop == 0)
   checkTrue(result$graff == 0)
   checkTrue(result$buildDiffAges == 0)
   checkTrue(result$streetWid == 0)
   checkTrue(result$sidewalkWid == 0)
   checkTrue(result$debris == 0)
   checkTrue(result$pavement == 0)
   checkTrue(result$landscape == 0)
   checkTrue(result$propStreetWall == 0)
   checkTrue(result$propWind == 0)
   checkTrue(result$longSight == 0)
   checkTrue(result$propSkyAhead == 0)
   checkTrue(result$propSkyAcross == 0)
   checkTrue(result$buildHeight == 0)
   checkTrue(result$propActiveUse == 0)
   
   checkTrue(result$rmovCars == 0)
   checkTrue(result$rparkCars == 0)
   checkTrue(result$rmovCicly == 0)
   checkTrue(result$rbuildId == 0)
   checkTrue(result$rbuildNRec == 0)
   checkTrue(result$rtree == 0)
   checkTrue(result$rsmallPla == 0)
   checkTrue(result$rdiffBuild == 0)
   checkTrue(result$rstreeFur == 0)
   checkTrue(result$rbasCol == 0)
   checkTrue(result$rligh == 0)
   checkTrue(result$raccenCol == 0)
   checkTrue(result$rpeop == 0)
   checkTrue(result$rgraff == 0)
   checkTrue(result$rbuildDiffAges == 0)
   checkTrue(result$rstreetWid == 0)
   checkTrue(result$rsidewalkWid == 0)
   checkTrue(result$rdebris == 0)
   checkTrue(result$rpavement == 0)
   checkTrue(result$rlandscape == 0)
   checkTrue(result$rpropStreetWall == 0)
   checkTrue(result$rpropWind == 0)
   checkTrue(result$rlongSight == 0)
   checkTrue(result$rpropSkyAhead == 0)
   checkTrue(result$rpropSkyAcross == 0)
   checkTrue(result$rbuildHeight == 0)
   checkTrue(result$rpropActiveUse == 0)
   
   checkTrue(is.na(result$rsdMovCars))
   checkTrue(is.na(result$rsdParkCars))
   checkTrue(is.na(result$rsdMovCicly))
   checkTrue(is.na(result$rsdBuildId))
   checkTrue(is.na(result$rsdBuildNRec))
   checkTrue(is.na(result$rsdTree))
   checkTrue(is.na(result$rsdSmallPla))
   checkTrue(is.na(result$rsdDiffBuild))
   checkTrue(is.na(result$rsdStreeFur))
   checkTrue(is.na(result$rsdBasCol))
   checkTrue(is.na(result$rsdLigh))
   checkTrue(is.na(result$rsdAccenCol))
   checkTrue(is.na(result$rsdPeop))
   checkTrue(is.na(result$rsdGraff))
   checkTrue(is.na(result$rsdBuildDiffAges))
   checkTrue(is.na(result$rsdStreetWid))
   checkTrue(is.na(result$rsdSidewalkWid))
   checkTrue(is.na(result$rsdDebris))
   checkTrue(is.na(result$rsdPavement))
   checkTrue(is.na(result$rsdLandscape))
   checkTrue(is.na(result$rsdPropStreetWall))
   checkTrue(is.na(result$rsdPropWind))
   checkTrue(is.na(result$rsdLongSight))
   checkTrue(is.na(result$rsdPropSkyAhead))
   checkTrue(is.na(result$rsdPropSkyAcross))
   checkTrue(is.na(result$rsdBuildHeight))
   checkTrue(is.na(result$rsdPropActiveUse))
   
   checkTrue(is.na(result$movCarsN))
   checkTrue(is.na(result$parkCarsN))
   checkTrue(is.na(result$movCiclyN))
   checkTrue(is.na(result$buildIdN))
   checkTrue(is.na(result$buildNRecN))
   checkTrue(is.na(result$treeN))
   checkTrue(is.na(result$smallPlaN))
   checkTrue(is.na(result$diffBuildN))
   checkTrue(is.na(result$streeFurN))
   checkTrue(is.na(result$basColN))
   checkTrue(is.na(result$lighN))
   checkTrue(is.na(result$accenColN))
   checkTrue(is.na(result$peopN))
   checkTrue(is.na(result$graffN))
   checkTrue(is.na(result$buildDiffAgesN))
   checkTrue(is.na(result$streetWidN))
   checkTrue(is.na(result$sidewalkWidN))
   checkTrue(is.na(result$debrisN))
   checkTrue(is.na(result$pavementN))
   checkTrue(is.na(result$landscapeN))
   checkTrue(is.na(result$propStreetWallN))
   checkTrue(is.na(result$propWindN))
   checkTrue(is.na(result$longSightN))
   checkTrue(is.na(result$propSkyAheadN))
   checkTrue(is.na(result$propSkyAcrossN))
   checkTrue(is.na(result$buildHeightN))
   checkTrue(is.na(result$propActiveUseN))
}

test.kendallWithEqualRankingsAndNonZeroFeature <- function(){
   mov_cars <- c(2,2,0,0,0)
   park_cars <- c(2,2,0,0,0)
   mov_ciclyst <- c(2,2,0,0,0)
   build_ident <- c(2,2,0,0,0)
   build_nrectan <- c(2,2,0,0,0)
   trees <- c(2,2,0,0,0)
   small_planters <- c(2,2,0,0,0)
   diff_build <- c(2,2,0,0,0)
   street_furnit <- c(2,2,0,0,0)
   basic_col <- c(2,2,0,0,0)
   lights <- c(2,2,0,0,0)
   accent_col <- c(2,2,0,0,0)
   people <- c(2,2,0,0,0)
   graffiti <- c(2,2,0,0,0)
   build_diff_ages <- c(2,2,0,0,0)
   street_wid <- c(2,2,0,0,0)
   sidewalk_wid<- c(2,2,0,0,0)
   debris<- c(2,2,0,0,0)
   pavement<- c(2,2,0,0,0)
   landscape<- c(2,2,0,0,0)
   prop_street_wall<- c(2,2,0,0,0)
   prop_wind<- c(2,2,0,0,0)
   long_sight<- c(2,2,0,0,0)
   prop_sky_ahead<- c(2,2,0,0,0)
   prop_sky_across<- c(2,2,0,0,0)
   build_height<- c(2,2,0,0,0)
   prop_active_use<- c(2,2,0,0,0)
   
   agradTest <- data.frame(rank=c(1,2,3,4,5), index=c(1,2,3,4,5), mov_cars=mov_cars, park_cars=park_cars, mov_ciclyst = mov_ciclyst, build_ident = build_ident, build_nrectan = build_nrectan, trees = trees, small_planters = small_planters, diff_build = diff_build, street_furnit = street_furnit, basic_col = basic_col, lights = lights, accent_col = accent_col, people = people, graffiti = graffiti, build_diff_ages = build_diff_ages, street_wid = street_wid, sidewalk_wid = sidewalk_wid, debris = debris, pavement = pavement, landscape = landscape, prop_street_wall = prop_street_wall, prop_wind = prop_wind, long_sight = long_sight, prop_sky_ahead = prop_sky_ahead, prop_sky_across = prop_sky_across, build_height = build_height, prop_active_use = prop_active_use, masc=c(1,2,3,4,5), fem=c(1,2,3,4,5))
   iterations <- 1

   result <- kendallWithWeights(agradTest, iterations, "masc", "fem")
   checkEquals(length(result), 135)
   checkTrue(result$movCars == 0)
   checkTrue(result$parkCars == 0)
   checkTrue(result$movCicly == 0)
   checkTrue(result$buildId == 0)
   checkTrue(result$buildNRec == 0)
   checkTrue(result$tree == 0)
   checkTrue(result$smallPla == 0)
   checkTrue(result$diffBuild == 0)
   checkTrue(result$streeFur == 0)
   checkTrue(result$basCol == 0)
   checkTrue(result$ligh == 0)
   checkTrue(result$accenCol == 0)
   checkTrue(result$peop == 0)
   checkTrue(result$graff == 0)
   checkTrue(result$buildDiffAges == 0)
   checkTrue(result$streetWid == 0)
   checkTrue(result$sidewalkWid == 0)
   checkTrue(result$debris == 0)
   checkTrue(result$pavement == 0)
   checkTrue(result$landscape == 0)
   checkTrue(result$propStreetWall == 0)
   checkTrue(result$propWind == 0)
   checkTrue(result$longSight == 0)
   checkTrue(result$propSkyAhead == 0)
   checkTrue(result$propSkyAcross == 0)
   checkTrue(result$buildHeight == 0)
   checkTrue(result$propActiveUse == 0)
   
   checkTrue(result$rmovCars == 0)
   checkTrue(result$rparkCars == 0)
   checkTrue(result$rmovCicly  == 0)
   checkTrue(result$rbuildId  == 0)
   checkTrue(result$rbuildNRec  == 0)
   checkTrue(result$rtree  == 0)
   checkTrue(result$rsmallPla == 0)
   checkTrue(result$rdiffBuild == 0)
   checkTrue(result$rstreeFur == 0)
   checkTrue(result$rbasCol == 0)
   checkTrue(result$rligh == 0)
   checkTrue(result$raccenCol == 0)
   checkTrue(result$rpeop == 0)
   checkTrue(result$rgraff == 0)
   checkTrue(result$rbuildDiffAges == 0)
   checkTrue(result$rstreetWid == 0)
   checkTrue(result$rsidewalkWid == 0)
   checkTrue(result$rdebris == 0)
   checkTrue(result$rpavement == 0)
   checkTrue(result$rlandscape == 0)
   checkTrue(result$rpropStreetWall == 0)
   checkTrue(result$rpropWind == 0)
   checkTrue(result$rlongSight == 0)
   checkTrue(result$rpropSkyAhead == 0)
   checkTrue(result$rpropSkyAcross == 0)
   checkTrue(result$rbuildHeight == 0)
   checkTrue(result$rpropActiveUse == 0)
   
   checkTrue(is.na(result$rsdMovCars))
   checkTrue(is.na(result$rsdParkCars))
   checkTrue(is.na(result$rsdMovCicly))
   checkTrue(is.na(result$rsdBuildId))
   checkTrue(is.na(result$rsdBuildNRec))
   checkTrue(is.na(result$rsdTree))
   checkTrue(is.na(result$rsdSmallPla))
   checkTrue(is.na(result$rsdDiffBuild))
   checkTrue(is.na(result$rsdStreeFur))
   checkTrue(is.na(result$rsdBasCol))
   checkTrue(is.na(result$rsdLigh))
   checkTrue(is.na(result$rsdAccenCol))
   checkTrue(is.na(result$rsdPeop))
   checkTrue(is.na(result$rsdGraff))
   checkTrue(is.na(result$rsdBuildDiffAges))
   checkTrue(is.na(result$rsdStreetWid))
   checkTrue(is.na(result$rsdSidewalkWid))
   checkTrue(is.na(result$rsdDebris))
   checkTrue(is.na(result$rsdPavement))
   checkTrue(is.na(result$rsdLandscape))
   checkTrue(is.na(result$rsdPropStreetWall))
   checkTrue(is.na(result$rsdPropWind))
   checkTrue(is.na(result$rsdLongSight))
   checkTrue(is.na(result$rsdPropSkyAhead))
   checkTrue(is.na(result$rsdPropSkyAcross))
   checkTrue(is.na(result$rsdBuildHeight))
   checkTrue(is.na(result$rsdPropActiveUse))
   
   checkTrue(result$movCarsN == 0)
   checkTrue(result$parkCarsN == 0)
   checkTrue(result$movCiclyN == 0)
   checkTrue(result$buildIdN == 0)
   checkTrue(result$buildNRecN == 0)
   checkTrue(result$treeN == 0)
   checkTrue(result$smallPlaN == 0)
   checkTrue(result$diffBuildN == 0)
   checkTrue(result$streeFurN == 0)
   checkTrue(result$basColN == 0)
   checkTrue(result$lighN == 0)
   checkTrue(result$accenColN == 0)
   checkTrue(result$peopN == 0)
   checkTrue(result$graffN == 0)
   checkTrue(result$buildDiffAgesN == 0)
   checkTrue(result$streetWidN== 0)
   checkTrue(result$sidewalkWidN== 0)
   checkTrue(result$debrisN== 0)
   checkTrue(result$pavementN== 0)
   checkTrue(result$landscapeN== 0)
   checkTrue(result$propStreetWallN== 0)
   checkTrue(result$propWindN== 0)
   checkTrue(result$longSightN== 0)
   checkTrue(result$propSkyAheadN== 0)
   checkTrue(result$propSkyAcrossN== 0)
   checkTrue(result$buildHeightN== 0)
   checkTrue(result$propActiveUseN== 0)
}

test.kendallWithOppRankingsAndNonZeroFeature <- function(){
   mov_cars <- c(2,2,0,0,0)
   park_cars <- c(2,2,0,0,0)
   mov_ciclyst <- c(2,2,0,0,0)
   build_ident <- c(2,2,0,0,0)
   build_nrectan <- c(2,2,0,0,0)
   trees <- c(2,2,0,0,0)
   small_planters <- c(2,2,0,0,0)
   diff_build <- c(2,2,0,0,0)
   street_furnit <- c(2,2,0,0,0)
   basic_col <- c(2,2,0,0,0)
   lights <- c(2,2,0,0,0)
   accent_col <- c(2,2,0,0,0)
   people <- c(2,2,0,0,0)
   graffiti <- c(2,2,0,0,0)
   build_diff_ages <- c(2,2,0,0,0)
   street_wid <- c(2,2,0,0,0)
   sidewalk_wid<- c(2,2,0,0,0)
   debris<- c(2,2,0,0,0)
   pavement<- c(2,2,0,0,0)
   landscape<- c(2,2,0,0,0)
   prop_street_wall<- c(2,2,0,0,0)
   prop_wind<- c(2,2,0,0,0)
   long_sight<- c(2,2,0,0,0)
   prop_sky_ahead<- c(2,2,0,0,0)
   prop_sky_across<- c(2,2,0,0,0)
   build_height<- c(2,2,0,0,0)
   prop_active_use<- c(2,2,0,0,0)
   
   agradTest <- data.frame(rank=c(5,4,3,2,1), index=c(1,2,3,4,5), mov_cars=mov_cars, park_cars=park_cars, mov_ciclyst = mov_ciclyst, build_ident = build_ident, build_nrectan = build_nrectan, trees = trees, small_planters = small_planters, diff_build = diff_build, street_furnit = street_furnit, basic_col = basic_col, lights = lights, accent_col = accent_col, people = people, graffiti = graffiti, build_diff_ages = build_diff_ages, street_wid = street_wid, sidewalk_wid = sidewalk_wid, debris = debris, pavement = pavement, landscape = landscape, prop_street_wall = prop_street_wall, prop_wind = prop_wind, long_sight = long_sight, prop_sky_ahead = prop_sky_ahead, prop_sky_across = prop_sky_across, build_height = build_height, prop_active_use = prop_active_use, masc=c(1,2,3,4,5), fem=c(5,4,3,2,1))
   iterations <- 1

   result <- kendallWithWeights(agradTest, iterations, "masc", "fem")
   checkEquals(length(result), 135)
   checkTrue(result$movCars == 12)
   checkTrue(result$parkCars == 12)
   checkTrue(result$movCicly == 12)
   checkTrue(result$buildId == 12)
   checkTrue(result$buildNRec == 12)
   checkTrue(result$tree == 12)
   checkTrue(result$smallPla == 12)
   checkTrue(result$diffBuild == 12)
   checkTrue(result$streeFur == 12)
   checkTrue(result$basCol == 12)
   checkTrue(result$ligh == 12)
   checkTrue(result$accenCol == 12)
   checkTrue(result$peop == 12)
   checkTrue(result$graff == 12)
   checkTrue(result$buildDiffAges == 12)
   checkTrue(result$streetWid == 12)
   checkTrue(result$sidewalkWid == 12)
   checkTrue(result$debris == 1.2)
   checkTrue(result$pavement == 1.2)
   checkTrue(result$landscape == 1.2)
   checkTrue(result$propStreetWall == 1.2)
   checkTrue(result$propWind == 1.2)
   checkTrue(result$longSight == 12)
   checkTrue(result$propSkyAhead == 1.2)
   checkTrue(result$propSkyAcross == 1.2)
   checkTrue(result$buildHeight == 12)
   checkTrue(result$propActiveUse == 1.2)
   
   checkTrue(result$rmovCars > 0)
   checkTrue(result$rparkCars  > 0)
   checkTrue(result$rmovCicly  > 0)
   checkTrue(result$rbuildId  > 0)
   checkTrue(result$rbuildNRec  > 0)
   checkTrue(result$rtree  > 0)
   checkTrue(result$rsmallPla > 0)
   checkTrue(result$rdiffBuild > 0)
   checkTrue(result$rstreeFur > 0)
   checkTrue(result$rbasCol > 0)
   checkTrue(result$rligh > 0)
   checkTrue(result$raccenCol > 0)
   checkTrue(result$rpeop > 0)
   checkTrue(result$rgraff > 0)
   checkTrue(result$rbuildDiffAges > 0)
   checkTrue(result$rstreetWid > 0)
   checkTrue(result$rsidewalkWid > 0)
   checkTrue(result$rdebris > 0)
   checkTrue(result$rpavement > 0)
   checkTrue(result$rlandscape > 0)
   checkTrue(result$rpropStreetWall > 0)
   checkTrue(result$rpropWind > 0)
   checkTrue(result$rlongSight > 0)
   checkTrue(result$rpropSkyAhead > 0)
   checkTrue(result$rpropSkyAcross > 0)
   checkTrue(result$rbuildHeight > 0)
   checkTrue(result$rpropActiveUse > 0)
   
   checkTrue(is.na(result$rsdMovCars))
   checkTrue(is.na(result$rsdParkCars))
   checkTrue(is.na(result$rsdMovCicly))
   checkTrue(is.na(result$rsdBuildId))
   checkTrue(is.na(result$rsdBuildNRec))
   checkTrue(is.na(result$rsdTree))
   checkTrue(is.na(result$rsdSmallPla))
   checkTrue(is.na(result$rsdDiffBuild))
   checkTrue(is.na(result$rsdStreeFur))
   checkTrue(is.na(result$rsdBasCol))
   checkTrue(is.na(result$rsdLigh))
   checkTrue(is.na(result$rsdAccenCol))
   checkTrue(is.na(result$rsdPeop))
   checkTrue(is.na(result$rsdGraff))
   checkTrue(is.na(result$rsdBuildDiffAges))
   checkTrue(is.na(result$rsdStreetWid))
   checkTrue(is.na(result$rsdSidewalkWid))
   checkTrue(is.na(result$rsdDebris))
   checkTrue(is.na(result$rsdPavement))
   checkTrue(is.na(result$rsdLandscape))
   checkTrue(is.na(result$rsdPropStreetWall))
   checkTrue(is.na(result$rsdPropWind))
   checkTrue(is.na(result$rsdLongSight))
   checkTrue(is.na(result$rsdPropSkyAhead))
   checkTrue(is.na(result$rsdPropSkyAcross))
   checkTrue(is.na(result$rsdBuildHeight))
   checkTrue(is.na(result$rsdPropActiveUse))

   checkTrue(result$movCarsN == 1)
   checkTrue(result$parkCarsN == 1)
   checkTrue(result$movCiclyN == 1)
   checkTrue(result$buildIdN == 1)
   checkTrue(result$buildNRecN == 1)
   checkTrue(result$treeN == 1)
   checkTrue(result$smallPlaN == 1)
   checkTrue(result$diffBuildN == 1)
   checkTrue(result$streeFurN == 1)
   checkTrue(result$basColN == 1)
   checkTrue(result$lighN == 1)
   checkTrue(result$accenColN == 1)
   checkTrue(result$peopN == 1)
   checkTrue(result$graffN == 1)
   checkTrue(result$buildDiffAgesN == 1)
   checkTrue(result$streetWidN== 1)
   checkTrue(result$sidewalkWidN== 1)
   checkTrue(result$debrisN== 1)
   checkTrue(result$pavementN== 1)
   checkTrue(result$landscapeN== 1)
   checkTrue(result$propStreetWallN== 1)
   checkTrue(result$propWindN== 1)
   checkTrue(result$longSightN== 1)
   checkTrue(result$propSkyAheadN== 1)
   checkTrue(result$propSkyAcrossN== 1)
   checkTrue(result$buildHeightN== 1)
   checkTrue(result$propActiveUseN== 1)
}

test.kendallWithOppRankingsAndNonZeroFeatureSecondGroupPrefer <- function(){
   mov_cars <- c(2,2,0,0,0)
   park_cars <- c(2,2,0,0,0)
   mov_ciclyst <- c(2,2,0,0,0)
   build_ident <- c(2,2,0,0,0)
   build_nrectan <- c(2,2,0,0,0)
   trees <- c(2,2,0,0,0)
   small_planters <- c(2,2,0,0,0)
   diff_build <- c(2,2,0,0,0)
   street_furnit <- c(2,2,0,0,0)
   basic_col <- c(2,2,0,0,0)
   lights <- c(2,2,0,0,0)
   accent_col <- c(2,2,0,0,0)
   people <- c(2,2,0,0,0)
   graffiti <- c(2,2,0,0,0)
   build_diff_ages <- c(2,2,0,0,0)
   street_wid <- c(2,2,0,0,0)
   sidewalk_wid<- c(2,2,0,0,0)
   debris<- c(2,2,0,0,0)
   pavement<- c(2,2,0,0,0)
   landscape<- c(2,2,0,0,0)
   prop_street_wall<- c(2,2,0,0,0)
   prop_wind<- c(2,2,0,0,0)
   long_sight<- c(2,2,0,0,0)
   prop_sky_ahead<- c(2,2,0,0,0)
   prop_sky_across<- c(2,2,0,0,0)
   build_height<- c(2,2,0,0,0)
   prop_active_use<- c(2,2,0,0,0)
   
   agradTest <- data.frame(rank=c(5,4,3,2,1), index=c(1,2,3,4,5), mov_cars=mov_cars, park_cars=park_cars, mov_ciclyst = mov_ciclyst, build_ident = build_ident, build_nrectan = build_nrectan, trees = trees, small_planters = small_planters, diff_build = diff_build, street_furnit = street_furnit, basic_col = basic_col, lights = lights, accent_col = accent_col, people = people, graffiti = graffiti, build_diff_ages = build_diff_ages, street_wid = street_wid, sidewalk_wid = sidewalk_wid, debris = debris, pavement = pavement, landscape = landscape, prop_street_wall = prop_street_wall, prop_wind = prop_wind, long_sight = long_sight, prop_sky_ahead = prop_sky_ahead, prop_sky_across = prop_sky_across, build_height = build_height, prop_active_use = prop_active_use, masc=c(1,2,3,4,5), fem=c(5,4,3,2,1))
   iterations <- 1

   result <- kendallWithWeights(agradTest, iterations, "masc", "fem")
   checkEquals(length(result), 135)
   checkTrue(result$movCars == -12)
   checkTrue(result$parkCars == -12)
   checkTrue(result$movCicly == -12)
   checkTrue(result$buildId == -12)
   checkTrue(result$buildNRec == -12)
   checkTrue(result$tree == -12)
   checkTrue(result$smallPla == -12)
   checkTrue(result$diffBuild == -12)
   checkTrue(result$streeFur == -12)
   checkTrue(result$basCol == -12)
   checkTrue(result$ligh == -12)
   checkTrue(result$accenCol == -12)
   checkTrue(result$peop == -12)
   checkTrue(result$graff == -12)
   checkTrue(result$buildDiffAges == -12)
   checkTrue(result$streetWid == -12)
   checkTrue(result$sidewalkWid == -12)
   checkTrue(result$debris == -1.2)
   checkTrue(result$pavement == -1.2)
   checkTrue(result$landscape == -1.2)
   checkTrue(result$propStreetWall == -1.2)
   checkTrue(result$propWind == -1.2)
   checkTrue(result$longSight == -12)
   checkTrue(result$propSkyAhead == -1.2)
   checkTrue(result$propSkyAcross == -1.2)
   checkTrue(result$buildHeight == -12)
   checkTrue(result$propActiveUse == -1.2)
   
   checkTrue(is.na(result$rsdMovCars))
   checkTrue(is.na(result$rsdParkCars))
   checkTrue(is.na(result$rsdMovCicly))
   checkTrue(is.na(result$rsdBuildId))
   checkTrue(is.na(result$rsdBuildNRec))
   checkTrue(is.na(result$rsdTree))
   checkTrue(is.na(result$rsdSmallPla))
   checkTrue(is.na(result$rsdDiffBuild))
   checkTrue(is.na(result$rsdStreeFur))
   checkTrue(is.na(result$rsdBasCol))
   checkTrue(is.na(result$rsdLigh))
   checkTrue(is.na(result$rsdAccenCol))
   checkTrue(is.na(result$rsdPeop))
   checkTrue(is.na(result$rsdGraff))
   checkTrue(is.na(result$rsdBuildDiffAges))
   checkTrue(is.na(result$rsdStreetWid))
   checkTrue(is.na(result$rsdSidewalkWid))
   checkTrue(is.na(result$rsdDebris))
   checkTrue(is.na(result$rsdPavement))
   checkTrue(is.na(result$rsdLandscape))
   checkTrue(is.na(result$rsdPropStreetWall))
   checkTrue(is.na(result$rsdPropWind))
   checkTrue(is.na(result$rsdLongSight))
   checkTrue(is.na(result$rsdPropSkyAhead))
   checkTrue(is.na(result$rsdPropSkyAcross))
   checkTrue(is.na(result$rsdBuildHeight))
   checkTrue(is.na(result$rsdPropActiveUse))

   checkTrue(result$movCarsN == -1)
   checkTrue(result$parkCarsN == -1)
   checkTrue(result$movCiclyN == -1)
   checkTrue(result$buildIdN == -1)
   checkTrue(result$buildNRecN == -1)
   checkTrue(result$treeN == -1)
   checkTrue(result$smallPlaN == -1)
   checkTrue(result$diffBuildN == -1)
   checkTrue(result$streeFurN == -1)
   checkTrue(result$basColN == -1)
   checkTrue(result$lighN == -1)
   checkTrue(result$accenColN == -1)
   checkTrue(result$peopN == -1)
   checkTrue(result$graffN == -1)
   checkTrue(result$buildDiffAgesN == -1)
   checkTrue(result$streetWidN== -1)
   checkTrue(result$sidewalkWidN== -1)
   checkTrue(result$debrisN== -1)
   checkTrue(result$pavementN== -1)
   checkTrue(result$landscapeN== -1)
   checkTrue(result$propStreetWallN== -1)
   checkTrue(result$propWindN== -1)
   checkTrue(result$longSightN== -1)
   checkTrue(result$propSkyAheadN== -1)
   checkTrue(result$propSkyAcrossN== -1)
   checkTrue(result$buildHeightN== -1)
   checkTrue(result$propActiveUseN== -1)
}

test.kendallWithOppRankingsAndNonZeroDiffFeature <- function(){
   mov_cars <- c(2,2,0,0,0)
   park_cars <- c(3,3,0,0,0)
   mov_ciclyst <- c(3,3,0,0,0)
   build_ident <- c(3,3,0,0,0)
   build_nrectan <- c(2,2,0,0,0)
   trees <- c(4,4,0,0,0)
   small_planters <- c(3,2,0,0,0)
   diff_build <- c(2,2,0,0,0)
   street_furnit <- c(2,2,0,0,0)
   basic_col <- c(2,2,0,0,0)
   lights <- c(2,2,0,0,0)
   accent_col <- c(2,2,0,0,0)
   people <- c(2,2,0,0,0)
   graffiti <- c(2,2,0,0,0)
   build_diff_ages <- c(2,2,0,0,0)
   street_wid <- c(4,4,0,0,0)
   sidewalk_wid<- c(4,4,0,0,0)
   debris<- c(2,2,0,0,0)
   pavement<- c(2,2,0,0,0)
   landscape<- c(2,2,0,0,0)
   prop_street_wall<- c(2,2,0,0,0)
   prop_wind<- c(2,2,0,0,0)
   long_sight<- c(2,2,0,0,0)
   prop_sky_ahead<- c(2,2,0,0,0)
   prop_sky_across<- c(2,2,0,0,0)
   build_height<- c(3,3,0,0,0)
   prop_active_use<- c(2,2,0,0,0)
   
   agradTest <- data.frame(rank=c(1,2,3,4,5), index=c(5, 4, 3, 2, 1), mov_cars=mov_cars, park_cars=park_cars, mov_ciclyst = mov_ciclyst, build_ident = build_ident, build_nrectan = build_nrectan, trees = trees, small_planters = small_planters, diff_build = diff_build, street_furnit = street_furnit, basic_col = basic_col, lights = lights, accent_col = accent_col, people = people, graffiti = graffiti, build_diff_ages = build_diff_ages, street_wid = street_wid, sidewalk_wid = sidewalk_wid, debris = debris, pavement = pavement, landscape = landscape, prop_street_wall = prop_street_wall, prop_wind = prop_wind, long_sight = long_sight, prop_sky_ahead = prop_sky_ahead, prop_sky_across = prop_sky_across, build_height = build_height, prop_active_use = prop_active_use, masc=c(1,2,3,4,5), fem=c(5,4,3,2,1))
   iterations <- 1

   result <- kendallWithWeights(agradTest, iterations, "masc", "fem")
   checkEquals(length(result), 135)
   checkTrue(result$movCars == 12)
   checkTrue(result$parkCars == 18)
   checkTrue(result$movCicly == 18)
   checkTrue(result$buildId == 18)
   checkTrue(result$buildNRec == 12)
   checkTrue(result$tree == 24)
   checkTrue(result$smallPla == 16)
   checkTrue(result$diffBuild == 12)
   checkTrue(result$streeFur == 12)
   checkTrue(result$basCol == 12)
   checkTrue(result$ligh == 12)
   checkTrue(result$accenCol == 12)
   checkTrue(result$peop == 12)
   checkTrue(result$graff == 12)
   checkTrue(result$buildDiffAges == 12)
   checkTrue(result$streetWid == 24)
   checkTrue(result$sidewalkWid == 24)
   checkTrue(result$debris == 1.2)
   checkTrue(result$pavement == 1.2)
   checkTrue(result$landscape == 1.2)
   checkTrue(result$propStreetWall == 1.2)
   checkTrue(result$propWind == 1.2)
   checkTrue(result$longSight == 12)
   checkTrue(result$propSkyAhead == 1.2)
   checkTrue(result$propSkyAcross == 1.2)
   checkTrue(result$buildHeight == 18)
   checkTrue(result$propActiveUse == 1.2)
   
   checkTrue(result$rmovCars > 0)
   checkTrue(result$rparkCars  > 0)
   checkTrue(result$rmovCicly  > 0)
   checkTrue(result$rbuildId  > 0)
   checkTrue(result$rbuildNRec  > 0)
   checkTrue(result$rtree  > 0)
   checkTrue(result$rsmallPla > 0)
   checkTrue(result$rdiffBuild > 0)
   checkTrue(result$rstreeFur > 0)
   checkTrue(result$rbasCol > 0)
   checkTrue(result$rligh > 0)
   checkTrue(result$raccenCol > 0)
   checkTrue(result$rpeop > 0)
   checkTrue(result$rgraff > 0)
   checkTrue(result$rbuildDiffAges > 0)
   checkTrue(result$rstreetWid > 0)
   checkTrue(result$rsidewalkWid > 0)
   checkTrue(result$rdebris > 0)
   checkTrue(result$rpavement > 0)
   checkTrue(result$rlandscape > 0)
   checkTrue(result$rpropStreetWall > 0)
   checkTrue(result$rpropWind > 0)
   checkTrue(result$rlongSight > 0)
   checkTrue(result$rpropSkyAhead > 0)
   checkTrue(result$rpropSkyAcross > 0)
   checkTrue(result$rbuildHeight > 0)
   checkTrue(result$rpropActiveUse > 0)
   
   checkTrue(is.na(result$rsdMovCars))
   checkTrue(is.na(result$rsdParkCars))
   checkTrue(is.na(result$rsdMovCicly))
   checkTrue(is.na(result$rsdBuildId))
   checkTrue(is.na(result$rsdBuildNRec))
   checkTrue(is.na(result$rsdTree))
   checkTrue(is.na(result$rsdSmallPla))
   checkTrue(is.na(result$rsdDiffBuild))
   checkTrue(is.na(result$rsdStreeFur))
   checkTrue(is.na(result$rsdBasCol))
   checkTrue(is.na(result$rsdLigh))
   checkTrue(is.na(result$rsdAccenCol))
   checkTrue(is.na(result$rsdPeop))
   checkTrue(is.na(result$rsdGraff))
   checkTrue(is.na(result$rsdBuildDiffAges))
   checkTrue(is.na(result$rsdStreetWid))
   checkTrue(is.na(result$rsdSidewalkWid))
   checkTrue(is.na(result$rsdDebris))
   checkTrue(is.na(result$rsdPavement))
   checkTrue(is.na(result$rsdLandscape))
   checkTrue(is.na(result$rsdPropStreetWall))
   checkTrue(is.na(result$rsdPropWind))
   checkTrue(is.na(result$rsdLongSight))
   checkTrue(is.na(result$rsdPropSkyAhead))
   checkTrue(is.na(result$rsdPropSkyAcross))
   checkTrue(is.na(result$rsdBuildHeight))
   checkTrue(is.na(result$rsdPropActiveUse))
   
   checkTrue(result$movCarsN == 1)
   checkTrue(result$parkCarsN == 1)
   checkTrue(result$movCiclyN == 1)
   checkTrue(result$buildIdN == 1)
   checkTrue(result$buildNRecN == 1)
   checkTrue(result$treeN == 1)
   checkTrue(result$smallPlaN == 1)
   checkTrue(result$diffBuildN == 1)
   checkTrue(result$streeFurN == 1)
   checkTrue(result$basColN == 1)
   checkTrue(result$lighN == 1)
   checkTrue(result$accenColN == 1)
   checkTrue(result$peopN == 1)
   checkTrue(result$graffN == 1)
   checkTrue(result$buildDiffAgesN == 1)
   checkTrue(result$streetWidN== 1)
   checkTrue(result$sidewalkWidN== 1)
   checkTrue(result$debrisN== 1)
   checkTrue(result$pavementN== 1)
   checkTrue(result$landscapeN== 1)
   checkTrue(result$propStreetWallN== 1)
   checkTrue(result$propWindN== 1)
   checkTrue(result$longSightN== 1)
   checkTrue(result$propSkyAheadN== 1)
   checkTrue(result$propSkyAcrossN== 1)
   checkTrue(result$buildHeightN== 1)
   checkTrue(result$propActiveUseN== 1)
}

test.kendallWithDiffRankingsAndNonZeroDiffFeature <- function(){
   mov_cars <- c(2,0,2,0,0)
   park_cars <- c(3,0,3,0,0)
   mov_ciclyst <- c(3,0,3,0,0)
   build_ident <- c(3,0,3,0,0)
   build_nrectan <- c(2,0,2,0,0)
   trees <- c(4,0,4,0,0)
   small_planters <- c(3,0,2,0,0)
   diff_build <- c(2,0,2,0,0)
   street_furnit <- c(2,0,2,0,0)
   basic_col <- c(2,0,2,0,0)
   lights <- c(2,0,2,0,0)
   accent_col <- c(2,0,2,0,0)
   people <- c(2,0,2,0,0)
   graffiti <- c(2,0,2,0,0)
   build_diff_ages <- c(2,0,2,0,0)
   street_wid <- c(4,0,4,0,0)
   sidewalk_wid<- c(2,0,2,0,0)
   debris<- c(4,0,4,0,0)
   pavement<- c(2,0,2,0,0)
   landscape<- c(2,0,2,0,0)
   prop_street_wall<- c(2,0,2,0,0)
   prop_wind<- c(2,0,2,0,0)
   long_sight<- c(2,0,2,0,0)
   prop_sky_ahead<- c(3,0,2,0,0)
   prop_sky_across<- c(2,0,2,0,0)
   build_height<- c(2,0,2,0,0)
   prop_active_use<- c(2,0,2,0,0)
   
   agradTest <- data.frame(rank=c(1,2,3,4,5), index=c(1, 2, 5, 4, 3), mov_cars=mov_cars, park_cars=park_cars, mov_ciclyst = mov_ciclyst, build_ident = build_ident, build_nrectan = build_nrectan, trees = trees, small_planters = small_planters, diff_build = diff_build, street_furnit = street_furnit, basic_col = basic_col, lights = lights, accent_col = accent_col, people = people, graffiti = graffiti, build_diff_ages = build_diff_ages, street_wid = street_wid, sidewalk_wid = sidewalk_wid, debris = debris, pavement = pavement, landscape = landscape, prop_street_wall = prop_street_wall, prop_wind = prop_wind, long_sight = long_sight, prop_sky_ahead = prop_sky_ahead, prop_sky_across = prop_sky_across, build_height = build_height, prop_active_use = prop_active_use, masc=c(1,2,3,4,5), fem=c(1,2,5,4,3))
   iterations <- 1

   result <- kendallWithWeights(agradTest, iterations, "masc", "fem")
   checkEquals(length(result), 135)
   checkTrue(result$movCars == 2 * 2)
   checkTrue(result$parkCars == 3 * 2)
   checkTrue(result$movCicly == 3 * 2)
   checkTrue(result$buildId == 3 * 2)
   checkTrue(result$buildNRec == 2 * 2)
   checkTrue(result$tree == 4 * 2)
   checkTrue(result$smallPla == 2 * 2)
   checkTrue(result$diffBuild == 2 * 2)
   checkTrue(result$streeFur == 2 * 2)
   checkTrue(result$basCol == 2 * 2)
   checkTrue(result$ligh == 2 * 2)
   checkTrue(result$accenCol == 2 * 2)
   checkTrue(result$peop == 2 * 2)
   checkTrue(result$graff == 2 * 2)
   checkTrue(result$buildDiffAges == 2 * 2)
   checkTrue(result$streetWid == 4 * 2)
   checkTrue(result$sidewalkWid == 2 * 2)
   checkTrue(result$debris == (4 * 2)/3)#Mean of changes!
   checkTrue(result$pavement == (2 * 2)/3)
   checkTrue(result$landscape == (2 * 2)/3)
   checkTrue(result$propStreetWall == (2 * 2)/3)
   checkTrue(result$propWind == (2 * 2)/3)
   checkTrue(result$longSight == 2 * 2)
   checkTrue(result$propSkyAhead == (2 * 2)/3)
   checkTrue(result$propSkyAcross == (2 * 2)/3)
   checkTrue(result$buildHeight == 2 * 2)
   checkTrue(result$propActiveUse == (2 * 2)/3)
   
   checkTrue(result$rmovCars != 0)
   checkTrue(result$rparkCars  != 0)
   checkTrue(result$rmovCicly  != 0)
   checkTrue(result$rbuildId  != 0)
   checkTrue(result$rbuildNRec  != 0)
   checkTrue(result$rtree  != 0)
   checkTrue(result$rsmallPla != 0)
   checkTrue(result$rdiffBuild != 0)
   checkTrue(result$rstreeFur != 0)
   checkTrue(result$rbasCol != 0)
   checkTrue(result$rligh != 0)
   checkTrue(result$raccenCol != 0)
   checkTrue(result$rpeop != 0)
   checkTrue(result$rgraff != 0)
   checkTrue(result$rbuildDiffAges != 0)
   checkTrue(result$rstreetWid != 0)
   checkTrue(result$rsidewalkWid != 0)
   checkTrue(result$rdebris != 0)
   checkTrue(result$rpavement != 0)
   checkTrue(result$rlandscape != 0)
   checkTrue(result$rpropStreetWall != 0)
   checkTrue(result$rpropWind != 0)
   checkTrue(result$rlongSight != 0)
   checkTrue(result$rpropSkyAhead != 0)
   checkTrue(result$rpropSkyAcross != 0)
   checkTrue(result$rbuildHeight != 0)
   checkTrue(result$rpropActiveUse != 0)
   
   checkTrue(is.na(result$rsdMovCars))
   checkTrue(is.na(result$rsdParkCars))
   checkTrue(is.na(result$rsdMovCicly))
   checkTrue(is.na(result$rsdBuildId))
   checkTrue(is.na(result$rsdBuildNRec))
   checkTrue(is.na(result$rsdTree))
   checkTrue(is.na(result$rsdSmallPla))
   checkTrue(is.na(result$rsdDiffBuild))
   checkTrue(is.na(result$rsdStreeFur))
   checkTrue(is.na(result$rsdBasCol))
   checkTrue(is.na(result$rsdLigh))
   checkTrue(is.na(result$rsdAccenCol))
   checkTrue(is.na(result$rsdPeop))
   checkTrue(is.na(result$rsdGraff))
   checkTrue(is.na(result$rsdBuildDiffAges))
   checkTrue(is.na(result$rsdStreetWid))
   checkTrue(is.na(result$rsdSidewalkWid))
   checkTrue(is.na(result$rsdDebris))
   checkTrue(is.na(result$rsdPavement))
   checkTrue(is.na(result$rsdLandscape))
   checkTrue(is.na(result$rsdPropStreetWall))
   checkTrue(is.na(result$rsdPropWind))
   checkTrue(is.na(result$rsdLongSight))
   checkTrue(is.na(result$rsdPropSkyAhead))
   checkTrue(is.na(result$rsdPropSkyAcross))
   checkTrue(is.na(result$rsdBuildHeight))
   checkTrue(is.na(result$rsdPropActiveUse))
   
   checkTrue(result$movCarsN == 4 / 12)
   checkTrue(result$parkCarsN == 6 / 18)
   checkTrue(result$movCiclyN == 6 / 18)
   checkTrue(result$buildIdN == 6 / 18)
   checkTrue(result$buildNRecN == 4 / 12)
   checkTrue(result$treeN == 8 / 24)
   checkTrue(result$smallPlaN == 4 / 16)
   checkTrue(result$diffBuildN == 4 / 12)
   checkTrue(result$streeFurN == 4 / 12)
   checkTrue(result$basColN == 4 / 12)
   checkTrue(result$lighN == 4 / 12)
   checkTrue(result$accenColN == 4 / 12)
   checkTrue(result$peopN == 4 / 12)
   checkTrue(result$graffN == 4 / 12)
   checkTrue(result$buildDiffAgesN == 4 / 12)
   checkTrue(result$streetWidN== 8 / 24)
   checkTrue(result$sidewalkWidN== 4 / 12)
   checkTrue(result$debrisN== mean(c(4,4,0)) / mean(c(4,0,4,4,4,0,0,4,4,0)))
   checkTrue(result$pavementN== mean(c(2,2,0)) / mean(c(2,0,2,2,2,0,0,2,2,0)))
   checkTrue(result$landscapeN== mean(c(2,2,0)) / mean(c(2,0,2,2,2,0,0,2,2,0)))
   checkTrue(result$propStreetWallN== mean(c(2,2,0)) / mean(c(2,0,2,2,2,0,0,2,2,0)))
   checkTrue(result$propWindN== mean(c(2,2,0)) / mean(c(2,0,2,2,2,0,0,2,2,0)))
   checkTrue(result$longSightN== 4 / 12)
   checkTrue(result$propSkyAheadN== mean(c(2,2,0)) / mean(c(3,1,3,3,2,0,0,2,2,0)))
   checkTrue(result$propSkyAcrossN== mean(c(2,2,0)) / mean(c(2,0,2,2,2,0,0,2,2,0)))
   checkTrue(result$buildHeightN== 4 / 12)
   checkTrue(result$propActiveUseN== mean(c(2,2,0)) / mean(c(2,0,2,2,2,0,0,2,2,0)))
}

test.kendallWithDiffRankingsNonZeroDiffFeatureAndMoreThanOneIteration <- function(){
   mov_cars <- c(2,0,2,0,0)
   park_cars <- c(3,0,3,0,0)
   mov_ciclyst <- c(3,0,3,0,0)
   build_ident <- c(3,0,3,0,0)
   build_nrectan <- c(2,0,2,0,0)
   trees <- c(4,0,4,0,0)
   small_planters <- c(3,0,2,0,0)
   diff_build <- c(2,0,2,0,0)
   street_furnit <- c(2,0,2,0,0)
   basic_col <- c(2,0,2,0,0)
   lights <- c(2,0,2,0,0)
   accent_col <- c(2,0,2,0,0)
   people <- c(2,0,2,0,0)
   graffiti <- c(2,0,2,0,0)
   build_diff_ages <- c(2,0,2,0,0)
   street_wid <- c(4,0,4,0,0)
   sidewalk_wid<- c(2,0,2,0,0)
   debris<- c(4,0,4,0,0)
   pavement<- c(2,0,2,0,0)
   landscape<- c(2,0,2,0,0)
   prop_street_wall<- c(2,0,2,0,0)
   prop_wind<- c(2,0,2,0,0)
   long_sight<- c(2,0,2,0,0)
   prop_sky_ahead<- c(3,0,2,0,0)
   prop_sky_across<- c(2,0,2,0,0)
   build_height<- c(2,0,2,0,0)
   prop_active_use<- c(2,0,2,0,0)
   
   agradTest <- data.frame(rank=c(1,2,3,4,5), index=c(1, 2, 5, 4, 3), mov_cars=mov_cars, park_cars=park_cars, mov_ciclyst = mov_ciclyst, build_ident = build_ident, build_nrectan = build_nrectan, trees = trees, small_planters = small_planters, diff_build = diff_build, street_furnit = street_furnit, basic_col = basic_col, lights = lights, accent_col = accent_col, people = people, graffiti = graffiti, build_diff_ages = build_diff_ages, street_wid = street_wid, sidewalk_wid = sidewalk_wid, debris = debris, pavement = pavement, landscape = landscape, prop_street_wall = prop_street_wall, prop_wind = prop_wind, long_sight = long_sight, prop_sky_ahead = prop_sky_ahead, prop_sky_across = prop_sky_across, build_height = build_height, prop_active_use = prop_active_use, masc=c(1,2,3,4,5), fem=c(1,2,5,4,3))
   iterations <- 2

   result <- kendallWithWeights(agradTest, iterations, "masc", "fem")
   checkEquals(length(result), 135)
   checkTrue(result$movCars == 2 * 2)
   checkTrue(result$parkCars == 3 * 2)
   checkTrue(result$movCicly == 3 * 2)
   checkTrue(result$buildId == 3 * 2)
   checkTrue(result$buildNRec == 2 * 2)
   checkTrue(result$tree == 4 * 2)
   checkTrue(result$smallPla == 2 * 2)
   checkTrue(result$diffBuild == 2 * 2)
   checkTrue(result$streeFur == 2 * 2)
   checkTrue(result$basCol == 2 * 2)
   checkTrue(result$ligh == 2 * 2)
   checkTrue(result$accenCol == 2 * 2)
   checkTrue(result$peop == 2 * 2)
   checkTrue(result$graff == 2 * 2)
   checkTrue(result$buildDiffAges == 2 * 2)
   checkTrue(result$streetWid == 4 * 2)
   checkTrue(result$sidewalkWid == 2 * 2)
   checkTrue(result$debris == (4 * 2)/3)#Mean of changes!
   checkTrue(result$pavement == (2 * 2)/3)
   checkTrue(result$landscape == (2 * 2)/3)
   checkTrue(result$propStreetWall == (2 * 2)/3)
   checkTrue(result$propWind == (2 * 2)/3)
   checkTrue(result$longSight == 2 * 2)
   checkTrue(result$propSkyAhead == (2 * 2)/3)
   checkTrue(result$propSkyAcross == (2 * 2)/3)
   checkTrue(result$buildHeight == 2 * 2)
   checkTrue(result$propActiveUse == (2 * 2)/3)
   
   checkTrue(result$rmovCars > 0)
   checkTrue(result$rparkCars > 0)
   checkTrue(result$rmovCicly > 0)
   checkTrue(result$rbuildId  > 0)
   checkTrue(result$rbuildNRec  > 0)
   checkTrue(result$rtree > 0)
   checkTrue(result$rsmallPla > 0)
   checkTrue(result$rdiffBuild > 0)
   checkTrue(result$rstreeFur > 0)
   checkTrue(result$rbasCol > 0)
   checkTrue(result$rligh > 0)
   checkTrue(result$raccenCol > 0)
   checkTrue(result$rpeop > 0)
   checkTrue(result$rgraff > 0)
   checkTrue(result$rbuildDiffAges > 0)
   checkTrue(result$rstreetWid > 0)
   checkTrue(result$rsidewalkWid > 0)
   checkTrue(result$rdebris > 0)
   checkTrue(result$rpavement > 0)
   checkTrue(result$rlandscape > 0)
   checkTrue(result$rpropStreetWall > 0)
   checkTrue(result$rpropWind > 0)
   checkTrue(result$rlongSight > 0)
   checkTrue(result$rpropSkyAhead > 0)
   checkTrue(result$rpropSkyAcross > 0)
   checkTrue(result$rbuildHeight > 0)
   checkTrue(result$rpropActiveUse > 0)
   
   checkTrue(result$rsdMovCars >= 0)
   checkTrue(result$rsdParkCars >= 0)
   checkTrue(result$rsdMovCicly >= 0)
   checkTrue(result$rsdBuildId  >= 0)
   checkTrue(result$rsdBuildNRec  >= 0)
   checkTrue(result$rsdTree >= 0)
   checkTrue(result$rsdSmallPla >= 0)
   checkTrue(result$rsdDiffBuild >= 0)
   checkTrue(result$rsdStreeFur >= 0)
   checkTrue(result$rsdBasCol >= 0)
   checkTrue(result$rsdLigh >= 0)
   checkTrue(result$rsdAccenCol >= 0)
   checkTrue(result$rsdPeop >= 0)
   checkTrue(result$rsdGraff >= 0)
   checkTrue(result$rsdBuildDiffAges >= 0)
   checkTrue(result$rsdStreetWid>= 0)
   checkTrue(result$rsdSidewalkWid>= 0)
   checkTrue(result$rsdDebris>= 0)
   checkTrue(result$rsdPavement>= 0)
   checkTrue(result$rsdLandscape>= 0)
   checkTrue(result$rsdPropStreetWall>= 0)
   checkTrue(result$rsdPropWind>= 0)
   checkTrue(result$rsdLongSight>= 0)
   checkTrue(result$rsdPropSkyAhead>= 0)
   checkTrue(result$rsdPropSkyAcross>= 0)
   checkTrue(result$rsdBuildHeight>= 0)
   checkTrue(result$rsdPropActiveUse>= 0)
   
   checkTrue(result$movCarsN == 4 / 12)
   checkTrue(result$parkCarsN == 6 / 18)
   checkTrue(result$movCiclyN == 6 / 18)
   checkTrue(result$buildIdN == 6 / 18)
   checkTrue(result$buildNRecN == 4 / 12)
   checkTrue(result$treeN == 8 / 24)
   checkTrue(result$smallPlaN == 4 / 16)
   checkTrue(result$diffBuildN == 4 / 12)
   checkTrue(result$streeFurN == 4 / 12)
   checkTrue(result$basColN == 4 / 12)
   checkTrue(result$lighN == 4 / 12)
   checkTrue(result$accenColN == 4 / 12)
   checkTrue(result$peopN == 4 / 12)
   checkTrue(result$graffN == 4 / 12)
   checkTrue(result$buildDiffAgesN == 4 / 12)
   checkTrue(result$streetWidN== 8 / 24)
   checkTrue(result$sidewalkWidN== 4 / 12)
   checkTrue(result$debrisN== mean(c(4,4,0)) / mean(c(4,0,4,4,4,0,0,4,4,0)))
   checkTrue(result$pavementN== mean(c(2,2,0)) / mean(c(2,0,2,2,2,0,0,2,2,0)))
   checkTrue(result$landscapeN== mean(c(2,2,0)) / mean(c(2,0,2,2,2,0,0,2,2,0)))
   checkTrue(result$propStreetWallN== mean(c(2,2,0)) / mean(c(2,0,2,2,2,0,0,2,2,0)))
   checkTrue(result$propWindN== mean(c(2,2,0)) / mean(c(2,0,2,2,2,0,0,2,2,0)))
   checkTrue(result$longSightN== 4 / 12)
   checkTrue(result$propSkyAheadN== mean(c(2,2,0)) / mean(c(3,1,3,3,2,0,0,2,2,0)))
   checkTrue(result$propSkyAcrossN== mean(c(2,2,0)) / mean(c(2,0,2,2,2,0,0,2,2,0)))
   checkTrue(result$buildHeightN== 4 / 12)
   checkTrue(result$propActiveUseN== mean(c(2,2,0)) / mean(c(2,0,2,2,2,0,0,2,2,0)))
}
```


## Men x Women - Pleasantness

```{r, echo=FALSE, fig.show='asis', fig.width=10, fig.height=5}
agrad.l <- agrad %>% do(arrange(., desc(V3.Masculino))) %>% 
    mutate(rank = 1:n()) %>% do(arrange(., desc(V3.Feminino))) %>% mutate(index = 1:n())
agrad.l$diff <- agrad.l$rank - agrad.l$index

agrad.l <- calcDanieleCoeff(agrad.l)
agrad.l2 <- simulateCoefShuffle(agrad.l, iterations)

print(paste(">>>> Kendall Distance ", normalizedKendallTauDistance2(agrad.l$V3.Masculino, agrad.l$V3.Feminino)))
res <- melt(kendallWithWeights(agrad.l, iterations))
print(res, row.names=FALSE)
convertSummary(res, iterations)

printOutputOneListPerFeature(agrad.l2, "V3.Masculino", "V3.Feminino")
printOutputTwoListsPerFeature(agrad.l2, "V3.Masculino", "V3.Feminino")
printOutputTwoListsForAll(agrad.l2)

citySummary("V3.Masculino", agrad.l)
citySummary("V3.Feminino", agrad.l)

#Top 20 images based on diff, regression for men and women QScore
# top20Diff <- arrange(agrad.l, desc(diff)) %>% slice(1:40)
# 
# regGroup1 <- lm(rank ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, na.action = na.exclude, data = agrad.l)
# regGroup2 <- lm(index ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, na.action = na.exclude, data = agrad.l)
# summary(regGroup1)
# summary(regGroup2)

regDiff <- lm(diff ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + build_ident + build_nrectan +  + long_sight + as.integer(graffiti) + trees + small_planters + build_height + as.integer(build_diff_ages) + diff_build + street_furnit + basic_col + lights + accent_col + people, na.action = na.exclude, data = agrad.l)
summary(regDiff)

#Spatial regression - consider spatial dependency and correlation!
library(spdep)
library(texreg)
sink("spatialRegression.dat")

res <- getLatLong(agrad.l, "moran100/streetsQScoresLatLongAgraAll2.dat")
crd <- cbind(res$long, res$lat)
k2 <- knn2nb(knearneigh(unique(crd)))
maxDist <- max(unlist(nbdists(k2, unique(crd))))
neigh <- dnearneigh(crd, 0, 1000*maxDist, longlat=TRUE)#Neighborhoods based on distance! Which values to use as limits? From example were 0, 100; 0, 1 * max or 1.5 * max
neigh2 <- nb2listw(neigh, style = "B")#Binary weights, control amount of neighbors giving more influence to the ones with more neighbors!

source("krippMoran.R")
moranI2(res, "V3.Geral")
moranI2(res, "V3.Masculino")
moranI2(res, "V3.Feminino")

reg <- lm(V3.Masculino ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, na.action = na.exclude, data = filter(res, V1 == "agradavel?"))#OLS regression - minimize squared distances of line and points! red + green + blue + hor + vert + diag
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

#test for spatial autocorrelation using residuals
moran <- lm.morantest(reg, neigh2, alternative="two.sided")
summary(moran)
moran

reg <- spautolm(V3.Masculino ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, data=filter(res, V1 == "agradavel?"), listw=neigh2)
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

reg <- lm(V3.Feminino ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, na.action = na.exclude, data = filter(res, V1 == "agradavel?"))#+ red + green + blue + hor + vert + diag
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

#test for spatial autocorrelation using residuals
moran <- lm.morantest(reg, neigh2, alternative="two.sided")
summary(moran)
moran

reg <- spautolm(V3.Feminino ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, data=filter(res, V1 == "agradavel?"), listw=neigh2)
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))
```


## Young x Adult - Pleasantness

```{r, echo=FALSE, fig.show='asis', fig.width=10, fig.height=5}
agrad.l <- agrad %>% 
    do(arrange(., desc(V3.Jovem))) %>% 
    mutate(rank = 1:n()) %>% do(arrange(., desc(V3.Adulto))) %>% mutate(index = 1:n())
agrad.l$diff <- agrad.l$rank - agrad.l$index

agrad.l <- calcDanieleCoeff(agrad.l)
agrad.l2 <- simulateCoefShuffle(agrad.l, iterations)

print(paste(">>>> Kendall Distance ", normalizedKendallTauDistance2(agrad.l$V3.Jovem, agrad.l$V3.Adulto)))
res <- melt(kendallWithWeights(agrad.l, iterations))
print(res, row.names=FALSE)
convertSummary(res, iterations)

#Sectors with difference
diff <- filter(agrad.l, setor == "25040090500004") #YA Centro
print(paste(">>>> Kendall Distance 004-Cen", normalizedKendallTauDistance2(diff$V3.Jovem, diff$V3.Adulto)))
res <- melt(kendallWithWeights(diff, iterations))
print(res, row.names=FALSE)
convertSummary(res, iterations)

diff <- filter(agrad.l, setor == "250400905000089") #YA Lib
print(paste(">>>> Kendall Distance 0089-Lib", normalizedKendallTauDistance2(diff$V3.Jovem, diff$V3.Adulto)))
res <- melt(kendallWithWeights(diff, iterations))
print(res, row.names=FALSE)
convertSummary(res, iterations)

printOutputOneListPerFeature(agrad.l2, "V3.Jovem", "V3.Adulto")
printOutputTwoListsPerFeature(agrad.l2, "V3.Jovem", "V3.Adulto")
printOutputTwoListsForAll(agrad.l2)

citySummary("V3.Jovem", agrad.l)
citySummary("V3.Adulto", agrad.l)

#Top 20 images based on diff, regression for men and women QScore
top20Diff <- filter(agrad.l, setor == "25040090500004" | setor == "250400905000089")
top20Diff <- arrange(agrad.l, desc(diff)) %>% slice(1:40)

regGroup1 <- lm(rank ~ scale(street_wid) + scale(sidewalk_wid) + scale(mov_cars) + scale(park_cars) + scale(mov_ciclyst) + scale(debris) + scale(pavement) + scale(landscape) + scale(build_ident) + scale(build_nrectan) + scale(prop_street_wall) + scale(prop_wind) + scale(long_sight) + scale(prop_sky_ahead) + scale(prop_sky_across) + scale(as.integer(graffiti)) + scale(trees) + scale(small_planters) + scale(build_height) + scale(as.integer(build_diff_ages)) + scale(diff_build) + scale(street_furnit) + scale(basic_col) + scale(lights) + scale(accent_col) + scale(people) + scale(prop_active_use), na.action = na.exclude, data = agrad.l)
#Features being considered in coefficient first verstion
regGroup1 <- lm(rank ~ scale(mov_cars) + scale(park_cars) + scale(mov_ciclyst) + scale(build_ident) + scale(build_nrectan) + scale(as.integer(graffiti)) + scale(trees) + scale(small_planters) + scale(as.integer(build_diff_ages)) + scale(diff_build) + scale(street_furnit) + scale(basic_col) + scale(lights) + scale(accent_col) + scale(people), na.action = na.exclude, data = agrad.l)
#regGroup2 <- lm(index ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, na.action = na.exclude, data = top20Diff)
regGroup2 <- lm(index ~  scale(street_wid) + scale(sidewalk_wid) + scale(mov_cars) + scale(park_cars) + scale(mov_ciclyst) + scale(debris) + scale(pavement) + scale(landscape) + scale(build_ident) + scale(build_nrectan) + scale(prop_street_wall) + scale(prop_wind) + scale(long_sight) + scale(prop_sky_ahead) + scale(prop_sky_across) + scale(as.integer(graffiti)) + scale(trees) + scale(small_planters) + scale(build_height) + scale(as.integer(build_diff_ages)) + scale(diff_build) + scale(street_furnit) + scale(basic_col) + scale(lights) + scale(accent_col) + scale(people) + scale(prop_active_use), na.action = na.exclude, data = agrad.l)
#Features being considered in coefficient first version
regGroup2 <- lm(index ~  scale(mov_cars) + scale(park_cars) + scale(mov_ciclyst) + scale(build_ident) + scale(build_nrectan) + scale(as.integer(graffiti)) + scale(trees) + scale(small_planters) + scale(as.integer(build_diff_ages)) + scale(diff_build) + scale(street_furnit) + scale(basic_col) + scale(lights) + scale(accent_col) + scale(people), na.action = na.exclude, data = agrad.l)
summary(regGroup1)
summary(regGroup2)

regDiff <- lm(diff ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + build_ident + build_nrectan +  + long_sight + as.integer(graffiti) + trees + small_planters + build_height + as.integer(build_diff_ages) + diff_build + street_furnit + basic_col + lights + accent_col + people, na.action = na.exclude, data = agrad.l)
summary(regDiff)

#Spatial regression - consider spatial dependency and correlation!
res <- getLatLong(agrad.l, "moran100/streetsQScoresLatLongAgraAll2.dat")
crd <- cbind(res$long, res$lat)
k2 <- knn2nb(knearneigh(unique(crd)))
maxDist <- max(unlist(nbdists(k2, unique(crd))))
neigh <- dnearneigh(crd, 0, 1000*maxDist, longlat=TRUE)#Neighborhoods based on distance! Which values to use as limits? From example were 0, 100; 0, 1 * max or 1.5 * max
neigh2 <- nb2listw(neigh, style = "B")

moranI2(res, "V3.Jovem")
moranI2(res, "V3.Adulto")

reg <- lm(V3.Jovem ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, na.action = na.exclude, data = filter(res, V1 == "agradavel?"))#+ red + green + blue + hor + vert + diag
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

#test for spatial autocorrelation using residuals
moran <- lm.morantest(reg, neigh2, alternative="two.sided")
summary(moran)
moran

reg <- spautolm(V3.Jovem ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, data=filter(res, V1 == "agradavel?"), listw=neigh2)
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

reg <- lm(V3.Adulto ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use , na.action = na.exclude, data = filter(res, V1 == "agradavel?"))#+ red + green + blue + hor + vert + diag
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

#test for spatial autocorrelation using residuals
moran <- lm.morantest(reg, neigh2, alternative="two.sided")
summary(moran)
moran

reg <- spautolm(V3.Adulto ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, data=filter(res, V1 == "agradavel?"), listw=neigh2)
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

# #Cross-validating
# regGeralAgrad <- lm(V3.Adulto ~ street_wid + mov_cars + debris + landscape + prop_wind + prop_sky_across + graffiti + trees + diff_build + lights + accent_col, na.action = na.exclude, data = agrad.l)
# regGeralAgrad <- lm(V3.Adulto ~ sidewalk_wid + mov_cars + debris + landscape + build_ident + build_nrectan + prop_wind + prop_sky_across + trees + build_diff_ages + lights + accent_col, na.action = na.exclude, data = subSample)
# regGeralAgrad <- lm(V3.Adulto ~ sidewalk_wid + mov_cars + debris + landscape + prop_wind + graffiti + trees + street_furnit + + accent_col, na.action = na.exclude, data = left)
# 
# summary(regGeralAgrad)
# texreg(regGeralAgrad, stars = c(0.001, 0.01, 0.05, 0.1))

```

## Married x Single - Pleasantness

```{r, echo=FALSE, fig.show='asis', fig.width=10, fig.height=5}
agrad.l <- agrad %>% 
    do(arrange(., desc(V3.Casado))) %>% 
    mutate(rank = 1:n()) %>% do(arrange(., desc(V3.Solteiro))) %>% mutate(index = 1:n())
agrad.l$diff <- agrad.l$rank - agrad.l$index

agrad.l <- calcDanieleCoeff(agrad.l)
agrad.l2 <- simulateCoefShuffle(agrad.l,iterations)

print(paste(">>>> Kendall Distance ", normalizedKendallTauDistance2(agrad.l$V3.Casado, agrad.l$V3.Solteiro)))
res <- melt(kendallWithWeights(agrad.l, iterations))
print(res, row.names=FALSE)
convertSummary(res, iterations)

#Sector with diff
diff <- filter(agrad.l, setor == "250400905000089") #MS Lib
print(paste(">>>> Kendall Distance 0089-Lib", normalizedKendallTauDistance2(diff$V3.Casado, diff$V3.Solteiro)))
res <- melt(kendallWithWeights(diff, iterations))
print(res, row.names=FALSE)
convertSummary(res, iterations)

printOutputOneListPerFeature(agrad.l2, "V3.Casado", "V3.Solteiro")
printOutputTwoListsPerFeature(agrad.l2, "V3.Casado", "V3.Solteiro")
printOutputTwoListsForAll(agrad.l2)

citySummary("V3.Casado", agrad.l)
citySummary("V3.Solteiro", agrad.l)

#Top 20 images based on diff, regression for men and women QScore
# top20Diff <- filter(agrad.l, bairro == "liberdade")
# top20Diff <- arrange(agrad.l, desc(diff)) %>% slice(1:40)

# regGroup1 <- lm(rank ~ scale(street_wid) + scale(sidewalk_wid) + scale(mov_cars) + scale(park_cars) + scale(mov_ciclyst) + scale(debris) + scale(pavement) + scale(landscape) + scale(build_ident) + scale(build_nrectan) + scale(prop_street_wall) + scale(prop_wind) + scale(long_sight) + scale(prop_sky_ahead) + scale(prop_sky_across) + scale(as.integer(graffiti)) + scale(trees) + scale(small_planters) + scale(build_height) + scale(as.integer(build_diff_ages)) + scale(diff_build) + scale(street_furnit) + scale(basic_col) + scale(lights) + scale(accent_col) + scale(people) + scale(prop_active_use), na.action = na.exclude, data = top20Diff)
#regGroup2 <- lm(index ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, na.action = na.exclude, data = top20Diff)
# regGroup2 <- lm(index ~  scale(street_wid) + scale(sidewalk_wid) + scale(mov_cars) + scale(park_cars) + scale(mov_ciclyst) + scale(debris) + scale(pavement) + scale(landscape) + scale(build_ident) + scale(build_nrectan) + scale(prop_street_wall) + scale(prop_wind) + scale(long_sight) + scale(prop_sky_ahead) + scale(prop_sky_across) + scale(as.integer(graffiti)) + scale(trees) + scale(small_planters) + scale(build_height) + scale(as.integer(build_diff_ages)) + scale(diff_build) + scale(street_furnit) + scale(basic_col) + scale(lights) + scale(accent_col) + scale(people) + scale(prop_active_use), na.action = na.exclude, data = top20Diff)
# summary(regGroup1)
# summary(regGroup2)

regDiff <- lm(diff ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + build_ident + build_nrectan +  + long_sight + as.integer(graffiti) + trees + small_planters + build_height + as.integer(build_diff_ages) + diff_build + street_furnit + basic_col + lights + accent_col + people, na.action = na.exclude, data = agrad.l)
summary(regDiff)
  
#Spatial regression - consider spatial dependency and correlation!
res <- getLatLong(agrad.l[1:107,], "moran100/streetsQScoresLatLongAgraAll2.dat")
crd <- cbind(res$long, res$lat)
k2 <- knn2nb(knearneigh(unique(crd)))
maxDist <- max(unlist(nbdists(k2, unique(crd))))
neigh <- dnearneigh(crd, 0, 1000*maxDist, longlat=TRUE)#Neighborhoods based on distance! Which values to use as limits? From example were 0, 100; 0, 1 * max or 1.5 * max
neigh2 <- nb2listw(neigh, style = "B")

moranI2(res, "V3.Casado")
moranI2(res, "V3.Solteiro")

reg <- lm(V3.Casado ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, na.action = na.exclude, data = filter(res, V1 == "agradavel?"))# + red + green + blue + hor + vert + diag
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

#test for spatial autocorrelation using residuals
moran <- lm.morantest(reg, neigh2, alternative="two.sided")
summary(moran)
moran

reg <- spautolm(V3.Casado ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, data=filter(res, V1 == "agradavel?"), listw=neigh2)
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

reg <- lm(V3.Solteiro ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use , na.action = na.exclude, data = filter(res, V1 == "agradavel?"))#+ red + green + blue + hor + vert + diag
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

#test for spatial autocorrelation using residuals
moran <- lm.morantest(reg, neigh2, alternative="two.sided")
summary(moran)
moran

reg <- spautolm(V3.Solteiro ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, data=filter(res, V1 == "agradavel?"), listw=neigh2)
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))
```

## Low x High income - Pleasantness

```{r, echo=FALSE, fig.show='asis', fig.width=10, fig.height=5}
agrad.l <- agrad %>% 
    do(arrange(., desc(V3.Baixa))) %>% 
    mutate(rank = 1:n()) %>% do(arrange(., desc(V3.Media))) %>% mutate(index = 1:n())
agrad.l$diff <- agrad.l$rank - agrad.l$index

#Danieles coefficients
agrad.l <- calcDanieleCoeff(agrad.l)
agrad.l2 <- simulateCoefShuffle(agrad.l,iterations)

print(paste(">>>> Kendall Distance ", normalizedKendallTauDistance2(agrad.l$V3.Baixa, agrad.l$V3.Media)))
res <- melt(kendallWithWeights(agrad.l, iterations))
print(res, row.names=FALSE)
convertSummary(res, iterations)

printOutputOneListPerFeature(agrad.l2, "V3.Baixa", "V3.Media")
printOutputTwoListsPerFeature(agrad.l2, "V3.Baixa", "V3.Media")
printOutputTwoListsForAll(agrad.l2)

citySummary("V3.Baixa", agrad.l)
citySummary("V3.Media", agrad.l)

#Top 20 images based on diff, regression for men and women QScore
top20Diff <- arrange(agrad.l, desc(diff)) %>% slice(1:40)

regGroup1 <- lm(rank ~ scale(street_wid) + scale(sidewalk_wid) + scale(mov_cars) + scale(park_cars) + scale(mov_ciclyst) + scale(debris) + scale(pavement) + scale(landscape) + scale(build_ident) + scale(build_nrectan) + scale(prop_street_wall) + scale(prop_wind) + scale(long_sight) + scale(prop_sky_ahead) + scale(prop_sky_across) + scale(as.integer(graffiti)) + scale(trees) + scale(small_planters) + scale(build_height) + scale(as.integer(build_diff_ages)) + scale(diff_build) + scale(street_furnit) + scale(basic_col) + scale(lights) + scale(accent_col) + scale(people) + scale(prop_active_use), na.action = na.exclude, data = top20Diff)
#regGroup2 <- lm(index ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, na.action = na.exclude, data = top20Diff)
regGroup2 <- lm(index ~  scale(street_wid) + scale(sidewalk_wid) + scale(mov_cars) + scale(park_cars) + scale(mov_ciclyst) + scale(debris) + scale(pavement) + scale(landscape) + scale(build_ident) + scale(build_nrectan) + scale(prop_street_wall) + scale(prop_wind) + scale(long_sight) + scale(prop_sky_ahead) + scale(prop_sky_across) + scale(as.integer(graffiti)) + scale(trees) + scale(small_planters) + scale(build_height) + scale(as.integer(build_diff_ages)) + scale(diff_build) + scale(street_furnit) + scale(basic_col) + scale(lights) + scale(accent_col) + scale(people) + scale(prop_active_use), na.action = na.exclude, data = top20Diff)
summary(regGroup1)
summary(regGroup2)

regDiff <- lm(diff ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + build_ident + build_nrectan +  + long_sight + as.integer(graffiti) + trees + small_planters + build_height + as.integer(build_diff_ages) + diff_build + street_furnit + basic_col + lights + accent_col + people, na.action = na.exclude, data = agrad.l)
summary(regDiff)

#Spatial regression - consider spatial dependency and correlation!
res <- getLatLong(agrad.l, "moran100/streetsQScoresLatLongAgraAll2.dat")
crd <- cbind(res$long, res$lat)
k2 <- knn2nb(knearneigh(unique(crd)))
maxDist <- max(unlist(nbdists(k2, unique(crd))))
neigh <- dnearneigh(crd, 0, 1000*maxDist, longlat=TRUE)#Neighborhoods based on distance! Which values to use as limits? From example were 0, 100; 0, 1 * max or 1.5 * max
neigh2 <- nb2listw(neigh, style = "B")

moranI2(res, "V3.Baixa")
moranI2(res, "V3.Media")

reg <- lm(V3.Baixa ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use , na.action = na.exclude, data = filter(res, V1 == "agradavel?"))#+ red + green + blue + hor + vert + diag
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

#test for spatial autocorrelation using residuals
moran <- lm.morantest(reg, neigh2, alternative="two.sided")
summary(moran)
moran

reg <- spautolm(V3.Baixa ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, data=filter(res, V1 == "agradavel?"), listw=neigh2)
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

reg <- lm(V3.Media ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, na.action = na.exclude, data = filter(res, V1 == "agradavel?"))#+ red + green + blue + hor + vert + diag
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

#test for spatial autocorrelation using residuals
moran <- lm.morantest(reg, neigh2, alternative="two.sided")
summary(moran)
moran

reg <- spautolm(V3.Media ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, data=filter(res, V1 == "agradavel?"), listw=neigh2)
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))
```

## Men x Women - Safety

```{r, echo=FALSE, fig.show='asis', fig.width=10, fig.height=5}
seg.l <- seg %>% 
    do(arrange(., desc(V3.Masculino))) %>% 
    mutate(rank = 1:n()) %>% do(arrange(., desc(V3.Feminino))) %>% mutate(index = 1:n())
seg.l$diff <- seg.l$rank - seg.l$index

seg.l <- calcDanieleCoeff(seg.l)
seg.l2 <- simulateCoefShuffle(seg.l,iterations)

print(paste(">>>> Kendall Distance ", normalizedKendallTauDistance2(seg.l$V3.Masculino, seg.l$V3.Feminino)))
res <- melt(kendallWithWeights(seg.l, iterations))
print(res, row.names=FALSE)
convertSummary(res, iterations)

printOutputOneListPerFeature(seg.l2, "V3.Masculino", "V3.Feminino")
printOutputTwoListsPerFeature(seg.l2, "V3.Masculino", "V3.Feminino")
printOutputTwoListsForAll(seg.l2)

citySummary("V3.Masculino", seg.l)
citySummary("V3.Feminino", seg.l)

regDiff <- lm(diff ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + build_ident + build_nrectan +  + long_sight + as.integer(graffiti) + trees + small_planters + build_height + as.integer(build_diff_ages) + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_wind + prop_active_use + prop_sky_ahead + prop_sky_across + debris + landscape + pavement, na.action = na.exclude, data = seg.l)
summary(regDiff)

#Spatial regression - consider spatial dependency and correlation!
res <- getLatLong(seg.l, "moran100/streetsQScoresLatLongAgraAll2.dat")
crd <- cbind(res$long, res$lat)
k2 <- knn2nb(knearneigh(unique(crd)))
maxDist <- max(unlist(nbdists(k2, unique(crd))))
neigh <- dnearneigh(crd, 0, 1000*maxDist, longlat=TRUE)#Neighborhoods based on distance! Which values to use as limits? From example were 0, 100; 0, 1 * max or 1.5 * max
neigh2 <- nb2listw(neigh, style = "B")

moranI2(res, "V3.Geral")
moranI2(res, "V3.Masculino")
moranI2(res, "V3.Feminino")

reg <- lm(V3.Masculino ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, na.action = na.exclude, data = filter(res, V1 == "seguro?"))
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

#test for spatial autocorrelation using residuals
moran <- lm.morantest(reg, neigh2, alternative="two.sided")
summary(moran)
moran

reg <- spautolm(V3.Masculino ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use , data=filter(res, V1 == "seguro?"), listw=neigh2)#+ red + green + blue + hor + vert + diag
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

reg <- lm(V3.Feminino ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, na.action = na.exclude, data = filter(res, V1 == "seguro?"))
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

#test for spatial autocorrelation using residuals
moran <- lm.morantest(reg, neigh2, alternative="two.sided")
summary(moran)
moran

reg <- spautolm(V3.Feminino ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use , data=filter(res, V1 == "seguro?"), listw=neigh2)#+ red + green + blue + hor + vert + diag
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))
```

## Young x Adult - Safety

```{r, echo=FALSE, fig.show='asis', fig.width=10, fig.height=5}
seg.l <- seg %>% 
    do(arrange(., desc(V3.Jovem))) %>% 
    mutate(rank = 1:n()) %>% do(arrange(., desc(V3.Adulto))) %>% mutate(index = 1:n())
seg.l$diff <- seg.l$rank - seg.l$index

seg.l <- calcDanieleCoeff(seg.l)
seg.l2 <- simulateCoefShuffle(seg.l,iterations)

print(paste(">>>> Kendall Distance ", normalizedKendallTauDistance2(seg.l$V3.Jovem, seg.l$V3.Adulto)))
res <- melt(kendallWithWeights(seg.l, iterations))
print(res, row.names=FALSE)
convertSummary(res, iterations)

#Sectors with difference
diff <- filter(seg.l, setor == "250400905000062") #YA Cat
print(paste(">>>> Kendall Distance 0062-Cat", normalizedKendallTauDistance2(diff$V3.Jovem, diff$V3.Adulto)))
res <- melt(kendallWithWeights(diff, iterations))
print(res, row.names=FALSE)
convertSummary(res, iterations)

printOutputOneListPerFeature(seg.l2, "V3.Jovem", "V3.Adulto")
printOutputTwoListsPerFeature(seg.l2, "V3.Jovem", "V3.Adulto")
printOutputTwoListsForAll(seg.l2)

citySummary("V3.Jovem", seg.l)
citySummary("V3.Adulto", seg.l)

regDiff <- lm(diff ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + build_ident + build_nrectan +  + long_sight + as.integer(graffiti) + trees + small_planters + build_height + as.integer(build_diff_ages) + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_wind + prop_active_use + prop_sky_ahead + prop_sky_across + debris + landscape + pavement, na.action = na.exclude, data = seg.l)
summary(regDiff)

#Spatial regression - consider spatial dependency and correlation!
res <- getLatLong(seg.l, "moran100/streetsQScoresLatLongAgraAll2.dat")
crd <- cbind(res$long, res$lat)
k2 <- knn2nb(knearneigh(unique(crd)))
maxDist <- max(unlist(nbdists(k2, unique(crd))))
neigh <- dnearneigh(crd, 0, 1000*maxDist, longlat=TRUE)#Neighborhoods based on distance! Which values to use as limits? From example were 0, 100; 0, 1 * max or 1.5 * max
neigh2 <- nb2listw(neigh, style = "B")

moranI2(res, "V3.Jovem")
moranI2(res, "V3.Adulto")

reg <- lm(V3.Jovem ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, na.action = na.exclude, data = filter(res, V1 == "seguro?"))
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

#test for spatial autocorrelation using residuals
moran <- lm.morantest(reg, neigh2, alternative="two.sided")
summary(moran)
moran

reg <- spautolm(V3.Jovem ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use , data=filter(res, V1 == "seguro?"), listw=neigh2)#+ red + green + blue + hor + vert + diag
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

reg <- lm(V3.Adulto ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, na.action = na.exclude, data = filter(res, V1 == "seguro?"))
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

#test for spatial autocorrelation using residuals
moran <- lm.morantest(reg, neigh2, alternative="two.sided")
summary(moran)
moran

reg <- spautolm(V3.Adulto ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use , data=filter(res, V1 == "seguro?"), listw=neigh2)#+ red + green + blue + hor + vert + diag
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))
```

## Married x Single - Safety

```{r, echo=FALSE, fig.show='asis', fig.width=10, fig.height=5}
seg.l <- seg %>% 
    do(arrange(., desc(V3.Casado))) %>% 
    mutate(rank = 1:n()) %>% do(arrange(., desc(V3.Solteiro))) %>% mutate(index = 1:n())
seg.l$diff <- seg.l$rank - seg.l$index

seg.l <- calcDanieleCoeff(seg.l)
seg.l2 <- simulateCoefShuffle(seg.l,iterations)

print(paste(">>>> Kendall Distance ", normalizedKendallTauDistance2(seg.l$V3.Casado, seg.l$V3.Solteiro)))
res <- melt(kendallWithWeights(seg.l, iterations))
print(res, row.names=FALSE)
convertSummary(res, iterations)

printOutputOneListPerFeature(seg.l2, "V3.Casado", "V3.Solteiro")
printOutputTwoListsPerFeature(seg.l2, "V3.Casado", "V3.Solteiro")
printOutputTwoListsForAll(seg.l2)

citySummary("V3.Casado", seg.l)
citySummary("V3.Solteiro", seg.l)

regDiff <- lm(diff ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + build_ident + build_nrectan +  + long_sight + as.integer(graffiti) + trees + small_planters + build_height + as.integer(build_diff_ages) + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_wind + prop_active_use + prop_sky_ahead + prop_sky_across + debris + landscape + pavement, na.action = na.exclude, data = seg.l)
summary(regDiff)

#Spatial regression - consider spatial dependency and correlation!
res <- getLatLong(seg.l, "moran100/streetsQScoresLatLongAgraAll2.dat")
crd <- cbind(res$long, res$lat)
k2 <- knn2nb(knearneigh(unique(crd)))
maxDist <- max(unlist(nbdists(k2, unique(crd))))
neigh <- dnearneigh(crd, 0, 1000*maxDist, longlat=TRUE)#Neighborhoods based on distance! Which values to use as limits? From example were 0, 100; 0, 1 * max or 1.5 * max
neigh2 <- nb2listw(neigh, style = "B")

moranI2(res, "V3.Casado")
moranI2(res, "V3.Solteiro")

reg <- lm(V3.Casado ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, na.action = na.exclude, data = filter(res, V1 == "seguro?"))
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

#test for spatial autocorrelation using residuals
moran <- lm.morantest(reg, neigh2, alternative="two.sided")
summary(moran)
moran

reg <- spautolm(V3.Casado ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use , data=filter(res, V1 == "seguro?"), listw=neigh2)#+ red + green + blue + hor + vert + diag
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

reg <- lm(V3.Solteiro ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, na.action = na.exclude, data = filter(res, V1 == "seguro?"))
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

#test for spatial autocorrelation using residuals
moran <- lm.morantest(reg, neigh2, alternative="two.sided")
summary(moran)
moran

reg <- spautolm(V3.Solteiro ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use , data=filter(res, V1 == "seguro?"), listw=neigh2)#+ red + green + blue + hor + vert + diag
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))
```

## Low x High income - Safety

```{r, echo=FALSE, fig.show='asis', fig.width=10, fig.height=5}
seg.l <- seg %>% 
    do(arrange(., desc(V3.Baixa))) %>% 
    mutate(rank = 1:n()) %>% do(arrange(., desc(V3.Media))) %>% mutate(index = 1:n())
seg.l$diff <- seg.l$rank - seg.l$index

seg.l <- calcDanieleCoeff(seg.l)
seg.l2 <- simulateCoefShuffle(seg.l,iterations)

print(paste(">>>> Kendall Distance ", normalizedKendallTauDistance2(seg.l$V3.Baixa, seg.l$V3.Media)))
res <- melt(kendallWithWeights(seg.l, iterations))
print(res, row.names=FALSE)
convertSummary(res, iterations)

#Sectors with difference
diff <- filter(seg.l, setor == "25040090500004") #LH Cen e Lib
print(paste(">>>> Kendall Distance 0004-Cen", normalizedKendallTauDistance2(diff$V3.Baixa, diff$V3.Media)))
res <- melt(kendallWithWeights(diff, iterations))
print(res, row.names=FALSE)
convertSummary(res, iterations)

diff <- filter(seg.l, setor == "250400905000089") #LH Cen e Lib
print(paste(">>>> Kendall Distance 0089-Lib", normalizedKendallTauDistance2(diff$V3.Baixa, diff$V3.Media)))
res <- melt(kendallWithWeights(diff, iterations))
print(res, row.names=FALSE)
convertSummary(res, iterations)

printOutputOneListPerFeature(seg.l2, "V3.Baixa", "V3.Media")
printOutputTwoListsPerFeature(seg.l2, "V3.Baixa", "V3.Media")
printOutputTwoListsForAll(seg.l2)

citySummary("V3.Baixa", seg.l)
citySummary("V3.Media", seg.l)

#Top 20 images based on diff, regression for men and women QScore
top20Diff <- filter(seg.l, setor == "25040090500004" | setor == "250400905000089")
top20Diff <- arrange(agrad.l, desc(diff)) %>% slice(1:40)

regGroup1 <- lm(rank ~ scale(street_wid) + scale(sidewalk_wid) + scale(mov_cars) + scale(park_cars) + scale(mov_ciclyst) + scale(debris) + scale(pavement) + scale(landscape) + scale(build_ident) + scale(build_nrectan) + scale(prop_street_wall) + scale(prop_wind) + scale(long_sight) + scale(prop_sky_ahead) + scale(prop_sky_across) + scale(as.integer(graffiti)) + scale(trees) + scale(small_planters) + scale(build_height) + scale(as.integer(build_diff_ages)) + scale(diff_build) + scale(street_furnit) + scale(basic_col) + scale(lights) + scale(accent_col) + scale(people) + scale(prop_active_use), na.action = na.exclude, data = top20Diff)
#regGroup2 <- lm(index ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, na.action = na.exclude, data = top20Diff)
regGroup2 <- lm(index ~  scale(street_wid) + scale(sidewalk_wid) + scale(mov_cars) + scale(park_cars) + scale(mov_ciclyst) + scale(debris) + scale(pavement) + scale(landscape) + scale(build_ident) + scale(build_nrectan) + scale(prop_street_wall) + scale(prop_wind) + scale(long_sight) + scale(prop_sky_ahead) + scale(prop_sky_across) + scale(as.integer(graffiti)) + scale(trees) + scale(small_planters) + scale(build_height) + scale(as.integer(build_diff_ages)) + scale(diff_build) + scale(street_furnit) + scale(basic_col) + scale(lights) + scale(accent_col) + scale(people) + scale(prop_active_use), na.action = na.exclude, data = top20Diff)
summary(regGroup1)
summary(regGroup2)

regDiff <- lm(diff ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + build_ident + build_nrectan +  + long_sight + as.integer(graffiti) + trees + small_planters + build_height + as.integer(build_diff_ages) + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_wind + prop_active_use + prop_sky_ahead + prop_sky_across + debris + landscape + pavement, na.action = na.exclude, data = seg.l)
summary(regDiff)


#Spatial regression - consider spatial dependency and correlation!
res <- getLatLong(seg.l, "moran100/streetsQScoresLatLongAgraAll2.dat")
crd <- cbind(res$long, res$lat)
k2 <- knn2nb(knearneigh(unique(crd)))
maxDist <- max(unlist(nbdists(k2, unique(crd))))
neigh <- dnearneigh(crd, 0, 1000*maxDist, longlat=FALSE)#Neighborhoods based on distance! Which values to use as limits? From example were 0, 100; 0, 1 * max or 1.5 * max
neigh2 <- nb2listw(neigh, style = "B")

moranI2(res, "V3.Baixa")
moranI2(res, "V3.Media")

reg <- lm(V3.Baixa ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, na.action = na.exclude, data = filter(res, V1 == "seguro?"))
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

#test for spatial autocorrelation using residuals
moran <- lm.morantest(reg, neigh2, alternative="two.sided")
summary(moran)
moran

reg <- spautolm(V3.Baixa ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use , data=filter(res, V1 == "seguro?"), listw=neigh2)#+ red + green + blue + hor + vert + diag
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

reg <- lm(V3.Media ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, na.action = na.exclude, data = filter(res, V1 == "seguro?"))
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

#test for spatial autocorrelation using residuals
moran <- lm.morantest(reg, neigh2, alternative="two.sided")
summary(moran)
moran

reg <- spautolm(V3.Media ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use , data=filter(res, V1 == "seguro?"), listw=neigh2)#+ red + green + blue + hor + vert + diag
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))
```

#Ploting features and coefficients

```{r, echo=FALSE, fig.show='asis', fig.width=10, fig.height=5}
#Merging random users ci data and real simulation ci data
test <- read.table("teste.dat", header=TRUE)#random values and sim mean
test2 <- read.table("teste2.dat", header=TRUE)#QScore simulation confidence intervals

newTest <- merge(test, test2, by.x="feature", by.y="feature")

res <- ggplot(data=filter(newTest, !(feature == "propActiveUse" | feature == "propWind" | feature == "propSkyAcross" | feature == "propSkyAhead" | feature == "propStreetWall" | feature == "debris" | feature == "landscape" | feature == "pavement")), aes(x=feature, y=random), col="black") + geom_point() + geom_errorbar(aes(ymin=lowerSid, ymax=higherSid), width=.1)
res + geom_point(aes(x=feature, y=realS), col="red") + geom_errorbar(aes(ymin=lowerS, ymax=higherS), width=.1, col="red") + ylab("Coeff") + xlab("Feature") + theme(axis.text.x = element_text(angle=60, hjust=1, size=15), axis.text.y=element_text(size=15))

res <- ggplot(data=filter(newTest, (feature == "propActiveUse" | feature == "propWind" | feature == "propSkyAcross" | feature == "propSkyAhead" | feature == "propStreetWall" | feature == "debris" | feature == "landscape" | feature == "pavement")), aes(x=feature, y=random), col="black") + geom_point() + geom_errorbar(aes(ymin=lowerSid, ymax=higherSid), width=.1) + ylim(c(-1, 1))
res + geom_point(aes(x=feature, y=realS), col="red") + geom_errorbar(aes(ymin=lowerS, ymax=higherS), width=.1, col="red") + ylab("Coeff") + xlab("Feature") + theme(axis.text.x = element_text(angle=60, hjust=1, size=15), axis.text.y=element_text(size=15))
  
#Counters sorted by normalized values
select(arrange(filter(newTest, !(feature == "propWind" | feature == "propActiveUse" | feature == "propSkyAhead" | feature == "propSkyAcross" | feature == "propStreetWall" | feature == "debris" | feature == "landscape" | feature == "pavement")), -abs(normS)), feature, normS, normS2)

#Features distribution
features <- select(agrad.l, mov_cars, mov_ciclyst, park_cars, build_ident, build_nrectan, graffiti, trees, small_planters, build_diff_ages, diff_build, street_furnit, basic_col, lights, accent_col, people, bairro, image_url)
features$id <- seq(0, 94) 
Molten <- melt(features, id.vars = c("image_url", "bairro", "id"))
ggplot(Molten, aes(x=id, y=value, colour=variable), ylab="Feature", xlab="Image") + geom_point() + facet_grid( bairro~variable, shrink=TRUE, as.table=TRUE) + scale_y_discrete(breaks=seq(0,8))

features <- select(agrad.l, long_sight, prop_street_wall, prop_wind, prop_sky_ahead, prop_sky_across, prop_active_use, prop_hist_build, bairro, image_url)
features$id <- seq(0, 94) 
Molten <- melt(features, id.vars = c("image_url", "bairro", "id"))
ggplot(Molten, aes(x=id, y=value, colour=variable), ylab="Feature", xlab="Image") + geom_point() + facet_grid( bairro~variable, shrink=TRUE, as.table=TRUE) + scale_y_discrete(breaks=seq(0,8))

features <- select(agrad.l, build_height, street_wid, sidewalk_wid, bairro, image_url)
features$id <- seq(0, 94) 
Molten <- melt(features, id.vars = c("image_url", "bairro", "id"))
ggplot(Molten, aes(x=id, y=value, colour=variable), ylab="Feature", xlab="Image") + geom_point() + facet_grid( bairro~variable, shrink=TRUE, as.table=TRUE) 

#Features most relevant for divergences between all groups
features <- select(agrad.l, build_height, build_diff_ages, people, build_nrectan, trees, mov_ciclyst, bairro, image_url)
features$id <- seq(0, 94) 
Molten <- melt(features, id.vars = c("image_url", "bairro", "id"))
ggplot(Molten, aes(x=id, y=value, colour=variable), ylab="Feature", xlab="Image") + geom_point() + facet_grid( bairro~variable, shrink=TRUE, as.table=TRUE) + scale_y_discrete(breaks=seq(0,8))

features <- select(agrad.l, build_ident, graffiti, small_planters, mov_cars, street_furnit, basic_col, bairro, image_url)
features$id <- seq(0, 94) 
Molten <- melt(features, id.vars = c("image_url", "bairro", "id"))
ggplot(Molten, aes(x=id, y=value, colour=variable), ylab="Feature", xlab="Image") + geom_point() + facet_grid( bairro~variable, shrink=TRUE, as.table=TRUE) + scale_y_discrete(breaks=seq(0,8))

features <- select(agrad.l, build_nrectan, mov_ciclyst, people, mov_cars, build_ident, small_planters, graffiti, park_cars, bairro, image_url)#For Safety
features$id <- seq(0, 94) 
Molten <- melt(features, id.vars = c("image_url", "bairro", "id"))
ggplot(Molten, aes(x=id, y=value, colour=variable), ylab="Feature", xlab="Image") + geom_point() + facet_grid( bairro~variable, shrink=TRUE, as.table=TRUE) + scale_y_discrete(breaks=seq(0,8))

features <- select(agrad.l, street_furnit, diff_build, trees, sidewalk_wid, accent_col, build_diff_ages,  long_sight, build_height, bairro, image_url)#For Safety
features$id <- seq(0, 94) 
Molten <- melt(features, id.vars = c("image_url", "bairro", "id"))
ggplot(Molten, aes(x=id, y=value, colour=variable), ylab="Feature", xlab="Image") + geom_point() + facet_grid( bairro~variable, shrink=TRUE, as.table=TRUE) + scale_y_discrete(breaks=seq(0,8))

#Used to test all differences between features values
calcMax <- function(values){
  normal <- values
  max <- 0 
  for ( i in seq(1, length(values)) ){
      for ( j in seq(i, length(values)) ){
         max = max + (values[i]-values[j])
      }
  }
  return(max)
}

```

#Pleasantness x Safety
```{r, echo=FALSE, fig.show='asis', fig.width=10, fig.height=5}
grupo1 <- dadosSub[(dadosSub$grupo == 'Geral' & dadosSub$V1=='agradavel?' ),] 
grupo2 <- dadosSub[(dadosSub$grupo == 'Geral' & dadosSub$V1=='seguro?'),] 
temp <- rbind(grupo1, grupo2)

novosgrupo1grupo2 <- reshape(temp, timevar="V1", idvar=c("V2", "grupo", "diag", "hor", "vert", "red", "green", "blue", "bairro"), direction="wide")
colnames(novosgrupo1grupo2)[colnames(novosgrupo1grupo2) == "V3.agradavel?"] <- "V3.agradavel"
colnames(novosgrupo1grupo2)[colnames(novosgrupo1grupo2) == "V3.seguro?"] <- "V3.seguro"

#Spatial Regression of all users opinion
res <- getLatLong(agrad, "moran100/streetsQScoresLatLongAgraAll2.dat")
crd <- cbind(res$long, res$lat)
k2 <- knn2nb(knearneigh(unique(crd)))
maxDist <- max(unlist(nbdists(k2, unique(crd))))
neigh <- dnearneigh(crd, 0, 1000*maxDist, longlat=TRUE)#Neighborhoods based on distance! Which values to use as limits? From example were 0, 100; 0, 1 * max or 1.5 * max
neigh2 <- nb2listw(neigh, style = "B")#Binary weights, control amount of neighbors giving more influence to the ones with more neighbors!

reg <- spautolm(V3.Geral ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, data=filter(res, V1 == "agradavel?"), listw=neigh2)
summary(reg)
reg <- lm(V3.Geral ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, na.action = na.exclude, data = filter(res, V1 == "agradavel?"))
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

source("krippMoran.R")
moranI2(res, "V3.Geral")

moran <- lm.morantest(reg, neigh2, alternative="two.sided")
summary(moran)
moran

#Pleasantness and colors 
reg <- lm(V3.Geral ~ red + green + blue, na.action = na.exclude, data = filter(res, V1 == "agradavel?"))
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

res <- getLatLong(seg, "moran100/streetsQScoresLatLongAgraAll2.dat")
crd <- cbind(res$long, res$lat)
k2 <- knn2nb(knearneigh(unique(crd)))
maxDist <- max(unlist(nbdists(k2, unique(crd))))
neigh <- dnearneigh(crd, 0, 1000*maxDist, longlat=TRUE)#Neighborhoods based on distance! Which values to use as limits? From example were 0, 100; 0, 1 * max or 1.5 * max
neigh2 <- nb2listw(neigh, style = "B")#Binary weights, control amount of neighbors giving more influence to the ones with more neighbors!
reg <- spautolm(V3.Geral ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, data=filter(res, V1 == "seguro?"), listw=neigh2)
summary(reg)
reg <- lm(V3.Geral ~ street_wid + sidewalk_wid + mov_cars + park_cars + mov_ciclyst + debris + pavement + landscape + build_ident + build_nrectan + prop_street_wall + prop_wind + long_sight + prop_sky_ahead + prop_sky_across + graffiti + trees + small_planters + build_height + build_diff_ages + diff_build + street_furnit + basic_col + lights + accent_col + people + prop_active_use, na.action = na.exclude, data = filter(res, V1 == "seguro?"))
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

moranI2(res, "V3.Geral")

moran <- lm.morantest(reg, neigh2, alternative="two.sided")
summary(moran)
moran

#Safety and colors 
reg <- lm(V3.Geral ~ red + green + blue, na.action = na.exclude, data = filter(res, V1 == "seguro?"))
summary(reg)
texreg(reg, stars = c(0.001, 0.01, 0.05, 0.1))

#Regression of one question x other question
library(texreg)

regAgrad <- lm(V3.agradavel ~ V3.seguro, data=novosgrupo1grupo2)

novosgrupo1grupo2$residuals <- regAgrad$residuals
novosgrupo1grupo2$residualsPos <- abs(regAgrad$residuals)

novosgrupo1grupo2 <- novosgrupo1grupo2[with(novosgrupo1grupo2, order(-residualsPos)), ]

plot(regAgrad$residuals, main = "Residual Plot Pleasantness", ylab = "Residuals")

#Modelo
#sink("reg-jov-adu-agrad.txt")
texreg(regAgrad)
summary(regAgrad)
#sink()

#Photos, QScores and residuals
write.table(novosgrupo1grupo2[, c("V2", "V3.agradavel", "V3.seguro", "residuals", "residualsPos")], file="agrad-seg.dat", sep = "\t")

#Scatterplot Pleas x Safe
geral <- select(filter(dadosCopy, grupo == "Geral"), grupo, V1, V2, V3, bairro) 

geral$bairro <- as.character(geral$bairro)
geral$bairro[geral$bairro == "catole"] <- "CatolÃ©"
geral$bairro[geral$bairro == "liberdade"] <- "Liberdade"
geral$bairro[geral$bairro == "centro"] <- "Centro"

novosDados <- reshape(geral, timevar="V1", idvar=c("V2", "grupo", "bairro"), direction="wide")
novosDados <- rename(novosDados, c("V3.agrad%C3%A1vel?"="Pleasant", "V3.seguro?"="Safe", "bairro" = "neighborhood"))

library(plyr)

w = 5
h = 4
pdf("images/pleasXsafeAll.pdf", width = w, height = h)
ggplot(novosDados, aes(y=Pleasant, x=Safe, colour=neighborhood))+geom_point(alpha = 0.7, size=1.7)+xlab("QScore Safety")+ylab("QScore Pleasantness")+geom_abline(intercept=0, colour="red")+theme(axis.text=element_text(size=40), axis.title=element_text(size=40), legend.text = element_text(size=40), legend.title = element_text(size=40))+theme_bw()+annotate("text", x = 4, y = 7, label = "Adj. R^2 = 0.27")
dev.off()

cor.test(novosDados$Safe, novosDados$Pleasant, method="kendall")
cor.test(novosDados$Safe, novosDados$Pleasant, method="pearson")
cor.test(novosDados$Safe, novosDados$Pleasant, method="kendall")
```

# IC por pontos
```{r, echo=FALSE, fig.show='asis', fig.width=10, fig.height=5}
#Per group - safety
todos <- dadosSub[(dadosSub$grupo == 'Jovem'  | dadosSub$grupo == 'Adulto') & dadosSub$V1=='seguro?',]

todos$NV2 <- rep(c(1:109), each=2)
ggplot(todos, aes(x=NV2, y=V3, colour=grupo)) + geom_point(shape=1, size=2) + geom_errorbar(aes(ymin=V3-distance, ymax=V3+distance)) + xlab("Local") + ylab("QScore") + ggtitle("City Places CI") + scale_x_discrete(breaks=seq(1, 108, by=5)) + facet_grid(bairro~.)

todos <- dadosSub[(dadosSub$grupo == 'Masculino'  | dadosSub$grupo == 'Feminino') & dadosSub$V1=='seguro?',]

todos$NV2 <- rep(c(1:109), each=2)
ggplot(todos, aes(x=NV2, y=V3, colour=grupo)) + geom_point(shape=1, size=2) + geom_errorbar(aes(ymin=V3-distance, ymax=V3+distance)) + xlab("Local") + ylab("QScore") + ggtitle("City Places CI") + scale_x_discrete(breaks=seq(1, 108, by=5)) + facet_grid(bairro~.)

todos <- dadosSub[(dadosSub$grupo == 'Baixa'  | dadosSub$grupo == 'Media') & dadosSub$V1=='seguro?',]

todos$NV2 <- rep(c(1:109), each=2)
ggplot(todos, aes(x=NV2, y=V3, colour=grupo)) + geom_point(shape=1, size=2) + geom_errorbar(aes(ymin=V3-distance, ymax=V3+distance)) + xlab("Local") + ylab("QScore") + ggtitle("City Places CI") + scale_x_discrete(breaks=seq(1, 108, by=5)) + facet_grid(bairro~.)

todos <- dadosSub[(dadosSub$grupo == 'Casado'  | dadosSub$grupo == 'Solteiro') & dadosSub$V1=='seguro?',]

todos$NV2 <- rep(c(1:109), each=2)
ggplot(todos, aes(x=NV2, y=V3, colour=grupo)) + geom_point(shape=1, size=2) + geom_errorbar(aes(ymin=V3-distance, ymax=V3+distance)) + xlab("Local") + ylab("QScore") + ggtitle("City Places CI") + scale_x_discrete(breaks=seq(1, 108, by=5)) + facet_grid(bairro~.)

#Per group - pleasantness
todos <- dadosSub[(dadosSub$grupo == 'Jovem'  | dadosSub$grupo == 'Adulto') & dadosSub$V1=='agradavel?',]

todos$NV2 <- rep(c(1:109), each=2)
ggplot(todos, aes(x=NV2, y=V3, colour=grupo)) + geom_point(shape=1, size=2) + geom_errorbar(aes(ymin=V3-distance, ymax=V3+distance)) + xlab("Local") + ylab("QScore") + ggtitle("City Places CI") + scale_x_discrete(breaks=seq(1, 108, by=5)) + facet_grid(bairro~.)

todos <- dadosSub[(dadosSub$grupo == 'Masculino'  | dadosSub$grupo == 'Feminino') & dadosSub$V1=='agradavel?',]

todos$NV2 <- rep(c(1:109), each=2)
ggplot(todos, aes(x=NV2, y=V3, colour=grupo)) + geom_point(shape=1, size=2) + geom_errorbar(aes(ymin=V3-distance, ymax=V3+distance)) + xlab("Local") + ylab("QScore") + ggtitle("City Places CI") + scale_x_discrete(breaks=seq(1, 108, by=5)) + facet_grid(bairro~.)

todos <- dadosSub[(dadosSub$grupo == 'Baixa'  | dadosSub$grupo == 'Media') & dadosSub$V1=='agradavel?',]

todos$NV2 <- rep(c(1:109), each=2)
ggplot(todos, aes(x=NV2, y=V3, colour=grupo)) + geom_point(shape=1, size=2) + geom_errorbar(aes(ymin=V3-distance, ymax=V3+distance)) + xlab("Local") + ylab("QScore") + ggtitle("City Places CI") + scale_x_discrete(breaks=seq(1, 108, by=5)) + facet_grid(bairro~.)

todos <- dadosSub[(dadosSub$grupo == 'Casado'  | dadosSub$grupo == 'Solteiro') & dadosSub$V1=='agradavel?',]

todos$NV2 <- rep(c(1:108), each=2)
ggplot(todos, aes(x=NV2, y=V3, colour=grupo)) + geom_point(shape=1, size=2) + geom_errorbar(aes(ymin=V3-distance, ymax=V3+distance)) + xlab("Local") + ylab("QScore") + ggtitle("City Places CI") + scale_x_discrete(breaks=seq(1, 108, by=5)) + facet_grid(bairro~.)
```

# Boxplots por grupos e bairros

```{r, echo=FALSE, fig.show='asis', fig.width=10, fig.height=5}
dadosSubA <- dadosSub[dadosSub$V1 == 'agradavel?' & dadosSub$grupo != 'CCentro' & dadosSub$grupo != 'NCCentro' & dadosSub$grupo != 'CLiberdade' & dadosSub$grupo != 'NCLiberdade' & dadosSub$grupo != 'CCatole' & dadosSub$grupo != 'NCCatole',]
dadosSubS <- dadosSub[dadosSub$V1 == 'seguro?' & dadosSub$grupo != 'CCentro' & dadosSub$grupo != 'NCCentro' & dadosSub$grupo != 'CLiberdade' & dadosSub$grupo != 'NCLiberdade' & dadosSub$grupo != 'CCatole' & dadosSub$grupo != 'NCCatole',]

ggplot(dadosSubA, aes(y=V3, x = bairro)) + 
  geom_boxplot() + 
  geom_point(position = position_jitter(width = 0.15), size = 2, alpha = 0.6) + 
  theme_bw()+ xlab("") + 
  ylab("QScore")+ylim(2, 8)+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=14))+ facet_wrap( ~ grupo, ncol=2)

ggplot(dadosSubS, aes(y=V3, x = bairro)) + 
  geom_boxplot() + 
  geom_point(position = position_jitter(width = 0.15), size = 4, alpha = 0.6) + 
  theme_bw()+ xlab("") + 
  ylab("QScore")+ylim(2, 8)+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=14))+ facet_wrap( ~ grupo, ncol=2)


#General boxplot
dadosSubA <- dadosSub[dadosSub$grupo == 'Geral',]
dadosSubA$V1 <- as.character(dadosSubA$V1)
dadosSubA$bairro <- as.character(dadosSubA$bairro)
dadosSubA$V1[dadosSubA$V1 == "agradavel?"] <- "Pleasantness"
dadosSubA$V1[dadosSubA$V1 == "seguro?"] <- "Safety"
dadosSubA$bairro[dadosSubA$bairro == "centro"] <- "Centro"
dadosSubA$bairro[dadosSubA$bairro == "liberdade"] <- "Liberdade"
dadosSubA$bairro[dadosSubA$bairro == "catole"] <- "CatolÃ©"

ggplot(dadosSubA, aes(y=V3, x = bairro)) + 
  geom_boxplot() + 
  geom_point(position = position_jitter(width = 0.15), size = 3, alpha = 0.6) + 
  theme_bw()+ xlab("") + 
  ylab("QScore")+ylim(2, 8)+
  theme(axis.text=element_text(size=16), axis.title=element_text(size=16), strip.text = element_text(size=16))+facet_grid(.~ V1)

#Knows x do not know
dadosSubA <- dadosSub[dadosSub$V1 == 'agradavel?' & (dadosSub$grupo == 'CCentro' & dadosSub$bairro == 'centro'  | dadosSub$grupo == 'CLiberdade' & dadosSub$bairro == 'liberdade' | dadosSub$grupo == 'CCatole' & dadosSub$bairro == 'catole'),]
dadosSubAN <- dadosSub[dadosSub$V1 == 'agradavel?' & (dadosSub$grupo == 'NCCentro' & dadosSub$bairro == 'centro' | dadosSub$grupo == 'NCLiberdade' & dadosSub$bairro == 'liberdade' | dadosSub$grupo == 'NCCatole' & dadosSub$bairro == 'catole'),]

dadosSubS <- dadosSub[dadosSub$V1 == 'seguro?'  & (dadosSub$grupo == 'CCentro' & dadosSub$bairro == 'centro'  | dadosSub$grupo == 'CLiberdade' & dadosSub$bairro == 'liberdade' | dadosSub$grupo == 'CCatole' & dadosSub$bairro == 'catole'),]
dadosSubSN <- dadosSub[dadosSub$V1 == 'seguro?'  & (dadosSub$grupo == 'NCCentro' & dadosSub$bairro == 'centro'  | dadosSub$grupo == 'NCLiberdade' & dadosSub$bairro == 'liberdade' | dadosSub$grupo == 'NCCatole' & dadosSub$bairro == 'catole'),]

know <- rbind(dadosSubA, dadosSubS) 
notKnow <- rbind(dadosSubAN, dadosSubSN) 

know$V1 <- as.character(know$V1)
notKnow$V1 <- as.character(notKnow$V1)

know$bairro <- as.character(know$bairro)
notKnow$bairro <- as.character(notKnow$bairro)

know$V1[know$V1 == "agradavel?"] <- "Pleasantness"
know$V1[know$V1 == "seguro?"] <- "Safety"
notKnow$V1[notKnow$V1 == "agradavel?"] <- "Pleasantness"
notKnow$V1[notKnow$V1 == "seguro?"] <- "Safety"

know$bairro[know$bairro == "centro"] <- "Centro"
know$bairro[know$bairro == "liberdade"] <- "Liberdade"
know$bairro[know$bairro == "catole"] <- "CatolÃ©"
notKnow$bairro[notKnow$bairro == "centro"] <- "Centro"
notKnow$bairro[notKnow$bairro == "liberdade"] <- "Liberdade"
notKnow$bairro[notKnow$bairro == "catole"] <- "CatolÃ©"

ggplot(know, aes(y=V3, x = bairro)) + 
  geom_boxplot() + 
  geom_point(position = position_jitter(width = 0.15), size = 3, alpha = 0.6) + 
  theme_bw()+ xlab("") + 
  ylab("QScore")+ylim(2, 8)+
  theme(axis.text=element_text(size=16), axis.title=element_text(size=16), strip.text = element_text(size=16))+facet_grid(.~ V1)

ggplot(notKnow, aes(y=V3, x = bairro)) + 
  geom_boxplot() + 
  geom_point(position = position_jitter(width = 0.15), size = 3, alpha = 0.6) + 
  theme_bw()+ xlab("") + 
  ylab("QScore")+ylim(2, 8)+
  theme(axis.text=element_text(size=16), axis.title=element_text(size=16), strip.text = element_text(size=16))+facet_grid(.~ V1)


#Filtering groups
dadosSubA <- dadosSub[dadosSub$V1 == 'agradavel?' & (dadosSub$grupo == 'Medio'  | dadosSub$grupo == 'Pos' | dadosSub$grupo == 'Feminino' | dadosSub$grupo == 'Masculino' | dadosSub$grupo == 'Media' | dadosSub$grupo == 'Baixa') & (dadosSub$bairro == 'centro' | dadosSub$bairro == 'liberdade'),]

dadosSubS <- dadosSub[dadosSub$V1 == 'seguro?'  & (dadosSub$grupo == 'Casado'  | dadosSub$grupo == 'Solteiro' | dadosSub$grupo == 'Medio' | dadosSub$grupo == 'Pos' | dadosSub$grupo == 'Media' | dadosSub$grupo == 'Baixa' | dadosSub$grupo == 'Jovem' | dadosSub$grupo == 'Adulto') & (dadosSub$bairro == 'centro' | dadosSub$bairro == 'catole'),]

dadosSubA$grupo <- as.character(dadosSubA$grupo)
dadosSubA$bairro <- as.character(dadosSubA$bairro)
dadosSubA$grupo[dadosSubA$grupo == "Media"] <- "MÃ©dia"
dadosSubA$grupo[dadosSubA$grupo == "Medio"] <- "MÃ©dio"
dadosSubA$grupo[dadosSubA$grupo == "Pos"] <- "PÃ³s"
dadosSubA$bairro[dadosSubA$bairro == "centro"] <- "Centro"
dadosSubA$bairro[dadosSubA$bairro == "liberdade"] <- "Liberdade"
dadosSubA$grupo <- factor(dadosSubA$grupo, levels = c('MÃ©dia', 'Baixa', 'Feminino', 'Masculino', 'MÃ©dio', 'PÃ³s')) 

ggplot(dadosSubA, aes(y=V3, x = bairro)) + 
  geom_boxplot() + 
  geom_point(position = position_jitter(width = 0.15), size = 3, alpha = 0.6) + 
  theme_bw()+ xlab("") + 
  ylab("QScore")+ylim(2, 8)+
  theme(axis.text=element_text(size=16), axis.title=element_text(size=16), strip.text = element_text(size=16))+ facet_wrap( ~ grupo, ncol=2)

dadosSubS$grupo <- as.character(dadosSubS$grupo)
dadosSubS$bairro <- as.character(dadosSubS$bairro)
dadosSubS$grupo[dadosSubS$grupo == "Media"] <- "MÃ©dia"
dadosSubS$grupo[dadosSubS$grupo == "Medio"] <- "MÃ©dio"
dadosSubS$grupo[dadosSubS$grupo == "Pos"] <- "PÃ³s"
dadosSubS$bairro[dadosSubS$bairro == "centro"] <- "Centro"
dadosSubS$bairro[dadosSubS$bairro == "catole"] <- "CatolÃ©"
dadosSubS$grupo <- factor(dadosSubS$grupo, levels = c('MÃ©dia', 'Baixa', 'Casado', 'Solteiro', 'MÃ©dio', 'PÃ³s', 'Jovem', 'Adulto')) 

ggplot(dadosSubS, aes(y=V3, x = bairro)) + 
  geom_boxplot() + 
  geom_point(position = position_jitter(width = 0.15), size = 3, alpha = 0.6) + 
  theme_bw()+ xlab("") + 
  ylab("QScore")+ylim(2, 8)+
  theme(axis.text=element_text(size=16), axis.title=element_text(size=16), strip.text = element_text(size=16))+ facet_wrap( ~ grupo, ncol=2)

```
