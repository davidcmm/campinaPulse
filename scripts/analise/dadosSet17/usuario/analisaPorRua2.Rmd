---
title: "analisaPorRua2"
output: html_document
---

```{r setup, include=FALSE}
library("vioplot")
library("ggplot2")
library("dplyr")
library("knitr")
library("texreg")
library("ineq")
library(R.utils)

multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}
```

Ações a fazer:

* Motivação: Birds-eye x visão de baixo no urbanismo
* Gerar aleatórios das comparações das cenas entre si e ver range de scores de todas as fotos em comparação com o range de todas as fotos que temos agora
* Moradores x não-moradores nas logísticas!
* O número da rua indica o que? Metros? http://campinagrandepb.com.br/wp-content/uploads/2014/10/codigo-de-obras-Lei-5410.131.pdf
* Índices de dispersão/quebra (entre números da rua, entre lados da rua, no mesmo lado, etc.)? Séries temporais?
- Representação em gráfico de duas linhas (dois lados) x mediana x média da rua -> áreas abaixo e acima + interseção de marcações
- O que um especialista diria de útil na análise
* Treinado x pessoas respondendo? Vantagens e desvantagens?

```{r results='asis', echo=FALSE, out.extra='', fig.height=10, fig.width=12, warning=FALSE}
#Checking sample size
current_data <- read.table("all100/all_ordenado.dat")
current_data$sd <- apply(current_data[,4:ncol(current_data)], 1, sd)
current_data$n <- ( 1.96 * current_data$sd / 0.2) ** 2  #All QScores
current_data$ci <- current_data$sd * 1.96 / sqrt(100)
novoV2 <- lapply(as.character(current_data$V2), function (x) strsplit(x, split="/", fixed=TRUE)[[1]][7])
novoV2 <- unlist(lapply(novoV2, '[[', 1))
novoV2 <- strsplit(novoV2, split="\\.jpg")
photo <- unlist(lapply(novoV2, '[[', 1))
current_data$photo_name <- photo
current_data <- arrange(current_data, photo_name)

qscoresDFGeral <- read.csv("qscores-df-geral.csv", header = TRUE)
qscoresDFCampina<- read.csv("qscores-df-campina.csv", header = TRUE)
qscoresDFNotCampina <- read.csv("qscores-df-notcampina.csv", header = TRUE)

#Plotting Q-Scores through the street
all_data <- merge(qscoresDFGeral, current_data, by.x = "url", by.y="V2")#qscoresDFGeral
all_data$street <- as.character(all_data$street)
all_data$street <- factor(all_data$street, levels=unique(all_data$street))

plot_ci_per_photo <- function(data, plotTitle, ids1, ids2){
  pd <- position_dodge(0.1)
  #data$xlabel <- factor(data$xlabel, levels = data$xlabel)
  data$side <- ""
  data$side[data$angle %in% ids1] <- "Side 1"
  data$side[data$angle %in% ids2] <- "Side 2"

  if(plotTitle == "Cristina Procopio"){
    data$side[data$num == 436 & (data$angle == 22 | data$angle == 135)] <- "Side 1"
    data$side[data$num == 436 & (data$angle == 203 | data$angle == 315)] <- "Side 2"
  }
  
  if(plotTitle == "Edésio Silva" || plotTitle == "Manoel Pereira"){
    data1 <- arrange(filter(data, side == "Side 1"), num, -angle)
    data2 <- arrange(filter(data, side == "Side 2"), num, angle)
  }else if (plotTitle == "Inacio"  || plotTitle == "Maciel Pinheiro" || plotTitle == "Cristina Procopio" || plotTitle == "Floriano Peixoto"){
    data1 <- arrange(filter(data, side == "Side 1"), num, angle)
    data2 <- arrange(filter(data, side == "Side 2"), num, angle)
    
    if (plotTitle == "Cristina Procopio"){
        to_change <- data1[nrow(data1)-1,]
        data1[nrow(data1)-1,] <- data1[nrow(data1),]
        data1[nrow(data1),] <- to_change
    }
  }
  
  #Labeling first and second points of each street number in each side
  data1$xlabel <- paste(data1$num, "-", "p1") 
  data2$xlabel <- paste(data2$num, "-", "p1")
  cur_num <- 0
  occurred <- FALSE
  for (i in 1:nrow(data1)) { 
    if(occurred == FALSE && cur_num == 0){
        cur_num <- data1[i,]$num
        occurred <- TRUE
    }else if(occurred == TRUE){
        data1[i,]$xlabel <- paste(data1[i,]$num, "-", "p2")
        cur_num <- 0
        occurred <- FALSE
    }
  } 
  cur_num <- 0
  occurred <- FALSE
  for (i in 1:nrow(data2)) {
    if(occurred == FALSE && cur_num == 0){
        cur_num <- data2[i,]$num
        occurred <- TRUE
    }else if(occurred == TRUE){
        data2[i,]$xlabel <- paste(data2[i,]$num, "-", "p2")
        cur_num <- 0
        occurred <- FALSE
    }
  }
  
  data1 <- data1 %>% mutate(xlabel = factor(xlabel, levels = xlabel))
  data2 <- data2 %>% mutate(xlabel = factor(xlabel, levels = xlabel))
  
  data <- rbind(data1, data2)
  data$side <- factor(data$side)
  
  g1 <- ggplot(data, aes(x=reorder(xlabel, num), y=V3, group=side, fill=side)) + geom_errorbar(aes(ymin=V3-ci, ymax=V3+ci), colour="black", width=.1, position=pd) + theme_bw() + geom_line() + geom_area(alpha=0.5)  + theme(axis.text.x = element_text(angle = 90, hjust = 1), plot.title = element_text(vjust=10)) + labs(x = "Street points", title = plotTitle, y = "Q-Score") + ylim(c(0,6)) #ggplot(data1, aes(x=reorder(xlabel, num), y=V3, group=side, shape = factor(num)))+ geom_bar(position=position_dodge(), stat="identity", fill="#D55E00", alpha=0.5) + geom_errorbar(aes(ymin=V3-ci, ymax=V3+ci), colour="black", width=.1, position=pd) + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1), plot.title = element_text(vjust=10)) + labs(x = "Street points", title = plotTitle, y = "Q-Score") 
  g1
}

plot_ci_per_photo(filter(all_data, street == "R._Maciel_Pinheiro"), "Maciel Pinheiro", c(360, 90), c(270, 180))#Street 3
plot_ci_per_photo(filter(all_data, street == "R._Manoel_Pereira_de_Araújo"), "Manoel Pereira", c(22, 135, 293), c(315, 112, 203, 225))#Street 4
plot_ci_per_photo(filter(all_data, street == "Av._Mal._Floriano_Peixoto"), "Floriano Peixoto", c(22,293), c(112,203))#Street 5
plot_ci_per_photo(filter(all_data, street == "R._Edésio_Silva"), "Edésio Silva", c(22, 135), c(315, 203))#Street 1
plot_ci_per_photo(filter(all_data, street == "R._Inácio_Marquês_da_Silva"), "Inacio", c(203, 112, 90), c(293, 270, 22))#Street 2
plot_ci_per_photo(filter(all_data, street == "R._Cristina_Procópio_Silva"), "Cristina Procopio", c(22, 45, 293, 315), c(135, 225))#Street 6 -> At number 436, 22 x 315 and 135 x 203

# Use semi-transparent fill
p <-ggplot(filter(all_data, street == "R._Cristina_Procópio_Silva"),  aes(x=num, fill=qscore)) +
  geom_area(stat ="bin", alpha=0.6) +
  theme_classic()
p
# Add mean lines
p+geom_vline(data=mu, aes(xintercept=grp.mean, color=sex),
             linetype="dashed")
```


