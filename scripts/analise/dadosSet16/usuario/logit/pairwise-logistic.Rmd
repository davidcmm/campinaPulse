---
title: "Pairwise comparison - logit"
#date: `r date()`
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
require(gmodels)
require(vcd)
require(lme4)
library(caret)
library(pscl)
library(DT)
library(ggplot2)
theme_set(theme_bw())
library(GGally)
library(dplyr, warn.conflicts = F)
library(broom)

library(car)
library(readr)
```

```{r lib}
compare_glms <- function(baseline, model){
  modelChi <- baseline$deviance - model$deviance
  chidf <- baseline$df.residual - model$df.residual
  chisq.prob <- 1 - pchisq(modelChi, chidf)
  print(paste(modelChi, chidf, chisq.prob))
}

compare_null <- function(baselineModel){
  modelChi <- baselineModel$null.deviance - baselineModel$deviance
  chidf <- baselineModel$df.null - baselineModel$df.residual
  chisq.prob <- 1 - pchisq(modelChi, chidf)
  print(paste(modelChi, chidf, chisq.prob))
}
```


```{r read}
# TIVE QUE ADICIONAR O NOME DA 1a COLUNA NO ARQUIVO
raw_data = read_delim(
  "classifier//classifier_input_wodraw.dat",
  delim = "\t",
  col_types = cols(
    .default = col_double(),
    row = col_integer(),
    choice = col_character(),
    question = col_character(),
    photo1 = col_character(),
    photo2 = col_character(),
    choice = col_integer(),
    userID = col_integer(),
    gender = col_character(),
    age = col_character(),
    income = col_character(),
    education = col_character(),
    city = col_character(),
    marital = col_character(),
    graffiti1 = col_character(),
    bairro1 = col_character(),
    graffiti2 = col_character(),
    bairro2 = col_character()
    )
  )

```

```{r transform}
data = raw_data %>% 
  mutate( # Recode
    income = if_else(is.na(income), "media", income),
    age_cat = if_else(as.integer(age) >= 25 | is.na(age), "adulto", "jovem"),
    inc_cat = if_else(income %in% c("baixa", "media baixa"),
                         "baixa", 
                         "media"), # substituirÃ¡ os NA
    choice = if_else(choice == "1", "0", 
                     if_else(choice == "-1", "1", choice)), 
    bair_cat = if_else(bairro1 == bairro2, "mesmo", 
                       paste0(bairro1, "_", bairro2))    
    ) %>% 
  mutate_at( # to factor
    vars(income, age_cat, inc_cat, choice, bair_cat, marital, gender),
    as.factor) %>% 
  mutate( # relevel
    bair_cat = relevel(bair_cat,  "mesmo"),
    marital = relevel(marital,  "solteiro"),
    income = relevel(income,  "baixa"),
    age_cat = relevel(age_cat,  "jovem"),
    gender = relevel(gender,  "feminino"),
    inc_cat = relevel(inc_cat,  "baixa")
  ) 

# Create diff features
data = data %>%
  mutate(
    d_swidth = street_wid1 - street_wid2,
    d_mvcars = mov_cars1 - mov_cars2,
    d_pcars = park_cars1 - park_cars2,
    d_trees = trees1 - trees2,
    d_mvciclyst = mov_ciclyst1 - mov_ciclyst2,
    d_lands = landscape1 - landscape2,
    d_bid = build_ident1 - build_ident2,
    d_bheig = log2(build_height1 + 1) - log2(build_height2 + 1),
    d_dbuild = diff_build1 - diff_build2,
    d_people = people1 - people2,
    d_graff = (graffiti1 == "Yes") - (graffiti2 == "Yes")
  )

# SPLIT + SCALE
agrad <- filter(data, !(question %in% c("seguro?", "seguro"))) %>% 
  mutate_at(vars(40:50), scale)
seg <- filter(data, (question %in% c("seguro?", "seguro")))  %>% 
  mutate_at(vars(40:50), scale)
```

```{r visualize}
 # featurePlot(x=data[, 40:45], y=data[,5], plot="box", scales=list(x=list(relation="free"), y=list(relation="free")), auto.key=list(columns=2))
```

```{r model.lib}
create_model_w_interact = function(the_data){
  return(glm(
    choice ~ d_swidth + d_mvcars + d_pcars + d_trees + d_mvciclyst + d_lands + d_bid + d_bheig + d_dbuild + d_people + d_graff + bair_cat + 
      age_cat:(d_swidth + d_mvcars + d_pcars + d_trees + d_mvciclyst + d_lands + d_bid + d_bheig + d_dbuild + d_people + d_graff) + 
      gender:(d_swidth + d_mvcars + d_pcars + d_trees + d_mvciclyst + d_lands + d_bid + d_bheig + d_dbuild + d_people + d_graff) + 
      inc_cat:(d_swidth + d_mvcars + d_pcars + d_trees + d_mvciclyst + d_lands + d_bid + d_bheig + d_dbuild + d_people + d_graff),
    data = the_data,
    family = binomial()))
}

create_model_wo_profile = function(the_data){
  return(glm(
    choice ~ d_swidth + d_mvcars + d_pcars + d_trees + d_mvciclyst + d_lands + d_bid + d_bheig + d_dbuild + d_people + d_graff + bair_cat,
    data = the_data,
    family = binomial()))
}
```

```{r model.agrad}
mostpleasant_model <- create_model_w_interact(agrad)
summary(mostpleasant_model)
vif(mostpleasant_model)
#anova(mostpleasant_model, test="Chisq")

mostpleasant_model_wo_profile <- create_model_wo_profile(agrad)
summary(mostpleasant_model_wo_profile)
vif(mostpleasant_model_wo_profile)

coefs_ag = tidy(mostpleasant_model, conf.int = TRUE, exponentiate = TRUE) 
coefs_ag %>% 
  mutate_at(vars(-1), prettyNum, digits = 3) %>%
  datatable()
library(xtable)
xtable(coefs_ag)
{ # fix for what seems like a bug in pR2
  the_data = agrad
  pR2(mostpleasant_model)
}
```

```{r model.safe}
safer_model <- create_model_w_interact(seg)
summary(safer_model)
#anova(safer_model, test="Chisq")
vif(safer_model)

safer_model_wo_profile <- create_model_wo_profile(seg)
summary(safer_model_wo_profile)
vif(safer_model_wo_profile)

coefs_seg = tidy(safer_model, conf.int = TRUE, exponentiate = TRUE) 
coefs_seg %>% 
  mutate_at(vars(-1), prettyNum, digits = 3) %>% 
  datatable()

{ # fix for what seems like a bug in pR2
  the_data = seg
  pR2(safer_model)
}
```

```{r visualize_models}
library(modelr) # devtools::install_github("hadley/modelr")

m = agrad %>%
  data_grid(agrad, 
            .model = mostpleasant_model)

mm = augment(mostpleasant_model,
             newdata = m,
             type.predict = "response")

ggplot(mm, aes(x = d_lands)) + 
  geom_hex(aes(y = .fitted)) +  
  geom_count(aes(y = as.numeric(as.character(choice))), alpha = .1) + 
  facet_grid(gender ~ inc_cat + age_cat) 

```

```{r visualize_models}
#Analysing Leave user out results
source("analisaICPorFoto.R")

computeICForArrayOfValues <- function(files) {
  for (file in files){
    data <- read.table(file, header=TRUE)
    distance <- ic(filter(data, x != "NA")$x)
    meanValue <- mean(data$x, na.rm = TRUE)
    print(paste(file, meanValue, (meanValue - distance), (meanValue + distance), sep = "\t"))
  }
}

files <- c('logit/accuraciesA.dat', 'logit/accuraciesS.dat', 'logit/accuraciesA_WOProfile.dat', 'logit/accuraciesS_WOProfile.dat')
files <- c('logit/accuraciesA0.5.dat', 'logit/accuraciesA0.6.dat', 'logit/accuraciesA0.7.dat')
computeICForArrayOfValues(files)

files <- c('logit/precisionA0.5.dat', 'logit/precisionA0.6.dat', 'logit/precisionA0.7.dat')
computeICForArrayOfValues(files)

files <- c('logit/recallA0.5.dat', 'logit/recallA0.6.dat', 'logit/recallA0.7.dat')
computeICForArrayOfValues(files)

files <- c('logit/precisionA.dat', 'logit/precisionS.dat', 'logit/precisionA_WOProfile.dat', 'logit/precisionS_WOProfile.dat')
computeICForArrayOfValues(files)

files <- c('logit/recallA.dat', 'logit/recallS.dat', 'logit/recallA_WOProfile.dat', 'logit/recallS_WOProfile.dat')
computeICForArrayOfValues(files)

filesCoef <- c('coefficientsA.dat', 'coefficientsS.dat')
filesPval <- c('pvaluesA.dat', 'pvaluesS.dat')
for (index in 1:2){
  coefData <- read.table(filesCoef[index], skip=1)
  pvalData <- read.table(filesPval[index], skip=1)
  
  #Values in exp()
  distancesCoef <- apply(coefData[, c(2:ncol(coefData))], 1, ic)
  meanCoef <- apply(coefData[, c(2:ncol(coefData))], 1, mean)
  coefData$mean <- meanCoef
  coefData$low <- meanCoef - distancesCoef
  coefData$high <- meanCoef + distancesCoef

  distancesPval <- apply(pvalData[, c(2:ncol(pvalData))], 1, ic)
  meanPval <- apply(pvalData[, c(2:ncol(pvalData))], 1, mean)
  pvalData$mean <- meanPval
  pvalData$low <- meanPval - distancesPval
  pvalData$high <- meanPval + distancesPval
  
  print(paste(filesCoef[index], coefData$V1, coefData$mean, coefData$low, coefData$high, pvalData$mean, pvalData$low, pvalData$high, sep = "\t"), quote=FALSE)
}

#Extra Trees analysis
calcICFromMeanAndSD <- function(notprof_mean, notprof_sd, prof_mean, prof_sd){
    distance <- (notprof_sd/sqrt(282)*qnorm(1-(0.05/2)))
    print(paste("not profile", notprof_mean, notprof_mean - distance, notprof_mean + distance))
    distance <- (agrad_prof_sd/sqrt(282)*qnorm(1-(0.05/2)))
    print(paste("profile", prof_mean, prof_mean - distance, prof_mean + distance))
}

agrad_notprof_mean <- 0.637906
agrad_notprof_sd <- 0.20848411
agrad_prof_mean <- 0.68243055 
agrad_prof_sd <- 0.20558187
calcICFromMeanAndSD(agrad_notprof_mean,agrad_notprof_sd, agrad_prof_mean, agrad_prof_sd)

seg_notprof_mean <- 0.56428643
seg_notprof_sd <- 0.21240605
seg_prof_mean <- 0.65061814 
seg_prof_sd <- 0.22117244
calcICFromMeanAndSD(seg_notprof_mean, seg_notprof_sd, seg_prof_mean, seg_prof_sd)

```


```{r visualize_models}
#Sankey network graph!
#Online tool: http://sankey.csaladen.es/
library(networkD3)

#Exemplo Internet!
URL <- paste0(
        "https://cdn.rawgit.com/christophergandrud/networkD3/",
        "master/JSONdata/energy.json")
Energy <- jsonlite::fromJSON(URL)
# Plot
sankeyNetwork(Links = Energy$links, Nodes = Energy$nodes, Source = "source",
             Target = "target", Value = "value", NodeID = "name",
             units = "TWh", fontSize = 12, nodeWidth = 30)

#Pleasantness!
urbanQualities = data.frame(name=c("Street width", "Trees", "People", "Moving cars", "Cyclist", "Human Scale - 52%", "Parked cars", "Trees", "Cyclists", "People", "Moving cars", "Complexity - 45.4%", "Maintenance", "Tidiness - 37.3%", "Street width", "Trees", "Enclosure - 27.8%", "Buildings Identifiers", "People", "Imageability - 15.6%", "Street width", "Linkage - 12%", "People", "Coherence - 10.5%", "Buildings with identifiers", "Legibility - 5.1%", "Pleasantness"))
 mylist<-list(dimension=urbanQualities, links=data.frame(source=c(0, 1, 2, 3, 4, 6, 7, 8, 9, 10, 12, 14, 15, 17, 18, 20, 22, 24, 5, 11, 13, 16, 19, 21, 23, 25), target=c(5, 5, 5, 5, 5, 11, 11, 11, 11, 11, 13, 16, 16, 19, 19, 21, 23, 25, 26, 26, 26, 26, 26, 26, 26, 26), value=c(6.13+5.91, 7+8.7, 10.5, 9.47, 4.61, 5.1, 7+8.77, 4.6, 10.5, 9.4, 27+5.5+4.7, 6.1+5.9, 7+8.77, 5.1, 10.5, 6.1+5.9, 10.5, 5.1, 52, 45.4, 37.3, 27.8, 15.6, 12, 10.5, 5.1)) )

sankeyNetwork(Links = mylist$links, Nodes = mylist$dimension, Source = "source",
             Target = "target", Value = "value", NodeID = "name",
             units = "%", fontSize = 12, nodeWidth = 20)

#Safety!
urbanQualities = data.frame(name=c("Moving cars", "Parked cars", "Trees", "People", "Buildings", "Complexity - 69.3%", "Moving cars", "Trees", "People", "Street width", "Human Scale - 56.5%", "Moving cars", "Street width", "Linkage - 33.5%", "Maintenance", "Tidiness - 23.7%", "Trees", "Street width", "Enclosure - 16%", "People", "Imageability - 13.88%", "People", "Coherence - 13.88%", "Safety"))
 mylist<-list(dimension=urbanQualities, links=data.frame(source=c(0, 1, 2, 3, 4, 6, 7, 8, 9, 11, 12, 14, 16, 17, 19, 21, 5, 10, 13, 15, 18, 20, 22), target=c(5, 5, 5, 5, 5, 10, 10, 10, 10, 13, 13, 15, 18, 18, 20, 22, 23, 23, 23, 23, 23, 23, 23), value=c(15.5+4.7, 6.9, 5.4+3.6, 7.2+6.6, 7.33+5.3, 15.55+4.7+6.3, 5.4+3.6, 7.2+6.6, 6.9, 15.55+4.7+6.3, 6.9, 14.6+4.7+4.2, 5.4+3.6, 6.9, 7.2+6.6, 7.2+6.6, 69.3, 56.5, 33.5, 23.7, 16, 13.88, 13.88)) )

sankeyNetwork(Links = mylist$links, Nodes = mylist$dimension, Source = "source",
             Target = "target", Value = "value", NodeID = "name",
             units = "%", fontSize = 12, nodeWidth = 20)
#http://sankey.csaladen.es/


#Flow examples - All Urban Qualities
plot.new()
par(mar=c(0,0,0,0)+.1)
plot.window(xlim=c(0,3), ylim=c(0,9))
xspline( c(1,1.25,1.75,2), c(9,9,4,4), s=1, lwd=32.8/4.5, border="#0000ff88", lend=1)
xspline( c(1,1.25,1.75,2), c(8,8,4,4), s=1, lwd=32.8/4.5, border="#0000ff88", lend=1)
xspline( c(1,1.25,1.75,2), c(7,7,4,4), s=1, lwd=32.8/4.5, border="#0000ff88", lend=1)
xspline( c(1,1.25,1.75,2), c(6,6,4,4), s=1, lwd=19.7/4.5, border="#0000ff88", lend=1 )
xspline( c(1,1.25,1.75,2), c(5,5,4,4), s=1, lwd=16.5/4.5, border="#0000ff88", lend=1 )
xspline( c(1,1.25,1.75,2), c(4,4,4,4), s=1, lwd=13.8/4.5, border="#0000ff88", lend=1 )
xspline( c(1,1.25,1.75,2), c(3,3,4,4), s=1, lwd= 7.9/4.5, border="#0000ff88", lend=1 )
xspline( c(1,1.25,1.75,2), c(2,2,4,4), s=1, lwd= 4.8/4.5, border="#0000ff88", lend=1 )
xspline( c(1,1.25,1.75,2), c(1,1,4,4), s=1, lwd= 4.5/4.5, border="#0000ff88", lend=1 )

#text( rep(0.75, 7), 7:1, LETTERS[1:7] )
text( rep(0.6, 9), 9:1, c("IMAGEABILITY", "ENCLOSURE", "HUMAN SCALE", "TRANSPARENCY", "TIDINESS", "COMPLEXITY", "COHERENCE", "LEGIBILITY", "LINKAGE") )
text( 0.6, 7.6, c("Trees"),  cex=0.9)#Enclosure
text( c(0.3, 0.8), 6.6, c("Trees", "Moving cars"),  cex=0.9)#Human Scale
text( 0.6, 4.6, c("Landscape"),  cex=0.9)#Tidiness
text( c(0.3, 0.3, 0.8, 0.8), c(3.75, 3.3, 3.75, 3.3), c("Trees", "Moving cars", "Parked cars", "Buildings"),  cex=0.9)#Complexity
text( 0.6, 0.6, c("Moving cars"),  cex=0.9)#Linkage
text( 2.25, 4, 'Pleasantness')

#Flow examples - Pleasantness!
w = 12
h = 7
pdf("images/flow_agrad.pdf", width = w, height = h)

plot.new()
par(mar=c(0,0,0,0)+.1)
plot.window(xlim=c(0,3), ylim=c(0,8))
xspline( c(1,1.25,1.75,2), c(8,8,4,4), s=1, lwd=32.8/4.5, border="#0000ff88", lend=1)
xspline( c(1,1.25,1.75,2), c(7,7,4,4), s=1, lwd=32.8/4.5, border="#0000ff88", lend=1)
xspline( c(1,1.25,1.75,2), c(6,6,4,4), s=1, lwd=19.7/4.5, border="#0000ff88", lend=1 )
xspline( c(1,1.25,1.75,2), c(5,5,4,4), s=1, lwd=16.5/4.5, border="#0000ff88", lend=1 )
xspline( c(1,1.25,1.75,2), c(4,4,4,4), s=1, lwd=13.8/4.5, border="#0000ff88", lend=1 )
xspline( c(1,1.25,1.75,2), c(3,3,4,4), s=1, lwd= 7.9/4.5, border="#0000ff88", lend=1 )
xspline( c(1,1.25,1.75,2), c(2,2,4,4), s=1, lwd= 4.8/4.5, border="#0000ff88", lend=1 )
xspline( c(1,1.25,1.75,2), c(1,1,4,4), s=1, lwd= 4.5/4.5, border="#0000ff88", lend=1 )

#text( rep(0.75, 7), 7:1, LETTERS[1:7] )
text( rep(0.7, 8), 8:1, c("HUMAN SCALE 21%", "COMPLEXITY 18%", "TIDINESS 15%", "ENCLOSURE 11%", "IMAGEABILITY 6%",  "LINKAGE 4.8%", "COHERENCE 4.2%",  "LEGIBILITY 2%") , cex=1.4)
text( c(0.4, 0.4, 0.9, 0.9), c(7.7, 7.3, 7.7, 7.3), c("Street width(-)", "Trees(+)", "People(+)", "Moving cars(+)"),  cex=1.4)#Human Scale
text( c(0.2, 0.55, 0.2, 0.9, 0.9), c(6.7, 6.6, 6.3, 6.7, 6.3), c("Trees(+)", "People(+)", "Parked cars(+)", "Ciclysts(+)", "Moving cars(+)"),  cex=1.4)#Complexity
text( 0.7, 5.6, c("Landscape(+)"),  cex=1.4)#Tidiness
text( c(0.4, 0.9), 4.6, c("Trees(+)", "Street width(-)"),  cex=1.4)#Enclosure
text( c(0.4, 0.9), 3.6, c("Buildings ident(+)", "People(+)"),  cex=1.4)#Imageability
text( c(0.4, 0.9), 2.6, c("Street width(?)", "Moving cars(?)"),  cex=1.4)#Linkage
text( 0.7, 1.6, c("People(+)"),  cex=1.4)#Coherence
text( 0.7, 0.6, c("Buildings ident(+)"),  cex=1.4)#Legibility

text( 2.25, 4, 'Pleasantness', cex=1.4)

dev.off()

#Flow examples - Safety!
w = 12
h = 7
pdf("images/flow_seg.pdf", width = w, height = h)

plot.new()
par(mar=c(0,0,0,0)+.1)
plot.window(xlim=c(0,3), ylim=c(0,8))
xspline( c(1,1.25,1.75,2), c(7,7,4,4), s=1, lwd=32.8/4.5, border="#0000ff88", lend=1)
xspline( c(1,1.25,1.75,2), c(6,6,4,4), s=1, lwd=19.7/4.5, border="#0000ff88", lend=1 )
xspline( c(1,1.25,1.75,2), c(5,5,4,4), s=1, lwd=16.5/4.5, border="#0000ff88", lend=1 )
xspline( c(1,1.25,1.75,2), c(4,4,4,4), s=1, lwd=13.8/4.5, border="#0000ff88", lend=1 )
xspline( c(1,1.25,1.75,2), c(3,3,4,4), s=1, lwd= 7.9/4.5, border="#0000ff88", lend=1 )
xspline( c(1,1.25,1.75,2), c(2,2,4,4), s=1, lwd= 4.8/4.5, border="#0000ff88", lend=1 )
xspline( c(1,1.25,1.75,2), c(1,1,4,4), s=1, lwd= 4.5/4.5, border="#0000ff88", lend=1 )

#text( rep(0.75, 7), 7:1, LETTERS[1:7] )
text( rep(0.7, 7), 7:1, c("COMPLEXITY 36.9%", "HUMAN SCALE 30%", "LINKAGE 17.9%", "TIDINESS 12.6%", "ENCLOSURE 8.5%", "IMAGEABILITY 7.4%",  "COHERENCE 7.4%" ) , cex=1.4)
text( c(0.2, 0.6, 0.4, 0.9, 0.9), c(6.7, 6.6, 6.3, 6.7, 6.3), c("Moving cars(+)", "Trees(+)", "Parked cars(+)", "People(+)", "Buildings(+)"),  cex=1.4)#Complexity
text( c(0.4, 0.4, 0.9, 0.9), c(5.7, 5.3, 5.7, 5.3), c("Moving cars(+)", "Trees(+)", "People(+)", "Street width(-)"),  cex=1.4)#Human Scale
text( c(0.4, 0.9), 4.6, c("Moving cars(?)", "Street width(?)"),  cex=1.4)#Linkage
text( 0.7, 3.6, c("Landscape(+)"),  cex=1.4)#Tidiness
text( c(0.4, 0.9), 2.6, c("Trees(+)", "Street width(-)"),  cex=1.4)#Enclosure
text( 0.7, 1.6, c("People(+)"),  cex=1.4)#Imageability
text( 0.7, 0.6, c("People(+)"),  cex=1.4)#Coherence

text( 2.25, 4, 'Safety', cex=1.4)
dev.off()
```